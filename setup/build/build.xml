<project name="setup" default="all">

    <property environment="env"/>
    <property name="env.PONEY_HOME" value="//install/masa/common/dev/common/poney"/>
    <import file="${env.PONEY_HOME}/poney.xml"/>
    <var name="repositories" value="${repositories},${sword.repository}"/>
    <property name="branch" value="trunk"/>

    <propertyregex property="sub_platform" input="${platform}" regexp="(\w+)_x64" select="\1"/>

    <target name="binaries">
        <sequential>
            <local name="output"/>
            <property name="output" value="${out.dir}/sword_cloud_${platform}_bin.zip"/>
            <zip destfile="${output}">
                <mappedresources>
                    <fileset dir="../../host_agent/out/${platform}/RelWithDebInfo"
                        includes="**/cloud_*.pdb **/cloud_*.exe"/>
                    <flattenmapper/>
                </mappedresources>
                <mappedresources>
                    <fileset dir="../../node/out/${platform}"
                        includes="node.exe"/>
                </mappedresources>
                <mappedresources>
                    <fileset dir="../../node" includes="www/"/>
                </mappedresources>
                <mappedresources>
                    <fileset dir="../../proxy/out/${platform}"
                        includes="proxy.exe"/>
                    <flattenmapper/>
                </mappedresources>
            </zip>
            <safe-move file="${output}"/>
        </sequential>
    </target>

    <macrodef name="update_deps">
        <attribute name="platform"/>
        <sequential>
            <update name="vcredist"
                    package="vcredist_@{platform}"
                    todir="${root.dir}/out/@{platform}"/>
            <update name="cloud"
                    package="sword_cloud_@{platform}_bin"
                    todir="${root.dir}/out/@{platform}/cloud"/>
            <update name="sword"
                    version="Defense/releases/internal/${branch}"
                    package="SWORD_binaries_@{platform}_${branch}"
                    todir="${root.dir}/out/@{platform}/sword"/>
            <update name="sword"
                    version="Defense/releases/internal/${branch}"
                    package="SWORD_gaming_@{platform}_${branch}"
                    todir="${root.dir}/out/@{platform}/gaming"/>
        </sequential>
    </macrodef>

    <target name="configure">
        <update_deps platform="${platform}"/>
        <if>
            <isset property="sub_platform"/>
            <then>
                <update_deps platform="${sub_platform}"/>
            </then>
        </if>
    </target>

    <target name="package">
        <sequential>
            <if>
                <isset property="sub_platform"/>
                <then>
                    <nsis dir="${src.dir}"
                          name="cloud_client"
                          todir="${root.dir}/out/${sub_platform}">
                        <arg value="/DPLATFORM=${sub_platform}"/>
                    </nsis>
                    <nsis dir="${src.dir}"
                          name="cloud_server"
                          todir="${out.dir}">
                        <arg value="/DSUB_PLATFORM=${sub_platform}"/>
                    </nsis>
                    <safe-move file="${out.dir}/sword_cloud_${platform}_setup.exe"/>
                </then>
                <else>
                    <nsis dir="${src.dir}"
                          name="cloud_client"
                          todir="${out.dir}"/>
                    <nsis dir="${src.dir}"
                          name="cloud_server"
                          todir="${out.dir}"/>
                    <safe-move file="${out.dir}/sword_client_${platform}_setup.exe"/>
                    <safe-move file="${out.dir}/sword_cloud_${platform}_setup.exe"/>
                </else>
            </if>
        </sequential>
    </target>

    <target name="setup" depends="configure,package"/>

</project>
