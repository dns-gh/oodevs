<?xml version="1.0"?>
<project name="missionTests" default="all">

    <tstamp>
        <format property="timenow" pattern="yyyy-MM-dd_hh'h'mm" />  
    </tstamp>
    <property name="output" value="out"/>
    <property name="input" value="src"/>
    <property name="testName" value="testings"/>
    <property name="data" value="../../data/models/ada/physical/france"/>
    <property name="reportFile" value="reports/${timenow}_report.log"/>
    <property name="exercises" value="../../exercises"/>
    <property name="simulation_app" value="../../../out/applications/simulation_app/vc80/Release/simulation_app.exe"/>
    <property name="run_dir" value="../../../run/vc80"/>
    
    <target name="clean">
        <delete dir="${output}"/>
    </target>

    <target name="generate" depends="clean">
        <mkdir dir="${output}"/>
        <mkdir dir="${output}/${testName}"/>
        <mkdir dir="${output}/${testName}/sessions"/>
        <copy todir="${output}/${testName}/sessions">
            <fileset dir="${input}/${testName}/sessions"/>
        </copy>
        <mkdir dir="${output}/${testName}/scripts"/>
        <mkdir dir="${output}/${testName}/scripts/resources"/>
        <copy file="${input}/${testName}/exercise.xml" tofile="${output}/${testName}/exercise.xml"/>
        <copy file="${input}/${testName}/profiles.xml" tofile="${output}/${testName}/profiles.xml"/>
        <copy file="${input}/${testName}/scores.xml"   tofile="${output}/${testName}/scores.xml"/>
        <copy file="${input}/${testName}/weather.xml"  tofile="${output}/${testName}/weather.xml"/>
        <!-- to be generated -->
        <copy file="${input}/${testName}/orbat.xml"  tofile="${output}/${testName}/orbat.xml"/>
        <copy file="${input}/${testName}/scripts/resources/config.lua" tofile="${output}/${testName}/scripts/resources/config.lua"/>
        <!--xslt in="${data}/pions.xml" style="xsl/transformation.xsl" out="${reportFile}"-->
        <xslt in="src/pions.xml" style="xsl/transformation.xsl" out="${reportFile}">
            <param name="output" expression="${output}/${testName}/scripts"/>
            <param name="missionsPath" expression="${data}/Missions.xml"/>
            <param name="modelesPath"  expression="${data}/Modeles.xml"/>
            <param name="reportFile"  expression="${reportFile}"/>
        </xslt>
        <xslt in="${data}/pions.xml" style="xsl/model.xsl" out="${output}/${testName}/scripts/resources/model.lua"/>
    </target>

    <target name="remove-missing-parameters">
        <exec executable="bash.exe">
            <arg value="MissingParameter.sh"/>
            <arg value="${output}/${testName}/scripts"/>
        </exec>
    </target>

    <target name="deploy" depends="generate, remove-missing-parameters">
        <delete dir="${exercises}/${testName}"/>
        <copy todir="${exercises}/${testName}">
            <fileset dir="${output}/${testName}"/>
        </copy>
    </target>

    <target name="launch">
        <exec executable="${simulation_app}" dir="${run_dir}" failonerror="false" timeout="600000">
            <arg value="--root-dir=../../data"/>
            <arg value="--exercise=${testName}"/>
            <arg value="--session=default"/>
        </exec>
    </target>
    
    <target name="reports">
        <copy file="${exercises}/${testName}/sessions/default/Dispatcher.log" tofile="reports/Dispatcher.log"/>
        <copy file="${exercises}/${testName}/sessions/default/Sim.log" tofile="reports/Sim.log"/>
    </target>
    
</project>

