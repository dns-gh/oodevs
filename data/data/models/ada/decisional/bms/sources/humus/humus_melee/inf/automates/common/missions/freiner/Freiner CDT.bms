includedFiles = includedFiles or {}
includedFiles["sources/humus/humus_melee/inf/automates/common/missions/freiner/Freiner CDT.bms"] = true

local emptyTable = emptyTable

--[[// *****************************************************************************
]]--[[//
]]--[[// $Created: JCR 03-05-15 $
]]--[[// $Archive: /MVW_v10/Build/Data/Data/Modeles/Sources/Melee/Inf/Automates/Common/Missions/Freiner/Freiner CDT.hal $
]]--[[// $Author: Ggr $
]]--[[// $Modtime: 20/06/05 16:03 $
]]--[[// $Revision: 22 $
]]--[[// $Workfile: Freiner CDT.hal $
]]--[[//
]]--[[// *****************************************************************************
]]
node "BEH_Conduite_Automate_INF_Freiner"
{
    feedbacks = { { { "done_BEH_Conduite_Automate_INF_Freiner" }, "BEH_Conduite_Automate_INF_Freiner" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_BEH_Conduite_Automate_INF_Freiner, {value} ) end,
    activations =
    {
        { "BEH_Dispositif_Automate_INF_Freiner_Perroquet", { "done_BEH_Dispositif_Automate_INF_Freiner_Perroquet" } },
        { "BEH_Situation_Automate_INF_Freiner", { "done_BEH_Situation_Automate_INF_Freiner" } },
        { "BEH_Conduite_Automate_INF_OrdreConduite", { "done_BEH_Conduite_Automate_INF_OrdreConduite" } },
    },

    create = function( self )
    end,

    activate = function( self )
        local Activate = Activate
        if( ModuleBegins() ) then
            do
                StartActivateOverride( self, self.activations.BEH_Dispositif_Automate_INF_Freiner_Perroquet, 1, emptyTable )
            end
--[[//-----------------------------------------------------------------------------
]]--[[// Coordination du front
]]--[[//-----------------------------------------------------------------------------
]]--[[// behavior BEH_Dispositif_Automate_INF_Gerer_RepliAppuis();
]]--[[// Gestion des ordres de conduite : Decrocher
]]        end

        Activate( self.activations.BEH_Situation_Automate_INF_Freiner, 1, emptyTable )
        Activate( self.activations.BEH_Conduite_Automate_INF_OrdreConduite, 1, emptyTable )
    end,

}

node "BEH_Conduite_Automate_INF_OrdreConduite"
{
    feedbacks = { { { "done_BEH_Conduite_Automate_INF_OrdreConduite" }, "BEH_Conduite_Automate_INF_OrdreConduite" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_BEH_Conduite_Automate_INF_OrdreConduite, {value} ) end,
    activations =
    {
        { "BEH_Conduite_Automate_INF_Freiner_RompreContact", { "done_BEH_Conduite_Automate_INF_Freiner_RompreContact" } },
        { "ACT_Ordre_Suppression", { "done_ACT_Ordre_Suppression" } },
    },

    create = function( self )
    end,

    activate = function( self )
        local Activate = Activate
        --[[//-----------------------------------------------------------------------------
]]--[[// Recevoir un ordre
]]--[[//-----------------------------------------------------------------------------
]]local ordres_recus = DEC_GetCategory( "ordres_recus" )
        for _,x in pairs( ordres_recus or emptyTable ) do
        local _continue = true
do
                local ordre = x
                local repOrdre = ordre
                if( repOrdre:GetType() == "Rep_OrderConduite_Decrocher" ) then
                    Activate( self.activations.BEH_Conduite_Automate_INF_Freiner_RompreContact, 1, emptyTable )
                end

                Activate( self.activations.ACT_Ordre_Suppression, 1, { ordre, } )
            end

        end

    end,

--[[// ----------------------------------------------------------------------------
]]--[[// $Created : JCR : 27/01/2004 09:45$
]]--[[//
]]--[[// MAJ eEtatEchelon_ des pions  utilise  dans  la  mission  freiner  des pions pour 
]]--[[// obtenir une manoeuvre en perroquet.
]]--[[// ----------------------------------------------------------------------------
]]}

node "BEH_Dispositif_Automate_INF_Freiner_Perroquet"
{
    feedbacks = { { { "done_BEH_Dispositif_Automate_INF_Freiner_Perroquet" }, "BEH_Dispositif_Automate_INF_Freiner_Perroquet" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_BEH_Dispositif_Automate_INF_Freiner_Perroquet, {value} ) end,
    create = function( self )
    end,

    activate = function( self )
        local Activate = Activate
        local lstPions = DEC_Automate_PionsAvecPC()
        --[[// selection lstPions_PE = S_ObtenirPionsDe( eEtatEchelon_Premier, eEtatDestruction_None );
]]local lstPions_PE = S_Cherche_Automate_Filtre_TypeMission( lstPions, "T_Mission_Pion_INF_Freiner" )
        if( DIA_IsListEmpty( lstPions_PE ) ) then
            do
                --[[// lstPions_PE = S_ObtenirPionsDe( eEtatEchelon_Premier, eEtatDestruction_None );
]]lstPions_PE = S_Cherche_Automate_Filtre_TypeMission( lstPions, "T_Mission_Pion_INF_Freiner" )
                                do return end

            end
        end

        local bBascule = true
        for _,x_pion in pairs( lstPions_PE or emptyTable ) do
        local _continue = true
do
                local pion = x_pion
                if( DEC_GetMission( pion ) == nil ) then
                    do return end
                end

                pion:SetbFreiner_EnTete_( bBascule )
                bBascule = not bBascule
            end

        end

                self:SendFeedback( eActionEffectuee )
        Halt( self )
        do return end

    end,

}

node "BEH_Conduite_Automate_INF_Freiner_Assigner_AppuiPionSE"
{
    feedbacks = { { { "done_BEH_Conduite_Automate_INF_Freiner_Assigner_AppuiPionSE" }, "BEH_Conduite_Automate_INF_Freiner_Assigner_AppuiPionSE" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_BEH_Conduite_Automate_INF_Freiner_Assigner_AppuiPionSE, {value} ) end,
    activations =
    {
        { "BEH_Conduite_Automate_INF_AppuyerCompromis", { "done_BEH_Conduite_Automate_INF_AppuyerCompromis" } },
    },

    create = function( self )
        self._namedParams = {}
        self._namedParams.pPion = self.params[1]
    end,

    activate = function( self )
        local Activate = Activate
        self.mission = self.mission or DEC_GetMission( myself )
        self.pionAppui = self.pionAppui or nil
        local sPions_OK = S_ObtenirPionsDe( eEtatEchelon_Second, eEtatDestruction_None )
        if( ModuleBegins() ) then
            do
                self.pionAppui = S_Cherche_Automate_TypePion( sPions_OK, "SectionInfanterie_HOT" )
                if( self.pionAppui == nil ) then
                    self.pionAppui = S_Cherche_Automate_TypePion( sPions_OK, "SectionInfanterie_MILAN" )
                end

                --[[// if ( pionAppui == nil )
]]--[[// 	pionAppui = S_Cherche_Automate_TypePion( sPions_Appuis, SectionInfanterie );
]]if( self.pionAppui == nil ) then
                    Halt( self )
                    do return end
                end

                for _,x_appuyer in pairs( --[[// Assigne mission Appuyer
]]sPions_OK or emptyTable ) do
                local _continue = true
do
                        local pionAAppuyer = x_appuyer
                        if( S_Misc_EstMissionAffectee_Pion( pionAAppuyer, "T_Mission_Pion_INF_Freiner" ) ) then
                            do
                                local rForceEnTete = 0.5
                                --[[// Cherche les pions en SE en priorite
]]if( not F_Pion_GeteEtatEchelon( pionAAppuyer ) ) then
                                    rForceEnTete = 2
                                end

                                --[[// Moins on a d'appui, plus on a envie d'etre appuyer
]]local rForceAppuyer = ( 1 / ( 1 + #( F_Pion_GetselUnitesEnAppui( pionAAppuyer ) ) ) )
                                local rForceAppui = 0.1 * rForceEnTete * rForceAppuyer
                                Activate( self.activations.BEH_Conduite_Automate_INF_AppuyerCompromis, rForceAppui, { self.pionAppui, pionAAppuyer, } )
                            end
                        end

                    end

                end

            end
        end

    end,

}

node "BEH_Conduite_Automate_INF_AppuyerCompromis"
{
    feedbacks = { { { "done_BEH_Conduite_Automate_INF_AppuyerCompromis" }, "BEH_Conduite_Automate_INF_AppuyerCompromis" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_BEH_Conduite_Automate_INF_AppuyerCompromis, {value} ) end,
    instances =
    {
        max = 1,
    },

    activations =
    {
        { "BEH_Mission_Automate_ABC_AssignerSoutenirA", { "done_BEH_Mission_Automate_ABC_AssignerSoutenirA" } },
        { "BEH_Mission_Automate_INF_AssignerAppuyerA", { "done_BEH_Mission_Automate_INF_AssignerAppuyerA" } },
    },

    create = function( self )
        self._namedParams = {}
        self._namedParams.pPion = self.params[1]
        self._namedParams.pAAppuyer = self.params[2]
    end,

    activate = function( self )
        local Activate = Activate
        if( ModuleBegins() ) then
            do
                 do
                    local _continue = true
                    local switch_1 = self._namedParams.pPion:GetType()
                        if switch_1 == "Peloton_AMX"
                        or switch_1 == "Peloton_XL" then
                                                    StartActivateOverride( self, self.activations.BEH_Mission_Automate_ABC_AssignerSoutenirA, 1, { ePhase_CDT, self._namedParams.pPion, self._namedParams.pAAppuyer, eEtatEchelon_Second, } )
                            _continue = false
                        elseif switch_1 == "SectionInfanterie"
                        or switch_1 == "SectionInfanterie_MILAN"
                        or switch_1 == "SectionInfanterie_HOT"
                        or switch_1 == "SectionInfanterie_Appui"
                        or switch_1 == "GroupeInfanterie_Mortier" then
                                                    StartActivateOverride( self, self.activations.BEH_Mission_Automate_INF_AssignerAppuyerA, 1, { ePhase_CDT, self._namedParams.pPion, self._namedParams.pAAppuyer, eEtatEchelon_Second, } )
                            _continue = false
                                                end
                    end

            end
        end

    end,

}

node "BEH_Dispositif_Automate_INF_Gerer_RepliAppuis"
{
    feedbacks = { { { "done_BEH_Dispositif_Automate_INF_Gerer_RepliAppuis" }, "BEH_Dispositif_Automate_INF_Gerer_RepliAppuis" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_BEH_Dispositif_Automate_INF_Gerer_RepliAppuis, {value} ) end,
    create = function( self )
    end,

    activate = function( self )
        local Activate = Activate
                self.ptRegroupement = self.ptRegroupement or DEC_Geometrie_CalculerPointArrivee()
        for _,x in pairs( DEC_Automate_PionsSansPC() or emptyTable ) do
        local _continue = true
do
                local x_pion = x
                if( S_Misc_EstMissionAffectee_Pion( x_pion, "T_Mission_Pion_INF_Freiner" ) ) then
                    do return end
                end

                local sAppuis = F_Pion_GetselUnitesEnAppui( x_pion )
                for _,x_appui in pairs( sAppuis or emptyTable ) do
                local _continue = true
do
                    end
--[[// action ACT_Misc_MAJ_PositionRegroupement( x_appui, ptRegroupement );
]]
                end

            end

        end

    end,

    destroy = function( self )
            end,

}

node "BEH_Situation_Automate_INF_Freiner"
{
    feedbacks = { { { "done_BEH_Situation_Automate_INF_Freiner" }, "BEH_Situation_Automate_INF_Freiner" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_BEH_Situation_Automate_INF_Freiner, {value} ) end,
    activations =
    {
        { "BEH_Situation_Automate_INF_Freiner_SurLCAR", { "done_BEH_Situation_Automate_INF_Freiner_SurLCAR" } },
    },

    create = function( self )
    end,

    activate = function( self )
        local Activate = Activate
        local selPions_PE = S_ObtenirPionsDe( eEtatEchelon_Premier, eEtatDestruction_None )
        for _,x_pion in pairs( selPions_PE or emptyTable ) do
        local _continue = true
do
                local pPion = x_pion
                 do
                    local _continue = true
                    local switch_1 = F_Pion_GeteEtatLima( pPion )
                        if switch_1 == eEtatLima_LCAR then
                            Activate( self.activations.BEH_Situation_Automate_INF_Freiner_SurLCAR, 1, { pPion, } )
                            _continue = false
                                                end
                    end

            end

        end

    end,

}

node "BEH_Situation_Automate_INF_Freiner_SurLCAR"
{
    feedbacks = { { { "done_BEH_Situation_Automate_INF_Freiner_SurLCAR" }, "BEH_Situation_Automate_INF_Freiner_SurLCAR" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_BEH_Situation_Automate_INF_Freiner_SurLCAR, {value} ) end,
    activations =
    {
        { "BEH_Conduite_Automate_INF_Freiner_Assigner_AppuiPionSE", { "done_BEH_Conduite_Automate_INF_Freiner_Assigner_AppuiPionSE" } },
        { "ACT_Ordre_Automate_Continue", { "done_ACT_Ordre_Automate_Continue" } },
        { "BEH_CoordTir_Automate_INF_Intervention_LCAR", { "done_BEH_CoordTir_Automate_INF_Intervention_LCAR" } },
    },

    create = function( self )
        self._namedParams = {}
        self._namedParams.pPion = self.params[1]
    end,

    activate = function( self )
        local Activate = Activate
        self.eActionSituation = self.eActionSituation or eActionEnCours
        if( self.eActionSituation == eActionEffectuee ) then
            do
                --[[// Nombre de pion sur la coordination en PE		
]]if( self._namedParams.pPion:GetbFreiner_EnTete_() ) then
                    Activate( self.activations.BEH_Conduite_Automate_INF_Freiner_Assigner_AppuiPionSE, 1, { self._namedParams.pPion, } )
                end

                Activate( self.activations.ACT_Ordre_Automate_Continue, 1, { self._namedParams.pPion, } )
                --[[// On donne l'ordre au pion
]]DEC_Trace( "SurLCAR appelé par " .. DEC_GetSzName( self._namedParams.pPion ) .. " f= " .. FloatToString( GetActivity() ) )
                                do return end

            end
--[[// action ACT_Ordre_Automate_Pause( pPion );
]]        end

        Activate( self.activations.BEH_CoordTir_Automate_INF_Intervention_LCAR, 1, { self._namedParams.pPion, } )
self.done_BEH_CoordTir_Automate_INF_Intervention_LCAR = function( self, _, v ) self.eActionSituation = v[1] end
    end,

}

connections = connections or {}
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_AppuyerCompromis, "BEH_Mission_Automate_ABC_AssignerSoutenirA", nodes.BEH_Mission_Automate_ABC_AssignerSoutenirA }
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_AppuyerCompromis, "BEH_Mission_Automate_INF_AssignerAppuyerA", nodes.BEH_Mission_Automate_INF_AssignerAppuyerA }
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_Freiner, "BEH_Dispositif_Automate_INF_Freiner_Perroquet", nodes.BEH_Dispositif_Automate_INF_Freiner_Perroquet }
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_Freiner, "BEH_Situation_Automate_INF_Freiner", nodes.BEH_Situation_Automate_INF_Freiner }
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_Freiner, "BEH_Conduite_Automate_INF_OrdreConduite", nodes.BEH_Conduite_Automate_INF_OrdreConduite }
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_Freiner_Assigner_AppuiPionSE, "BEH_Conduite_Automate_INF_AppuyerCompromis", nodes.BEH_Conduite_Automate_INF_AppuyerCompromis }
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_OrdreConduite, "BEH_Conduite_Automate_INF_Freiner_RompreContact", nodes.BEH_Conduite_Automate_INF_Freiner_RompreContact }
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_OrdreConduite, "ACT_Ordre_Suppression", nodes.ACT_Ordre_Suppression }
connections[ #connections + 1 ] = { nodes.BEH_Situation_Automate_INF_Freiner, "BEH_Situation_Automate_INF_Freiner_SurLCAR", nodes.BEH_Situation_Automate_INF_Freiner_SurLCAR }
connections[ #connections + 1 ] = { nodes.BEH_Situation_Automate_INF_Freiner_SurLCAR, "BEH_Conduite_Automate_INF_Freiner_Assigner_AppuiPionSE", nodes.BEH_Conduite_Automate_INF_Freiner_Assigner_AppuiPionSE }
connections[ #connections + 1 ] = { nodes.BEH_Situation_Automate_INF_Freiner_SurLCAR, "ACT_Ordre_Automate_Continue", nodes.ACT_Ordre_Automate_Continue }
connections[ #connections + 1 ] = { nodes.BEH_Situation_Automate_INF_Freiner_SurLCAR, "BEH_CoordTir_Automate_INF_Intervention_LCAR", nodes.BEH_CoordTir_Automate_INF_Intervention_LCAR }
