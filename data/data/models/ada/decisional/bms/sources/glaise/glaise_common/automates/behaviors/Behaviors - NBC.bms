includedFiles = includedFiles or {}
includedFiles["sources/glaise/glaise_common/automates/behaviors/Behaviors - NBC.bms"] = true

local emptyTable = emptyTable

--[[// *****************************************************************************
]]--[[//
]]--[[// $Created: MIA 04-05-25 $
]]--[[// $Archive: /MVW_v10/Build/Data/Data/Modeles/Sources/Common/Automates/Behaviors/Behaviors - NBC.hal $
]]--[[// $Author: Ggr $
]]--[[// $Modtime: 26/08/05 17:57 $
]]--[[// $Revision: 20 $
]]--[[// $Workfile: Behaviors - NBC.hal $
]]--[[//
]]--[[// *****************************************************************************
]]
--[[// *****************************************************************************
]]--[[// behavior BEH_Nbc_Automate_GererAlerteNiv4()
]]--[[//
]]--[[// Commentaires : la connaissance de "l'objet" nuage NBC étant connu
]]--[[//                par tout le camp, ce comportement sert à : gerer la 
]]--[[//                reception d'ordre inopinée de l'anibas de mettre la tenue NBC,
]]--[[//                + CR
]]--[[//
]]--[[// *****************************************************************************
]]node "BEH_Nbc_Automate_GererAlerteNiv4"
{
    feedbacks = { { { "done_BEH_Nbc_Automate_GererAlerteNiv4" }, "BEH_Nbc_Automate_GererAlerteNiv4" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_BEH_Nbc_Automate_GererAlerteNiv4, {value} ) end,
    activations =
    {
        { "BEH_Ordre_Automate_ConduiteSurAlerteNBC", { "done_BEH_Ordre_Automate_ConduiteSurAlerteNBC" } },
        { "BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC", { "done_BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC" } },
    },

    create = function( self )
    end,

    activate = function( self )
        local Activate = Activate
        --[[//-----------------------------------------------------------------------------
]]--[[// Si l'unité PC a connaissance d'une zone contaminée, ou si contaminée
]]--[[// passer en ambiance NBC
]]--[[//-----------------------------------------------------------------------------
]]if( S_EstContamine() ) then
            do
                Activate( self.activations.BEH_Ordre_Automate_ConduiteSurAlerteNBC, 1, emptyTable )
                                do return end

            end
--[[// Sinon on laisse la responsabilité aux comandement supérieur...
]]--[[//-----------------------------------------------------------------------------
]]--[[// Gestion de l'ordre de conduite
]]--[[//-----------------------------------------------------------------------------
]]        end

        Activate( self.activations.BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC, 1, emptyTable )
    end,

--[[// *****************************************************************************
]]--[[// BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC()
]]--[[//
]]--[[// Commentaires :
]]--[[//                MIA: ATTENTION --> La gestion des ordres a été implémenté de cette manière
]]--[[//                (systeme start/stop ) pour gerer le fait de rajouter
]]--[[//                un pion en dynamique dans l'automate: celui passera en alerte
]]--[[//                de niveau 0 ou 4 suivant l'état de l'automate.
]]--[[//
]]--[[// *****************************************************************************
]]}

node "BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC"
{
    feedbacks = { { { "done_BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC" }, "BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC, {value} ) end,
    activations =
    {
        { "BEH_Ordre_Automate_ConduiteSurAlerteNBC", { "done_BEH_Ordre_Automate_ConduiteSurAlerteNBC" } },
        { "BEH_Ordre_Automate_ConduiteSurFinAlerteNBC", { "done_BEH_Ordre_Automate_ConduiteSurFinAlerteNBC" } },
        { "ACT_Ordre_Suppression", { "done_ACT_Ordre_Suppression" } },
    },

    create = function( self )
    end,

    activate = function( self )
        local Activate = Activate
        --[[//-----------------------------------------------------------------------------
]]--[[// Recevoir un ordre
]]--[[//-----------------------------------------------------------------------------
]]local ordres_recus = DEC_GetCategory( "ordres_recus" )
        for _,x in pairs( ordres_recus or emptyTable ) do
        local _continue = true
do
                local ordre = x
                local repOrdre = ordre
                local bEstUtilise = true
                 do
                    local _continue = true
--[[//-----------------------------------------------------------------------------
]]--[[// NBC
]]--[[//-----------------------------------------------------------------------------
]]--[[//-----------------------------------------------------------------------------
]]--[[// Sinon...
]]--[[//-----------------------------------------------------------------------------
]]                    local switch_1 = repOrdre:GetType()
                        if switch_1 == "Rep_OrderConduite_MettreTenueNBC" then
                            DEC_Trace( "$ --- ORDRE Mettre tenue NBC ---$" )
                            StartActivateOverride( self, self.activations.BEH_Ordre_Automate_ConduiteSurAlerteNBC, 1, emptyTable )
                            StopActivateOverride( self, self.activations.BEH_Ordre_Automate_ConduiteSurFinAlerteNBC, emptyTable )
                            _continue = false
                        elseif switch_1 == "Rep_OrderConduite_EnleverTenueNBC" then
                            DEC_Trace( "$ --- ORDRE Enlever tenue NBC ---$" )
                            StopActivateOverride( self, self.activations.BEH_Ordre_Automate_ConduiteSurAlerteNBC, emptyTable )
                            StartActivateOverride( self, self.activations.BEH_Ordre_Automate_ConduiteSurFinAlerteNBC, 1, emptyTable )
                            _continue = false
                        
                        else
                            bEstUtilise = false
                            _continue = false
                                                end
                    end

                if( bEstUtilise ) then
                    do
                        --[[// on a finit de traiter l'ordre, on le supprime
]]Activate( self.activations.ACT_Ordre_Suppression, 1, { ordre, } )
                    end
                end

            end

        end

    end,

--[[// *****************************************************************************
]]--[[// BEH_Ordre_Automate_ConduiteSurAlerteNBC()
]]--[[//
]]--[[// Commentaires : on donne juste l'ordre au pion de se vetir de leur tenue NBC
]]--[[// 
]]--[[// *****************************************************************************
]]}

node "BEH_Ordre_Automate_ConduiteSurAlerteNBC"
{
    feedbacks = { { { "done_BEH_Ordre_Automate_ConduiteSurAlerteNBC" }, "BEH_Ordre_Automate_ConduiteSurAlerteNBC" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_BEH_Ordre_Automate_ConduiteSurAlerteNBC, {value} ) end,
    activations =
    {
        { "ACT_RC_Automate", { "done_ACT_RC_Automate" } },
        { "ACT_Ordre_MettreTenueNBC", { "done_ACT_Ordre_MettreTenueNBC" } },
    },

    create = function( self )
    end,

    activate = function( self )
        local Activate = Activate
        --[[//-----------------------------------------------------------------------------
]]--[[// RC
]]--[[//-----------------------------------------------------------------------------
]]Activate( self.activations.ACT_RC_Automate, 1, { eRC_TenueProtectionNBCMise, } )
        --[[//-----------------------------------------------------------------------------
]]--[[// Donner l'ordre aux pions si embrayé
]]--[[//-----------------------------------------------------------------------------
]]local listePionsSubordonnes = myself:DEC_Automate_PionsAvecPC()
        for _,x in pairs( listePionsSubordonnes or emptyTable ) do
        local _continue = true
do
                local pion = x
                Activate( self.activations.ACT_Ordre_MettreTenueNBC, 1, { pion, } )
            end

        end

    end,

--[[// *****************************************************************************
]]--[[// BEH_Ordre_Automate_ConduiteSurFinAlerteNBC()
]]--[[//
]]--[[// Commentaires : on donne juste l'ordre au pion de se vetir de leur tenue NBC
]]--[[// 
]]--[[// *****************************************************************************
]]}

node "BEH_Ordre_Automate_ConduiteSurFinAlerteNBC"
{
    feedbacks = { { { "done_BEH_Ordre_Automate_ConduiteSurFinAlerteNBC" }, "BEH_Ordre_Automate_ConduiteSurFinAlerteNBC" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_BEH_Ordre_Automate_ConduiteSurFinAlerteNBC, {value} ) end,
    activations =
    {
        { "ACT_RC_Automate", { "done_ACT_RC_Automate" } },
        { "ACT_Ordre_EnleverTenueNBC", { "done_ACT_Ordre_EnleverTenueNBC" } },
    },

    create = function( self )
    end,

    activate = function( self )
        local Activate = Activate
        --[[//-----------------------------------------------------------------------------
]]--[[// RC
]]--[[//-----------------------------------------------------------------------------
]]Activate( self.activations.ACT_RC_Automate, 1, { eRC_TenueProtectionNBCEnlevee, } )
        --[[//-----------------------------------------------------------------------------
]]--[[// Donner l'ordre aux pions si embrayé
]]--[[//-----------------------------------------------------------------------------
]]local listePionsSubordonnes = DEC_Automate_PionsAvecPC()
        for _,x in pairs( listePionsSubordonnes or emptyTable ) do
        local _continue = true
do
                local pion = x
                Activate( self.activations.ACT_Ordre_EnleverTenueNBC, 1, { pion, } )
            end

        end

    end,

--[[// *****************************************************************************
]]--[[// ACT_Ordre_MettreTenueNBC
]]--[[//
]]--[[// Commentaires : on donne juste l'ordre au pion de se vetir de sa tenue NBC
]]--[[// 
]]--[[// *****************************************************************************
]]}

node "ACT_Ordre_MettreTenueNBC"
{
    feedbacks = { { { "done_ACT_Ordre_MettreTenueNBC" }, "ACT_Ordre_MettreTenueNBC" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_ACT_Ordre_MettreTenueNBC, {value} ) end,
    create = function( self )
        self._namedParams = {}
        self._namedParams.pion = self.params[1]
    end,

    select = function( self )
                if( ModuleBegins() ) then
            self._namedParams.pion:SetStateVariable( "VE_NiveauNBC", 4 )
        end

    end,

    deselect = function( self )
            end,

}

--[[// *****************************************************************************
]]--[[// ACT_Ordre_EnleverTenueNBC
]]--[[//
]]--[[// Commentaires : on donne juste l'ordre au pion de se devetir de sa tenue NBC
]]--[[// 
]]--[[// *****************************************************************************
]]node "ACT_Ordre_EnleverTenueNBC"
{
    feedbacks = { { { "done_ACT_Ordre_EnleverTenueNBC" }, "ACT_Ordre_EnleverTenueNBC" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_ACT_Ordre_EnleverTenueNBC, {value} ) end,
    create = function( self )
        self._namedParams = {}
        self._namedParams.pion = self.params[1]
    end,

    select = function( self )
                if( ModuleBegins() ) then
            self._namedParams.pion:SetStateVariable( "VE_NiveauNBC", 0 )
        end

    end,

    deselect = function( self )
            end,

}

connections = connections or {}
connections[ #connections + 1 ] = { nodes.BEH_Nbc_Automate_GererAlerteNiv4, "BEH_Ordre_Automate_ConduiteSurAlerteNBC", nodes.BEH_Ordre_Automate_ConduiteSurAlerteNBC }
connections[ #connections + 1 ] = { nodes.BEH_Nbc_Automate_GererAlerteNiv4, "BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC", nodes.BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC }
connections[ #connections + 1 ] = { nodes.BEH_Ordre_Automate_ConduiteSurAlerteNBC, "ACT_RC_Automate", nodes.ACT_RC_Automate }
connections[ #connections + 1 ] = { nodes.BEH_Ordre_Automate_ConduiteSurAlerteNBC, "ACT_Ordre_MettreTenueNBC", nodes.ACT_Ordre_MettreTenueNBC }
connections[ #connections + 1 ] = { nodes.BEH_Ordre_Automate_ConduiteSurFinAlerteNBC, "ACT_RC_Automate", nodes.ACT_RC_Automate }
connections[ #connections + 1 ] = { nodes.BEH_Ordre_Automate_ConduiteSurFinAlerteNBC, "ACT_Ordre_EnleverTenueNBC", nodes.ACT_Ordre_EnleverTenueNBC }
connections[ #connections + 1 ] = { nodes.BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC, "BEH_Ordre_Automate_ConduiteSurAlerteNBC", nodes.BEH_Ordre_Automate_ConduiteSurAlerteNBC }
connections[ #connections + 1 ] = { nodes.BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC, "BEH_Ordre_Automate_ConduiteSurFinAlerteNBC", nodes.BEH_Ordre_Automate_ConduiteSurFinAlerteNBC }
connections[ #connections + 1 ] = { nodes.BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC, "ACT_Ordre_Suppression", nodes.ACT_Ordre_Suppression }
