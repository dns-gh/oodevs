includedFiles = includedFiles or {}
includedFiles["sources/melee/inf/pions/common/Behaviors - Mot.bms"] = true

include "bit.lua"


--[[// *****************************************************************************
]]--[[//
]]--[[// $Created: JCR 03-02-20 $
]]--[[// $Archive: /MVW_v10/Build/Data/Data/Modeles/Sources/Melee/Inf/Pions/Common/Behaviors - Mot.hal $
]]--[[// $Author: Ggr $
]]--[[// $Modtime: 8/07/05 16:21 $
]]--[[// $Revision: 14 $
]]--[[// $Workfile: Behaviors - Mot.hal $
]]--[[//
]]--[[// *****************************************************************************
]]


--[[// Motivations specifiques pour l'infanterie : en parallele
]]--[[// ------------------------------------------------------------------------
]]node "BEH_MOT_Pion_INF_GarderSesDistances"
{
    activations =
    {
        { "BEH_MOT_Pion_INF_GarderSesDistancesFaceA", {} },
    },

    create = function( self )
    end,

    activate = function( self )
        local lstEnisDangereux = DEC_Connaissances_UnitesEnnemiesDangereuses()
        for _,ksEni in pairs( lstEnisDangereux ) do
        local _continue = true
            Activate( self.activations.BEH_MOT_Pion_INF_GarderSesDistancesFaceA, S_Force_DangerSur( ksEni ), { ksEni, } )

        end

    end,

--[[// ----------------------------------------------------------------------------
]]--[[// BEH_MOT_Pion_INF_GarderSesDistancesFaceA
]]--[[// ----------------------------------------------------------------------------
]]}

node "BEH_MOT_Pion_INF_GarderSesDistancesFaceA"
{
    activations =
    {
        { "ACT_Tir_INF_FumigeneVersEni", {} },
        { "ACT_MAJ_EnnemiEnCours", {} },
    },

    create = function( self )
        self._namedParams = {}
        self._namedParams.ksEni = self.params[1]
    end,

    activate = function( self )
        self.bAutoriseDebarquement = self.bAutoriseDebarquement or ( myself:GetType() ~= "SectionInfanterie_HOT" ) or ( not DEC_Agent_EstPC() )
        if( ModuleBegins() ) then
            do
                --[[// Tir les fumigenes	
]]if( DEC_ConnaissanceAgent_PercoitUnite( self._namedParams.ksEni ) ) then
                    StartActivate( self.activations.ACT_Tir_INF_FumigeneVersEni, 1, { self._namedParams.ksEni, } )
                end

            end
        end

        Activate( self.activations.ACT_MAJ_EnnemiEnCours, 1, { self._namedParams.ksEni, } )
    end,

--[[// ----------------------------------------------------------------------------
]]--[[// BEH_MOT_Pion_INF_GarderSesDistances_GererTransport
]]--[[//
]]--[[// Debarque si la motivation de garder sa distance est active et que l'on est 
]]--[[// arrete
]]--[[// ----------------------------------------------------------------------------
]]}

node "BEH_MOT_Pion_INF_GarderSesDistances_GererTransport"
{
    activations =
    {
        { "BEH_MOT_Pion_INF_Debarquer", {} },
    },

    create = function( self )
    end,

    activate = function( self )
        if( DEC_Agent_EstEmbarque() and ( eNiveauInstallation_Poste == DEC_Agent_NiveauInstallation() ) ) then
            do
                local lstEnisDangereux = DEC_Connaissances_UnitesEnnemiesDangereuses()
                for _,ksEni in pairs( lstEnisDangereux ) do
                local _continue = true
                    StartActivate( self.activations.BEH_MOT_Pion_INF_Debarquer, 1, {} )

                end

            end
--[[// : strength = 1.1 * S_Force_DangerSur( ksEni );
]]        end

    end,

--[[// ----------------------------------------------------------------------------
]]--[[// BEH_MOT_Pion_INF_EtrePrudent_GererTransport
]]--[[//
]]--[[// Debarque si la motivation d'etre prudent est active 
]]--[[// ----------------------------------------------------------------------------
]]}

node "BEH_MOT_Pion_INF_EtrePrudent_GererTransport"
{
    activations =
    {
        { "BEH_MOT_Pion_INF_Debarquer", {} },
    },

    create = function( self )
    end,

    activate = function( self )
        if( F_Pion_GeteEtatDecPrudence( myself ) == eEtatDecPrudence_Actif and DEC_Agent_EstEmbarque() ) then
            do
                local lstEnisDangereux = DEC_Connaissances_UnitesEnnemiesDangereuses()
                for _,ksEni in pairs( lstEnisDangereux ) do
                local _continue = true
                    StartActivate( self.activations.BEH_MOT_Pion_INF_Debarquer, 1, {} )--[[// : strength = 1.1 * S_Force_DangerSur( ksEni );
]]

                end

            end
        end

    end,

--[[// ----------------------------------------------------------------------------
]]--[[// BEH_Mot_Delai_Pion_INF_AugmenterAgression
]]--[[//  Desactive la sauvegarde pendant le delai escompte
]]--[[// ----------------------------------------------------------------------------
]]}

node "BEH_Mot_Delai_Pion_INF_AugmenterAgression"
{
    activations =
    {
        { "ACT_Misc_Delai", {} },
        { "BEH_MOT_DesactiveSauvegarde", {} },
    },

    create = function( self )
        self._namedParams = {}
        self._namedParams.rDelai = self.params[1]
    end,

    activate = function( self )
        self.eAction = self.eAction or eActionEnCours
        if( ModuleBegins() ) then
            DEC_Trace( "CBT Rencontre : desactive" )
        end

        if( self.eAction == eActionEffectuee ) then
            do
                self.eAction = eActionEnCours
                                do
                                        self.params.__returnValue = eActionEffectuee
                    Halt( self )
                    do return end

                end

            end
        end

        Activate( self.activations.ACT_Misc_Delai, 1, setmetatable( { 1, self._namedParams.rDelai, }, { __newindex = function( t, k, v ) if k == "__returnValue" then self.eAction = v else rawset( t, k, v ) end end } ) )
        Activate( self.activations.BEH_MOT_DesactiveSauvegarde, 1, {} )
    end,

--[[// ----------------------------------------------------------------------------
]]--[[// BEH_MOT_Pion_InitialisePreparationMission
]]--[[// ----------------------------------------------------------------------------
]]}

node "BEH_MOT_Pion_InitialisePreparationMission"
{
    create = function( self )
    end,

    activate = function( self )
        if( ModuleBegins() ) then
            SetStateVariable( "VE_PreparationMission", 0 )
        end

    end,

--[[// ----------------------------------------------------------------------------
]]--[[// BEH_MOT_Pion_INF_InitialisePoste
]]--[[// ----------------------------------------------------------------------------
]]}

node "BEH_MOT_Pion_INF_InitialisePoste"
{
    create = function( self )
    end,

    activate = function( self )
        if( ModuleBegins() ) then
            SetStateVariable( "VE_SePoster", 0 )
        end

    end,

--[[// ----------------------------------------------------------------------------
]]--[[// BEH_MOT_Pion_INF_Debarquer()
]]--[[// Maintenir etat doit etre > 1 sinon, il risque d'avoir une force < a un 
]]--[[// comportement de embarquement recevant une force > a celle de debarquer
]]--[[// ----------------------------------------------------------------------------
]]}

node "BEH_MOT_Pion_INF_Debarquer"
{
    activations =
    {
        { "ACT_Transport_Pion_INF_Debarquer", {} },
        { "ACT_Transport_MaintenirEtat", {} },
    },

    create = function( self )
    end,

    activate = function( self )
        if( DEC_Agent_TransporteursPret() and DEC_Agent_EstEmbarque() ) then
            StartActivate( self.activations.ACT_Transport_Pion_INF_Debarquer, 2.01, {} )
        end

        Activate( self.activations.ACT_Transport_MaintenirEtat, 2, { eEtatTransport_Debarque, } )
    end,

}

connections = connections or {}
connections[ #connections + 1 ] = { nodes.BEH_MOT_Pion_INF_Debarquer, "ACT_Transport_Pion_INF_Debarquer", nodes.ACT_Transport_Pion_INF_Debarquer }
connections[ #connections + 1 ] = { nodes.BEH_MOT_Pion_INF_Debarquer, "ACT_Transport_MaintenirEtat", nodes.ACT_Transport_MaintenirEtat }
connections[ #connections + 1 ] = { nodes.BEH_MOT_Pion_INF_EtrePrudent_GererTransport, "BEH_MOT_Pion_INF_Debarquer", nodes.BEH_MOT_Pion_INF_Debarquer }
connections[ #connections + 1 ] = { nodes.BEH_MOT_Pion_INF_GarderSesDistances, "BEH_MOT_Pion_INF_GarderSesDistancesFaceA", nodes.BEH_MOT_Pion_INF_GarderSesDistancesFaceA }
connections[ #connections + 1 ] = { nodes.BEH_MOT_Pion_INF_GarderSesDistancesFaceA, "ACT_Tir_INF_FumigeneVersEni", nodes.ACT_Tir_INF_FumigeneVersEni }
connections[ #connections + 1 ] = { nodes.BEH_MOT_Pion_INF_GarderSesDistancesFaceA, "ACT_MAJ_EnnemiEnCours", nodes.ACT_MAJ_EnnemiEnCours }
connections[ #connections + 1 ] = { nodes.BEH_MOT_Pion_INF_GarderSesDistances_GererTransport, "BEH_MOT_Pion_INF_Debarquer", nodes.BEH_MOT_Pion_INF_Debarquer }
connections[ #connections + 1 ] = { nodes.BEH_Mot_Delai_Pion_INF_AugmenterAgression, "ACT_Misc_Delai", nodes.ACT_Misc_Delai }
connections[ #connections + 1 ] = { nodes.BEH_Mot_Delai_Pion_INF_AugmenterAgression, "BEH_MOT_DesactiveSauvegarde", nodes.BEH_MOT_DesactiveSauvegarde }
