includedFiles = includedFiles or {}
includedFiles["sources/melee/inf/automates/common/Behaviors CDT - Offensive.bms"] = true

include "bit.lua"


--[[// *****************************************************************************
]]--[[//
]]--[[// $Created: JCR 03-05-15 $
]]--[[// $Archive: /MVW_v10/Build/Data/Data/Modeles/Sources/Melee/Inf/Automates/Common/Behaviors CDT - Offensive.hal $
]]--[[// $Author: Ggr $
]]--[[// $Modtime: 24/08/05 15:59 $
]]--[[// $Revision: 17 $
]]--[[// $Workfile: Behaviors CDT - Offensive.hal $
]]--[[//
]]--[[// *****************************************************************************
]]

--[[//-----------------------------------------------------------------------------
]]--[[// Reassigne reconnaitre au pion terminant une mission annexe
]]--[[// Et demande a l'autre pion de PE de poursuivre
]]--[[//-----------------------------------------------------------------------------
]]node "BEH_Conduite_Automate_INF_Reconnaitre_AssignerReco"
{
    activations =
    {
        { "BEH_Mission_Automate_ABC_AssignerSoutenirA", { "onHalt" } },
        { "BEH_Mission_Automate_INF_AssignerAppuyerA", { "onHalt" } },
        { "BEH_Mission_Automate_INF_AssignerA_ReconnaitrePt", { "onHalt" } },
    },

    onHalt = OnHalt,

    feedbacks = { { { "onHalt" }, "BEH_Conduite_Automate_INF_Reconnaitre_AssignerReco" } },

    create = function( self )
        self._namedParams = {}
        self._namedParams.pPion = self.params[1]
    end,

    activate = function( self )
                self.eAction = self.eAction or nil
        self.ptDest = self.ptDest or DEC_Geometrie_CalculerPointArrivee()
        if( not ModuleBegins() ) then
            self.params.__returnValue = eActionEffectuee
            Feedback( self.feedbacks["onHalt"], { "BEH_Conduite_Automate_INF_Reconnaitre_AssignerReco" } )
Halt( self )
            do return end
        end

        --[[// S'il ya 3 pions en premier echelon et qu'un pion
]]--[[// n'est pas appuye, alors on l'appui
]]local selPionsPE = S_ObtenirPionsDe( eEtatEchelon_Premier, eEtatDestruction_None )
        local pAAppuyer = S_Cherche_Automate_INF_PionAAppuyer( selPionsPE, self._namedParams.pPion )
        if( ( pAAppuyer ~= 0 and pAAppuyer ~= nil ) ) then
            do
                 do
                    local switch_1 = --[[// On ajoute l'appui			
]]self._namedParams.pPion:GetType()
                    local cases_switch_1 = {}
                        if switch_1 == "Peloton_AMX"
                        or switch_1 == "Peloton_XL" then
                                                    Activate( self.activations.BEH_Mission_Automate_ABC_AssignerSoutenirA, 1, { ePhase_CDT, self._namedParams.pPion, pAAppuyer, eEtatEchelon_Second, } )
                            
                                                cases_switch_1[1] = true
elseif switch_1 == "SectionInfanterie"
                        or switch_1 == "SectionInfanterie_MILAN"
                        or switch_1 == "SectionInfanterie_HOT"
                        or switch_1 == "SectionInfanterie_Appui"
                        or switch_1 == "GroupeInfanterie_Mortier" then
                                                    Activate( self.activations.BEH_Mission_Automate_INF_AssignerAppuyerA, 1, { ePhase_CDT, self._namedParams.pPion, pAAppuyer, eEtatEchelon_Second, } )
                            
                                                cases_switch_1[2] = true
                        end
                    end

            end
        else
            Activate( self.activations.BEH_Mission_Automate_INF_AssignerA_ReconnaitrePt, 1, setmetatable( { ePhase_CDT, self._namedParams.pPion, self.ptDest, }, { __newindex = function( t, k, v ) if k == "__returnValue" then self.eAction = v else rawset( t, k, v ) end end } ) )
        end

    end,

    destroy = function( self )
            end,

}

node "BEH_Conduite_Automate_INF_Reduire_Manoeuvre"
{
    activations =
    {
        { "BEH_Conduite_Automate_INF_Assaut_Manoeuvre", { "onHalt" } },
    },

    onHalt = OnHalt,

    feedbacks = { { { "onHalt" }, "BEH_Conduite_Automate_INF_Reduire_Manoeuvre" } },

    create = function( self )
        self._namedParams = {}
        self._namedParams.ptEni = self.params[1]
    end,

    activate = function( self )
        self.ksEni = self.ksEni or nil
        self.eAction = self.eAction or eActionEnCours
        if( self.eAction == eActionEffectuee ) then
            do
                self.eAction = eActionEnCours
                                self.params.__returnValue = eActionEffectuee
                Feedback( self.feedbacks["onHalt"], { "BEH_Conduite_Automate_INF_Reduire_Manoeuvre" } )
Halt( self )
                do return end

            end
        end

        local pPion = S_Cherche_Automate_INF_PionMission( DEC_Automate_PionsSansPC(), "T_Mission_Pion_INF_Semparer" )
        if( ( pPion == 0 or pPion == nil ) ) then
            self.params.__returnValue = eActionEnCours
            return
        end

        if( DEC_ConnaissanceAgent_EstValide( self.ksEni ) ) then
            Activate( self.activations.BEH_Conduite_Automate_INF_Assaut_Manoeuvre, 1, setmetatable( { pPion, self.ksEni, }, { __newindex = function( t, k, v ) if k == "__returnValue" then self.eAction = v else rawset( t, k, v ) end end } ) )
        end

    end,

--[[//-----------------------------------------------------------------------------
]]--[[//-----------------------------------------------------------------------------
]]--[[// Conduites des assauts
]]--[[//-----------------------------------------------------------------------------	
]]--[[//-----------------------------------------------------------------------------
]]--[[/* bReduire */]]}

node "BEH_Situation_Automate_INF_Assaut"
{
    activations =
    {
        { "BEH_Conduite_Automate_INF_Assaut_Manoeuvre", { "onHalt" } },
        { "BEH_Conduite_Automate_INF_Assaut_Reduction", { "onHalt" } },
        { "BEH_Conduite_Automate_INF_Assaut_Reduction_SurPriseContact", { "onHalt" } },
    },

    onHalt = OnHalt,

    feedbacks = { { { "onHalt" }, "BEH_Situation_Automate_INF_Assaut" } },

    create = function( self )
        self._namedParams = {}
        self._namedParams.bReduire = self.params[1]
    end,

    activate = ActivateWithStart,

    internalactivate = function( self )
        for _,x in pairs( --[[//-----------------------------------------------------------------------------
]]--[[// Gestion des RC recus 
]]--[[//-----------------------------------------------------------------------------		
]]DEC_Automate_PionsSansPC() ) do
        local _continue = true
do
                local x_pion = x
                 do
                    local switch_1 = --[[// Situation Ennemi
]]--[[// --------------------------------------------------------------------
]]F_Pion_GeteEtatSituationEnnemi( x_pion )
                    local cases_switch_1 = {}
                        if switch_1 == eEtatSituationEnnemi_EniSurObjectif then
                            if( S_Misc_EstMissionAffectee_Pion( x_pion, "T_Mission_Pion_INF_Semparer" ) ) then
                                do
                                    local ksEniEnCours = S_Pion_EniEnCours( x_pion )
                                    if( DEC_ConnaissanceAgent_EstValide( ksEniEnCours ) and not DEC_ConnaissanceAgent_EstDetruitTactique( ksEniEnCours ) ) then
                                        do
                                            local fakeK = nil
                                            StartInstance( self, self.activations.BEH_Conduite_Automate_INF_Assaut_Manoeuvre, 1, { x_pion, fakeK, } )
                                        end
                                    else
if( self._namedParams.bReduire ) then
                                            StartInstance( self, self.activations.BEH_Conduite_Automate_INF_Assaut_Reduction, 1, { x_pion, } )
                                        end
                                    end

                                end
                            end

                            
                                                cases_switch_1[1] = true
elseif switch_1 == eEtatSituationEnnemi_PriseContact then
                            if( self._namedParams.bReduire ) then
                                StartInstance( self, self.activations.BEH_Conduite_Automate_INF_Assaut_Reduction_SurPriseContact, 1, { x_pion, } )
                            end

                            
                                                cases_switch_1[2] = true
elseif switch_1 == eEtatSituationEnnemi_PretPourConduiteTir then
                            if( self._namedParams.bReduire and S_Misc_EstMissionAffectee_Pion( x_pion, "T_Mission_Pion_INF_Fixer" ) ) then
                                StartInstance( self, self.activations.BEH_Conduite_Automate_INF_Assaut_Reduction, 1, { x_pion, } )
                            end

                            
                                                cases_switch_1[3] = true
                        end
                    end

            end

        end

    end,

--[[// ============================================================================
]]--[[// $Created : JCR : 06/07/2005 12:10
]]--[[// BEH_Conduite_Automate_INF_Assaut_Manoeuvre
]]--[[// 
]]--[[// Cherche a fixer l'unite ennemie et trouve une couverture 
]]--[[// ============================================================================
]]}

node "BEH_Conduite_Automate_INF_Assaut_Manoeuvre"
{
    activations =
    {
        { "BEH_Mission_Automate_INF_AssignerA_Fixer", { "onHalt" } },
        { "BEH_Mission_Automate_INF_AssignerA_Couvrir", { "onHalt" } },
    },

    onHalt = OnHalt,

    feedbacks = { { { "onHalt" }, "BEH_Conduite_Automate_INF_Assaut_Manoeuvre" } },

    create = function( self )
        self._namedParams = {}
        self._namedParams.pPion = self.params[1]
        self._namedParams.ksEniManoeuvre = self.params[2]
    end,

    activate = function( self )
                self.mission = self.mission or DEC_GetMission( myself )
        self.misPion = self.misPion or DEC_GetMission( self._namedParams.pPion )
        self.loc = self.loc or nil
        local selAppui = F_Pion_GetselUnitesEnAppui( self._namedParams.pPion )
        self.ksEni = self.ksEni or S_Pion_EniEnCours( self._namedParams.pPion )
        --[[// Pas d'appui
]]--[[// --------------------------------------------------------------------------------
]]if( ( #( selAppui ) == 0 or #( selAppui ) == nil ) or ( not DEC_ConnaissanceAgent_EstValide( self.ksEni ) and not DEC_ConnaissanceAgent_EstValide( self._namedParams.ksEniManoeuvre ) ) ) then
            self.params.__returnValue = eActionImpossible
            Feedback( self.feedbacks["onHalt"], { "BEH_Conduite_Automate_INF_Assaut_Manoeuvre" } )
Halt( self )
            do return end
        end

        if( ModuleBegins() ) then
            do
                DEC_Trace( "Conduite Assaut : Manoeuvre" )
            end
        else
--[[// L'appui (MILAN ou HOT) devrait l'avoir detruit
]]--[[// On reste dans la meme configuration
]]            self.params.__returnValue = eActionEffectuee
            Feedback( self.feedbacks["onHalt"], { "BEH_Conduite_Automate_INF_Assaut_Manoeuvre" } )
Halt( self )
            do return end
        end

        DEC_Trace( "Conduite Assaut : Mission Fixer " .. DEC_GetSzName( self._namedParams.pPion ) )
        --[[// Le PE fixe
]]if( DEC_ConnaissanceAgent_EstValide( self.ksEni ) ) then
            Activate( self.activations.BEH_Mission_Automate_INF_AssignerA_Fixer, 1, { ePhase_CDT, self._namedParams.pPion, self.ksEni, } )
        else
if( DEC_ConnaissanceAgent_EstValide( self._namedParams.ksEniManoeuvre ) ) then
                Activate( self.activations.BEH_Mission_Automate_INF_AssignerA_Fixer, 1, { ePhase_CDT, self._namedParams.pPion, self._namedParams.ksEniManoeuvre, } )
            end
        end

        --[[//-----------------------------------------------------------------------------
]]--[[// Installation de la couverture
]]--[[//-----------------------------------------------------------------------------
]]local pionCouv = S_Cherche_Automate_TypePion( selAppui, "SectionInfanterie" )
        if( ( pionCouv == 0 or pionCouv == nil ) ) then
            self.params.__returnValue = eActionImpossible
            Feedback( self.feedbacks["onHalt"], { "BEH_Conduite_Automate_INF_Assaut_Manoeuvre" } )
Halt( self )
            do return end
        end

        --[[// Initialise la couverture
]]DEC_Trace( "Conduite Assaut : Mission Couvrir " .. DEC_GetSzName( pionCouv ) )
        --[[// Objectif		
]]Activate( self.activations.BEH_Mission_Automate_INF_AssignerA_Couvrir, 1, { ePhase_CDT, pionCouv, self._namedParams.pPion, self.misPion:GetpointObjectif_(), } )
    end,

    destroy = function( self )
            end,

--[[// ============================================================================
]]--[[// $Created : JCR : 06/07/2005 12:10
]]--[[// BEH_Conduite_Automate_INF_Assaut_Reduction
]]--[[// 
]]--[[// Cherche reduire l'ennemi ( on cherche 2 unites dans les appuis )
]]--[[// ============================================================================
]]}

node "BEH_Conduite_Automate_INF_Assaut_Reduction_SurPriseContact"
{
    activations =
    {
        { "BEH_Conduite_Automate_INF_Assaut_Reduction", { "onHalt" } },
    },

    onHalt = OnHalt,

    feedbacks = { { { "onHalt" }, "BEH_Conduite_Automate_INF_Assaut_Reduction_SurPriseContact" } },

    create = function( self )
        self._namedParams = {}
        self._namedParams.pPion = self.params[1]
    end,

    activate = ActivateWithStart,

    internalactivate = function( self )
        if( ModuleBegins() ) then
            do
                local pionAppui = S_Automate_INF_UniteMission_Appuyer( self._namedParams.pPion )
                if( ( pionAppui ~= 0 and pionAppui ~= nil ) ) then
                    StartInstance( self, self.activations.BEH_Conduite_Automate_INF_Assaut_Reduction, 1, { pionAppui, } )
                else
                    StartInstance( self, self.activations.BEH_Conduite_Automate_INF_Assaut_Reduction, 1, { self._namedParams.pPion, } )
                end

            end
        end

    end,

--[[// ============================================================================
]]--[[// $Created : JCR : 06/07/2005 12:10
]]--[[// BEH_Conduite_Automate_INF_Assaut_Reduction
]]--[[// 
]]--[[// Cherche reduire l'ennemi ( on cherche 2 unites dans les appuis )
]]--[[// ============================================================================
]]}

node "BEH_Conduite_Automate_INF_Assaut_Reduction"
{
    activations =
    {
        { "BEH_Mission_Automate_INF_AssignerA_Reduire", { "onHalt" } },
    },

    onHalt = OnHalt,

    feedbacks = { { { "onHalt" }, "BEH_Conduite_Automate_INF_Assaut_Reduction" } },

    create = function( self )
        self._namedParams = {}
        self._namedParams.pPion = self.params[1]
    end,

    activate = function( self )
                self.mission = self.mission or DEC_GetMission( myself )
        self.ksEni = self.ksEni or S_Pion_EniEnCours( self._namedParams.pPion )
        local selAppui = F_Pion_GetselUnitesEnAppui( self._namedParams.pPion )
        --[[// Pas d'appui
]]--[[// --------------------------------------------------------------------------------
]]if( ( #( selAppui ) == 0 or #( selAppui ) == nil ) ) then
            self.params.__returnValue = eActionImpossible
            Feedback( self.feedbacks["onHalt"], { "BEH_Conduite_Automate_INF_Assaut_Reduction" } )
Halt( self )
            do return end
        end

        if( not DEC_ConnaissanceAgent_EstValide( self.ksEni ) ) then
            self.ksEni = S_Cherche_Automate_INF_EniValide_Pour( self._namedParams.pPion )
        end

        --[[// Pas d'ennemi trouve a proximite
]]if( not DEC_ConnaissanceAgent_EstValide( self.ksEni ) ) then
            self.params.__returnValue = eActionImpossible
            Feedback( self.feedbacks["onHalt"], { "BEH_Conduite_Automate_INF_Assaut_Reduction" } )
Halt( self )
            do return end
        end

        if( ModuleBegins() ) then
            do
                DEC_Trace( "Conduite Assaut : Reduction" )
            end
        else
do
                --[[// L'appui (MILAN ou HOT) devrait l'avoir detruit
]]--[[// On reste dans la meme configuration
]]                self.params.__returnValue = eActionEffectuee
                Feedback( self.feedbacks["onHalt"], { "BEH_Conduite_Automate_INF_Assaut_Reduction" } )
Halt( self )
                do return end

            end
        end

        if( S_Misc_EstMissionAffectee_Pion( self._namedParams.pPion, "T_Mission_Pion_INF_Semparer" ) ) then
            --[[// Initialise la reduction
]]Activate( self.activations.BEH_Mission_Automate_INF_AssignerA_Reduire, 1, { ePhase_CDT, self._namedParams.pPion, self.ksEni, eEtatEchelon_Premier, } )
        end

        for _,x_assaut in pairs( --[[//-----------------------------------------------------------------------------
]]--[[// Installation de l'assaut
]]--[[//-----------------------------------------------------------------------------		
]]S_Cherche_Automate_Filtre_TypePion( selAppui, "SectionInfanterie" ) ) do
        local _continue = true
do
                --[[// Initialise la reduction
]]Activate( self.activations.BEH_Mission_Automate_INF_AssignerA_Reduire, 1, { ePhase_CDT, x_assaut, self.ksEni, eEtatEchelon_Premier, } )
            end

        end

    end,

    destroy = function( self )
            end,

}

connections = connections or {}
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_Assaut_Manoeuvre, "BEH_Mission_Automate_INF_AssignerA_Fixer", nodes.BEH_Mission_Automate_INF_AssignerA_Fixer }
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_Assaut_Manoeuvre, "BEH_Mission_Automate_INF_AssignerA_Couvrir", nodes.BEH_Mission_Automate_INF_AssignerA_Couvrir }
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_Assaut_Reduction, "BEH_Mission_Automate_INF_AssignerA_Reduire", nodes.BEH_Mission_Automate_INF_AssignerA_Reduire }
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_Assaut_Reduction_SurPriseContact, "BEH_Conduite_Automate_INF_Assaut_Reduction", nodes.BEH_Conduite_Automate_INF_Assaut_Reduction }
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_Reconnaitre_AssignerReco, "BEH_Mission_Automate_ABC_AssignerSoutenirA", nodes.BEH_Mission_Automate_ABC_AssignerSoutenirA }
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_Reconnaitre_AssignerReco, "BEH_Mission_Automate_INF_AssignerAppuyerA", nodes.BEH_Mission_Automate_INF_AssignerAppuyerA }
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_Reconnaitre_AssignerReco, "BEH_Mission_Automate_INF_AssignerA_ReconnaitrePt", nodes.BEH_Mission_Automate_INF_AssignerA_ReconnaitrePt }
connections[ #connections + 1 ] = { nodes.BEH_Conduite_Automate_INF_Reduire_Manoeuvre, "BEH_Conduite_Automate_INF_Assaut_Manoeuvre", nodes.BEH_Conduite_Automate_INF_Assaut_Manoeuvre }
connections[ #connections + 1 ] = { nodes.BEH_Situation_Automate_INF_Assaut, "BEH_Conduite_Automate_INF_Assaut_Manoeuvre", nodes.BEH_Conduite_Automate_INF_Assaut_Manoeuvre }
connections[ #connections + 1 ] = { nodes.BEH_Situation_Automate_INF_Assaut, "BEH_Conduite_Automate_INF_Assaut_Reduction", nodes.BEH_Conduite_Automate_INF_Assaut_Reduction }
connections[ #connections + 1 ] = { nodes.BEH_Situation_Automate_INF_Assaut, "BEH_Conduite_Automate_INF_Assaut_Reduction_SurPriseContact", nodes.BEH_Conduite_Automate_INF_Assaut_Reduction_SurPriseContact }
