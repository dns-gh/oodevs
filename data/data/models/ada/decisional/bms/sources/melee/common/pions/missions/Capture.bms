require "math"

includedFiles = includedFiles or {}
includedFiles["sources/melee/pions/common/missions/Capture.bms"] = true

node "MIS_Pion_MELEE_Capture"
{
    feedbacks = { { { "done_MIS_Pion_MELEE_Capture" }, "MIS_Pion_MELEE_Capture" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_MIS_Pion_MELEE_Capture, {value} ) end,
    activations =
    {
        { "BEH_Mission_Pion_MELEE_Capture", { "done_BEH_Mission_Pion_MELEE_Capture" } },
    },

    create = function( self )
        self._namedParams = {}
        self._namedParams.mission = self.params.mission
    end,

    activate = function( self )
        local Activate = Activate
        if( self.eEtat == eActionImpossible ) then
            self:SendFeedback( eActionImpossible )
            Halt( self )
            do return end
        end

        if( self.eEtat == eActionEffectuee ) then
            self:SendFeedback( eActionEffectuee )
            Halt( self )
            do return end
        end

        Activate( self.activations.BEH_Mission_Pion_MELEE_Capture, 1, { self._namedParams.mission.zone_, self._namedParams.mission.knowledge_ } )
        self.done_BEH_Mission_Pion_MELEE_Capture = function( self, _, v ) self.eEtat = v[1] end
    end,
}

--[[// *****************************************************************************
]]--[[// BEH_Mission_Pion_MELEE_Capture
]]--[[//
]]--[[// Commentaires:
]]--[[//
]]--[[//
]]--[[// *****************************************************************************
]]node "BEH_Mission_Pion_MELEE_Capture"
{
    feedbacks = { { { "done_BEH_Mission_Pion_MELEE_Capture" }, "BEH_Mission_Pion_MELEE_Capture" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_BEH_Mission_Pion_MELEE_Capture, {value} ) end,
    activations =
    {
        { "BEH_Ordre_Inopine", { "done_BEH_Ordre_Inopine" } },
        { "BEH_Dep_ProgressionVers", { "done_BEH_Dep_ProgressionVers" } },
        { "BEH_Mission_Pion_ABC_Reduire", { "done_BEH_Mission_Pion_ABC_Reduire" } },
        { "BEH_Mission_Pion_VAB_Reduire", { "done_BEH_Mission_Pion_VAB_Reduire" } },
    },

    create = function( self )
        self._namedParams = {}
        self._namedParams.area = self.params[1] -- optional parameter
        self._namedParams.object = self.params[2] -- optional parameter
        self.area = self._namedParams.area or DEC_ConnaissanceObjet_Localisation( self._namedParams.object )
    end,

    activate = function( self )
        local Activate = Activate
        if not self.area then
            DEC_Trace( "Mission impossible: No area provided" )
            self:SendFeedback( eActionImpossible )
            Halt( self )
            do return end
        end
        local offsetToBeDefinedInXML = 200
        self.offsetArea = self.offsetArea or DEC_Geometrie_AgrandirLocalisation( self.area, offsetToBeDefinedInXML )
        self.position = self.position or S_Geometrie_BarycentreZone( self.area )
        DEC_Trace( "Offset created - activated" )

-- Handle fragmentary orders
        Activate( self.activations.BEH_Ordre_Inopine, 1, {} )
self.done_BEH_Ordre_Inopine = function( self, _, v ) self.eEtatOrdreFinMission = v[1] end
        if( self.eEtatOrdreFinMission == eActionHalt ) then
            do
                self.ePhaseMission = eFinMission
                self.eEtat = eActionEnCours
                self.eEtatOrdreFinMission = eActionEnCours
            end
        end

--[[//-----------------------------------------------------------------------------
]]--[[// Unit destroyed
]]--[[//-----------------------------------------------------------------------------
]]
        if( F_Pion_GeteEtatDestruction( myself ) ~= eEtatDestruction_None ) then
            self:SendFeedback( eActionEffectuee )
            Halt( self )
            do return end
        end

        --[[//-----------------------------------------------------------------------------
]]--[[// Ambiance
]]--[[//-----------------------------------------------------------------------------
]]
        F_Pion_SeteEtatAmbiance( myself, eEtatAmbiance_Vitesse )

        local myPosition = DEC_Agent_PositionPtr( myself )
        -- If not inside area then move into area.
        if not DEC_Geometrie_EstPointDansLocalisation( myPosition, self.area ) then
            Activate( self.activations.BEH_Dep_ProgressionVers, 1, { self.position, eProgressionDefaut, eTypeItiMouvement, } )
        else
            -- When inside area then attack enemies inside area plus offset
-- Note the unit should probably still move into the area and not stay on the border, but probably with a low activity weight.
            Activate( self.activations.BEH_Dep_ProgressionVers, 0.2, { self.position, eProgressionDefaut, eTypeItiMouvement, } )
            local enemies = DEC_Connaissances_UnitesEnnemiesVivantesPercues()
            local nearestEnemy = nil
            local distanceToNearest = math.huge
            for _, enemy in pairs( enemies or {} ) do
                local enemyPosition = DEC_ConnaissanceAgent_Position( enemy )
                if DEC_Geometrie_EstPointDansLocalisation( enemyPosition, self.offsetArea ) then
                    if DEC_Geometrie_Distance( myPosition, enemyPosition ) < distanceToNearest then
                        nearestEnemy = enemy
                    end
                end
            end
            if nearestEnemy then
                if meleeAbcPionsCommon() then
                    Activate( self.activations.BEH_Mission_Pion_ABC_Reduire, 1, { nearestEnemy, M_MODELE_PION_ABC_REDUIRE_PH(), M_MODELE_PION_ABC_REDUIRE_ID() } )
                elseif meleeInfPionsCommon() then
                    Activate( self.activations.BEH_Mission_Pion_VAB_Reduire, 1, { nearestEnemy } )
                else
                    DEC_Trace( "Unexpected unit model for Capture mission" )
                end
            end
        end
    end,

}

eventmanager_plugin = eventmanager_plugin or {}
eventmanager_plugin.MIS_Pion_MELEE_Capture = { "mission" }

connections = connections or {}
connections[ #connections + 1 ] = { nodes.MIS_Pion_MELEE_Capture , "BEH_Mission_Pion_MELEE_Capture", nodes.BEH_Mission_Pion_MELEE_Capture }
connections[ #connections + 1 ] = { nodes.BEH_Mission_Pion_MELEE_Capture, "BEH_Ordre_Inopine", nodes.BEH_Ordre_Inopine }
connections[ #connections + 1 ] = { nodes.BEH_Mission_Pion_MELEE_Capture, "BEH_Dep_ProgressionVers", nodes.BEH_Dep_ProgressionVers }
connections[ #connections + 1 ] = { nodes.BEH_Mission_Pion_MELEE_Capture, "BEH_Mission_Pion_ABC_Reduire", nodes.BEH_Mission_Pion_ABC_Reduire }
connections[ #connections + 1 ] = { nodes.BEH_Mission_Pion_MELEE_Capture, "BEH_Mission_Pion_VAB_Reduire", nodes.BEH_Mission_Pion_VAB_Reduire }
