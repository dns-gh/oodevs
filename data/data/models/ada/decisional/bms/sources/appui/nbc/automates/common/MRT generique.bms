includedFiles = includedFiles or {}
includedFiles["sources/appui/nbc/automates/common/MRT generique.bms"] = true

local emptyTable = emptyTable

--[[// *****************************************************************************
]]--[[//
]]--[[// $Created$
]]--[[// $Archive: /MVW_v10/Build/Data/Data/Modeles/Sources/Appui/Nbc/Automates/Common/MRT generique.hal $
]]--[[// $Author: Ggr $
]]--[[// $Modtime: 26/08/05 17:57 $
]]--[[// $Revision: 12 $
]]--[[// $Workfile: MRT generique.hal $
]]--[[//
]]--[[// *****************************************************************************
]]

--[[// *****************************************************************************
]]--[[// BEH_Medo_Automate_NBC_DonnerLesOrdresPourMission
]]--[[//
]]--[[// Commentaires:
]]--[[//
]]--[[// *****************************************************************************
]]node "BEH_Medo_Automate_NBC_DonnerLesOrdresPourMission"
{
    feedbacks = { { { "done_BEH_Medo_Automate_NBC_DonnerLesOrdresPourMission" }, "BEH_Medo_Automate_NBC_DonnerLesOrdresPourMission" } },
    SendFeedback = function( self, value ) Feedback( self.feedbacks.done_BEH_Medo_Automate_NBC_DonnerLesOrdresPourMission, {value} ) end,
    activations =
    {
        { "BEH_Medo_Automate_ControleCreationMission", { "done_BEH_Medo_Automate_ControleCreationMission" } },
        { "BEH_Medo_Automate_NBC_AssignerReconnaitreA", { "done_BEH_Medo_Automate_NBC_AssignerReconnaitreA" } },
        { "BEH_Medo_Automate_NBC_AssignerDecontaminerZoneA", { "done_BEH_Medo_Automate_NBC_AssignerDecontaminerZoneA" } },
        { "BEH_Medo_Automate_NBC_AssignerReconnaitreZoneA", { "done_BEH_Medo_Automate_NBC_AssignerReconnaitreZoneA" } },
    },

    create = function( self )
        self._namedParams = {}
        self._namedParams.eType = self.params[1]
    end,

    activate = function( self )
        local Activate = Activate
        --[[// Pions subordonnés à l'Auto
]]local selPions = DEC_Automate_PionsAvecPC()
        self.ePhase = self.ePhase or eMRT_DeterminerEchelonsGlobals
        self.eEtat = self.eEtat or eActionEnCours
        self.selABC_NBC_Reco = self.selABC_NBC_Reco or {}--[[// Liste NBC
]]
        self.selABC_NBC_Dec = self.selABC_NBC_Dec or {}
        self.selABC_NBC_RE = self.selABC_NBC_RE or {}
        self.selABC_PEcl = self.selABC_PEcl or {}--[[// Mêlée
]]
        self.selABC_Blindes = self.selABC_Blindes or {}
        self.selABC_NonPrevus = self.selABC_NonPrevus or {}
        self.selINF = self.selINF or {}
         do
            local _continue = true
--[[// =============================================================================
]]--[[// PHASE DU COMPORTEMENT
]]--[[// 1) Vérifier les moyens, des renforts éventuels
]]--[[// 2) Déterminer les échelons
]]--[[// $$$$ MIA 2004-10-01: les missions du deuxieme échelon sont données dans la conduite
]]--[[// $$$$ MIA 2004-10-01: car elles sont en permance évaluées durant la mission.
]]--[[// =============================================================================                                  
]]--[[// On ne traite pas les pions non opérationnels
]]--[[// NBC
]]--[[// MELEE
]]--[[//-----------------------------------------------------------------------------
]]--[[// 1) Assigner les missions
]]--[[//-----------------------------------------------------------------------------
]]--[[/* ------------------------------------------------------------- */]]--[[/* -------------  Gestion erreur/ bon deroulement -------------- */]]--[[/* ------------------------------------------------------------- */]]--[[// ePhase = eMRT_MissionImpossible;
]]--[[/* ------------------------------------------------------------- */]]--[[/* ------- Fin Gestion erreur/ bon deroulement ------- */]]--[[/* ------------------------------------------------------------- */]]--[[//-----------------------------------------------------------------------------
]]--[[// ReconnaitreAxe (des itineraires)
]]--[[//-----------------------------------------------------------------------------
]]--[[//-----------------------------------------------------------------------------
]]--[[// ReconnaitreDesSitesROTA
]]--[[// MISSIONS ASSIGNEES DS CONDUITE
]]--[[//-----------------------------------------------------------------------------
]]--[[// ASSIGNEES DS CONDUITE
]]--[[//-----------------------------------------------------------------------------
]]--[[// ArmerUnSiteDeDecontamination 
]]--[[// Missions données dans la conduite
]]--[[//-----------------------------------------------------------------------------
]]--[[// ASSIGNEES DS CONDUITE, juste creation du site
]]--[[// HACK
]]--[[//-----------------------------------------------------------------------------
]]--[[// DecontaminerUneZone
]]--[[//-----------------------------------------------------------------------------
]]--[[//-----------------------------------------------------------------------------
]]--[[// ReconnaitreZone 
]]--[[//-----------------------------------------------------------------------------
]]--[[//-----------------------------------------------------------------------------
]]--[[// Mission impossible
]]--[[//-----------------------------------------------------------------------------
]]--[[//-----------------------------------------------------------------------------
]]--[[// 2) Validation MRT
]]--[[//-----------------------------------------------------------------------------
]]            local switch_1 = self.ePhase
                if switch_1 == eMRT_DeterminerEchelonsGlobals then
                    for _,x in pairs( selPions or emptyTable ) do
                    local _continue = true
do
                            local pion = x
                            if( F_Pion_GeteEtatDestruction( pion ) ~= eEtatDestruction_None ) then
                                do
                                    DEC_Trace( "Attention " .. DEC_GetSzName( pion ) .. " n'est pas opérationnel" )
                                    DIA_PushFront( self.selABC_NonPrevus, pion )
                                    _continue = false
                                end
                            end

                                if _continue then
                                 do
                                    local _continue = true
                                    local switch_2 = pion:GetType()
                                        if switch_2 == "Patrouille_NBC_Reco" then
                                            DIA_PushFront( self.selABC_NBC_Reco, pion )
                                            _continue = false
                                        elseif switch_2 == "Equipe_NBC_Dec" then
                                            DIA_PushFront( self.selABC_NBC_Dec, pion )
                                            _continue = false
                                        elseif switch_2 == "Patrouille_NBC_RE" then
                                            DIA_PushFront( self.selABC_NBC_RE, pion )
                                            _continue = false
                                        elseif switch_2 == "Patrouille_EI"
                                        or switch_2 == "Patrouille_EI_Milan" then
                                            DIA_PushFront( self.selABC_PEcl, pion )
                                            _continue = false
                                        elseif switch_2 == "Peloton_XL"
                                        or switch_2 == "Peloton_AMX" then
                                            DIA_PushFront( self.selABC_Blindes, pion )
                                            _continue = false
                                        elseif switch_2 == "SectionInfanterie"
                                        or switch_2 == "SectionInfanterie_HOT"
                                        or switch_2 == "SectionInfanterie_MILAN" then
                                            DIA_PushFront( self.selINF, pion )
                                            _continue = false
                                        
                                        else
                                            DIA_PushFront( self.selABC_NonPrevus, pion )
                                            _continue = false
                                                                                end
                                    end

                            end
                        end

                    end

                    self.ePhase = eMRT_AssignerMissions
                    _continue = false
                elseif switch_1 == eMRT_AssignerMissions then
                    if( self.eEtat == eActionImpossible ) then
                        do
                            DEC_Trace( "!!!!Mind out some first line units didn't receive mission!!!!" )
                            self.ePhase = eMRT_Valider
                                                        do return end

                        end
                    end

                    if( self.eEtat == eActionEffectuee ) then
                        do
                            self.ePhase = eMRT_Valider
                                                        do return end

                        end
                    end

                     do
                        local _continue = true
                        local switch_2 = self._namedParams.eType
                            if switch_2 == "T_Mission_Automate_NBC_ReconnaitreUnAxe" then
                                if( DIA_IsListEmpty( self.selABC_NBC_Reco ) ) then
                                    do
                                        DEC_Trace( "--- Pas de pions de reconnaissance ---" )
                                        self.ePhase = eMRT_MissionImpossible
                                    end
                                end

                                Activate( self.activations.BEH_Medo_Automate_ControleCreationMission, 1, { #( self.selABC_NBC_Reco ), } )
self.done_BEH_Medo_Automate_ControleCreationMission = function( self, _, v ) self.eEtat = v[1] end
                                Activate( self.activations.BEH_Medo_Automate_NBC_AssignerReconnaitreA, 1, { self.selABC_NBC_Reco, } )
                                _continue = false
                            elseif switch_2 == "T_Mission_Automate_NBC_ReconnaitreDesSitesROTA" then
                                if( DIA_IsListEmpty( self.selABC_NBC_RE ) ) then
                                    do
                                        DEC_Trace( "--- Pas de pions ROTA ---" )
                                        self.ePhase = eMRT_MissionImpossible
                                                                                do return end

                                    end
                                end

                                self.ePhase = eMRT_Valider
                                _continue = false
                            elseif switch_2 == "T_Mission_Automate_NBC_ArmerUnSiteDeDecontamination" then
                                if( DIA_IsListEmpty( self.selABC_NBC_Dec ) ) then
                                    do
                                        DEC_Trace( "--- Pas de pions de decontamination ---" )
                                        self.ePhase = eMRT_MissionImpossible
                                                                                do return end

                                    end
                                end

                                local mission = DEC_GetMission( myself )
                                local pointTemp = S_Geometrie_BarycentreZone( mission.site_ )
                                local siteDec = DEC_Geometrie_ConvertirPointEnLocalisation( pointTemp )
                                DEC_CreerObjetSansDelais( S_TypeObject_ToString( eTypeObjectSiteDecontamination ), siteDec )
                                self.ePhase = eMRT_Valider
                                _continue = false
                            elseif switch_2 == "T_Mission_Automate_NBC_DecontaminerUneZone" then
                                if( DIA_IsListEmpty( self.selABC_NBC_Dec ) ) then
                                    do
                                        DEC_Trace( "--- Pas de pions de reconnaissance ---" )
                                        self.ePhase = eMRT_MissionImpossible
                                    end
                                end

                                Activate( self.activations.BEH_Medo_Automate_ControleCreationMission, 1, { #( self.selABC_NBC_Dec ), } )
self.done_BEH_Medo_Automate_ControleCreationMission = function( self, _, v ) self.eEtat = v[1] end
                                Activate( self.activations.BEH_Medo_Automate_NBC_AssignerDecontaminerZoneA, 1, { self.selABC_NBC_Dec, } )
                                _continue = false
                            elseif switch_2 == "T_Mission_Automate_NBC_ReconnaitreUneZone" then
                                if( DIA_IsListEmpty( self.selABC_NBC_Reco ) ) then
                                    do
                                        DEC_Trace( "--- Pas de pions de reconnaissance ---" )
                                        self.ePhase = eMRT_MissionImpossible
                                    end
                                end

                                Activate( self.activations.BEH_Medo_Automate_ControleCreationMission, 1, { #( self.selABC_NBC_Reco ), } )
self.done_BEH_Medo_Automate_ControleCreationMission = function( self, _, v ) self.eEtat = v[1] end
                                Activate( self.activations.BEH_Medo_Automate_NBC_AssignerReconnaitreZoneA, 1, { self.selABC_NBC_Reco, } )
                                _continue = false
                                                        end
                        end

                    _continue = false
                elseif switch_1 == eMRT_MissionImpossible then
                    DEC_RC( eRC_MissionImpossible )
                                        self:SendFeedback( eActionImpossible )
                    Halt( self )
                    do return end

                                end
                if switch_1 == eMRT_Valider then
                    DEC_MRT_Valide()
                                        self:SendFeedback( eActionEffectuee )
                    Halt( self )
                    do return end

                
                else
                                end
            end

    end,

}

connections = connections or {}
connections[ #connections + 1 ] = { nodes.BEH_Medo_Automate_NBC_DonnerLesOrdresPourMission, "BEH_Medo_Automate_ControleCreationMission", nodes.BEH_Medo_Automate_ControleCreationMission }
connections[ #connections + 1 ] = { nodes.BEH_Medo_Automate_NBC_DonnerLesOrdresPourMission, "BEH_Medo_Automate_NBC_AssignerReconnaitreA", nodes.BEH_Medo_Automate_NBC_AssignerReconnaitreA }
connections[ #connections + 1 ] = { nodes.BEH_Medo_Automate_NBC_DonnerLesOrdresPourMission, "BEH_Medo_Automate_NBC_AssignerDecontaminerZoneA", nodes.BEH_Medo_Automate_NBC_AssignerDecontaminerZoneA }
connections[ #connections + 1 ] = { nodes.BEH_Medo_Automate_NBC_DonnerLesOrdresPourMission, "BEH_Medo_Automate_NBC_AssignerReconnaitreZoneA", nodes.BEH_Medo_Automate_NBC_AssignerReconnaitreZoneA }
