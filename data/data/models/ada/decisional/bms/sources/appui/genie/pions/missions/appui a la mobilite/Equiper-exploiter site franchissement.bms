includedFiles = includedFiles or {}
includedFiles["sources/appui/genie/pions/missions/appui a la mobilite/Equiper-exploiter site franchissement.bms"] = true

include "bit.lua"


--[[// *****************************************************************************
]]--[[// MIS_Pion_GEN_EquiperExploiterSiteFranchissement
]]--[[//
]]--[[// Commentaires: Refonte 27/10/2006
]]--[[//
]]--[[// *****************************************************************************
]]node "MIS_Pion_GEN_EquiperExploiterSiteFranchissement"
{
    activations =
    {
        { "BEH_Objet_Pion_GEN_EquiperExploiterPointFranchissement", {} },
    },

    create = function( self )
        self._namedParams = {}
        self._namedParams.mission = self.params.mission
    end,

    activate = function( self )
        --[[//-----------------------------------------------------------------
]]--[[// Init
]]--[[//-----------------------------------------------------------------
]]if( ModuleBegins() ) then
            do
                DEC_SetMission( myself, self._namedParams.mission )
                F_Pion_SeteEtatAmbiance( myself, eEtatAmbiance_Vitesse )
            end
--[[//-----------------------------------------------------------------
]]--[[// Validité de l'objet
]]--[[//-----------------------------------------------------------------
]]        end

        if( not DEC_ConnaissanceObjet_EstValide( self._namedParams.mission.siteFranchissement_ ) ) then
            do
                DEC_Warning( eRC_MissionImpossible )
                                Halt()

            end
--[[//-----------------------------------------------------------------
]]--[[// Comportement générique
]]--[[//-----------------------------------------------------------------
]]        end

        Activate( self.activations.BEH_Objet_Pion_GEN_EquiperExploiterPointFranchissement, 1, { self._namedParams.mission.siteFranchissement_, self._namedParams.mission.typePontage_, self._namedParams.mission.pointRegroupement_, } )
    end,

--[[// *****************************************************************************
]]--[[// BEH_Objet_Pion_GEN_EquiperExploiterPointFranchissement
]]--[[//
]]--[[// Commentaires:
]]--[[//
]]--[[// *****************************************************************************
]]}

node "BEH_Objet_Pion_GEN_EquiperExploiterPointFranchissement"
{
    activations =
    {
        { "ACT_Info_Trace", {} },
        { "ACT_Warning", {} },
        { "BEH_Ordre_Inopine", {} },
        { "ACT_MAJ_EtatPhaseMission", {} },
        { "BEH_Dep_ProgressionVers", {} },
        { "BEH_Objet_Pion_GEN_EquiperSite", {} },
        { "ACT_Objet_Pion_GEN_FaireFranchir", {} },
        { "BEH_Dep_SePosterFaceADirectionDangereuse", {} },
    },

    create = function( self )
        self._namedParams = {}
        self._namedParams.siteFranchissement = self.params[1]
        self._namedParams.type = self.params[2]
        self._namedParams.ptRegroupement = self.params[3]
    end,

    activate = function( self )
                self.ePhase = self.ePhase or ePreparerMission
        self.eEtat = self.eEtat or eActionEnCours
        self.ptObjet = self.ptObjet or nil
        self.genObs = self.genObs or DEC_CreerDIAThing( "T_GenObstacle_Local" )
        --[[//-----------------------------------------------------------------
]]--[[// Vérification de la validité du site (si il a été reconnu ou non)
]]--[[//-----------------------------------------------------------------
]]if( not DEC_ConnaissanceObjet_EstReconnu( self._namedParams.siteFranchissement ) ) then
            do
                Activate( self.activations.ACT_Info_Trace, 1, { "---- SITE NON RECONNU ---", } )
                Activate( self.activations.ACT_Warning, 1, { eRC_MissionImpossible, } )
                self.ePhase = eFinMission
                                return

            end
        end

        if( ModuleBegins() ) then
            do
                DEC_Trace( "------ MIS Equiper exploiter : Début -------" )
                --[[// Calcule position
]]self.ptObjet = DEC_Geometrie_CalculerPointProcheLocalisationDansFuseau( DEC_ConnaissanceObjet_Localisation( self._namedParams.siteFranchissement ) )
                if( ( self.ptObjet == 0 or self.ptObjet == nil ) ) then
                    do
                        DEC_Warning( eRC_MissionImpossibleZoneHorsFuseau )
                        self.ePhase = eFinMission
                                                return

                    end
--[[// Init 
]]                end

                if( self._namedParams.type == eFranchissement_Continu ) then
                    self.genObs:Settype_obstacle_( eTypeObjectPontFlottantContinu )
                else
                    self.genObs:Settype_obstacle_( eTypeObjectPontFlottantDiscontinu )
                end

                self.genObs:Setloc_obstacle_( DEC_ConnaissanceObjet_Localisation( self._namedParams.siteFranchissement ) )
            end
--[[//-----------------------------------------------------------------
]]--[[// Squelette de mission
]]--[[//-----------------------------------------------------------------
]]        end

        self.eEtatOrdreFinMission = self.eEtatOrdreFinMission or eActionEnCours
        Activate( self.activations.BEH_Ordre_Inopine, 1, setmetatable( {}, { __newindex = function( t, k, v ) if k == "__returnValue" then self.eEtatOrdreFinMission = v else rawset( t, k, v ) end end } ) )
        if( self.eEtatOrdreFinMission == eActionHalt ) then
            do
                self.ePhase = eFinMission
                self.eEtat = eActionEnCours
                self.eEtatOrdreFinMission = eActionEnCours
            end
        end

         do
            local switch_1 = self.ePhase
            local cases_switch_1 = {}
                if switch_1 == ePreparerMission then
                    --[[// Preparation de la mission
]]Activate( self.activations.ACT_MAJ_EtatPhaseMission, 1, { eEtatPhaseMission_DebutMission, } )
                    self.ePhase = eProgresser
                    
                --[[// Progression
]]                cases_switch_1[1] = true
elseif switch_1 == eProgresser then
                    Activate( self.activations.ACT_MAJ_EtatPhaseMission, 1, { eEtatPhaseMission_ProgressionVersLocalisation, } )
                    if( self.eEtat == eActionEffectuee ) then
                        do
                            self.eEtat = eActionEnCours
                                                        do
                                self.ePhase = eRealiserObstacle
                                                                return

                            end

                        end
                    end

                    Activate( self.activations.BEH_Dep_ProgressionVers, 1, setmetatable( { self.ptObjet, eProgressionReco, eTypeItiMouvement, }, { __newindex = function( t, k, v ) if k == "__returnValue" then self.eEtat = v else rawset( t, k, v ) end end } ) )
                    
                --[[// Realisation du "pont flottant" continu ou discontinu - vu de l'esprit
]]elseif switch_1 == eRealiserObstacle then
                    Activate( self.activations.ACT_MAJ_EtatPhaseMission, 1, { eEtatPhaseMission_ArriveSurLocalisation, } )
                    --[[// Réalisation du ou des ponts flottants
]]if( self.eEtat == eActionEffectuee ) then
                        do
                            self.eEtat = eActionEnCours
                                                        do
                                self.ePhase = eAttendre
                                                                return

                            end

                        end
                    end

                    Activate( self.activations.BEH_Objet_Pion_GEN_EquiperSite, 1, setmetatable( { self.genObs, }, { __newindex = function( t, k, v ) if k == "__returnValue" then self.eEtat = v else rawset( t, k, v ) end end } ) )
                    
                --[[// Le pion doit attendre que tous les autres soient passés pour quitter sa position !
]]elseif switch_1 == eAttendre then
                    Activate( self.activations.ACT_MAJ_EtatPhaseMission, 1, { eEtatPhaseMission_EnFranchissement, } )
                    Activate( self.activations.ACT_Objet_Pion_GEN_FaireFranchir, 1, {} )--[[// tj phase arrivee sur position
]]--[[// seulement RC pour l'instant
]]
                    
                --[[// Fin de la mission
]]                cases_switch_1[4] = true
elseif switch_1 == eFinMission then
                    StopActivate( self.activations.ACT_MAJ_EtatPhaseMission, { eEtatPhaseMission_ArriveSurLocalisation, } )
                    Activate( self.activations.ACT_MAJ_EtatPhaseMission, 1, { eEtatPhaseMission_FinMission, } )
                    --[[// Tomber en garde
]]if( self.eEtat == eActionEffectuee ) then
                        do
                            if( DEC_ConnaissanceObjet_EstValide( myself.objMisEnCours_ ) ) then
                                DEC_DetruireObjetSansDelais( myself.objMisEnCours_ )
                            end

                            Activate( self.activations.BEH_Dep_SePosterFaceADirectionDangereuse, 1, {} )
                                                        return

                        end
                    end

                    Activate( self.activations.BEH_Dep_ProgressionVers, 1, setmetatable( { self._namedParams.ptRegroupement, eProgressionReco, eTypeItiMouvement, }, { __newindex = function( t, k, v ) if k == "__returnValue" then self.eEtat = v else rawset( t, k, v ) end end } ) )
                    
                                end
            end

--[[// Cas où l'opérateur donne une mission au mission sans lui ordonner d'interrompre sa mission.
]]    end,

    destroy = function( self )
                if( DEC_ConnaissanceObjet_EstValide( myself.objMisEnCours_ ) ) then
            DEC_DetruireObjetSansDelais( myself.objMisEnCours_ )
        end

        DEC_DetruireDIAThing( self.genObs )
    end,

--[[// *****************************************************************************
]]--[[// BEH_Objet_Pion_GEN_EquiperSite
]]--[[//
]]--[[// Commentaires:
]]--[[//
]]--[[// *****************************************************************************
]]}

node "BEH_Objet_Pion_GEN_EquiperSite"
{
    instances =
    {
        max = 1,
    },

    activations =
    {
        { "ACT_RC", {} },
        { "ACT_Obj_Pion_GEN_RealiserSite", {} },
    },

    create = function( self )
        self._namedParams = {}
        self._namedParams.genObs = self.params[1]
    end,

    activate = function( self )
        self.eEtat = self.eEtat or eActionEnCours
        if( self.eEtat == eActionEffectuee ) then
            do
                self.eEtat = eActionEnCours
                                do
                                        self.params.__returnValue = eActionEffectuee
                    Halt()

                end

            end
--[[//-----------------------------------------------------------------
]]--[[// Organisation chantier, verification renfort, brechage et 
]]--[[// desorganisation chantier
]]--[[//-----------------------------------------------------------------
]]        end

        if( not DEC_Agent_PeutConstruireObjet( S_TypeObject_ToString( self._namedParams.genObs:Gettype_obstacle_() ) ) ) then
            do
                Activate( self.activations.ACT_RC, 1, { eRC_AttenteRenforcement, } )
                                return

            end
--[[// SINON OK pour construire l'objet
]]--[[//-----------------------------------------------------------------
]]--[[// En fonction du type d'objet...
]]--[[//-----------------------------------------------------------------
]]        end

        Activate( self.activations.ACT_Obj_Pion_GEN_RealiserSite, 1, setmetatable( { self._namedParams.genObs:Getloc_obstacle_(), self._namedParams.genObs:Gettype_obstacle_(), }, { __newindex = function( t, k, v ) if k == "__returnValue" then self.eEtat = v else rawset( t, k, v ) end end } ) )
    end,

--[[// ****************************************************************************
]]--[[// ACT_Obj_Pion_GEN_RealiserSite
]]--[[//
]]--[[// Commentaires:
]]--[[//
]]--[[// ****************************************************************************
]]}

node "ACT_Obj_Pion_GEN_RealiserSite"
{
    actuators =
    {
        obstacle = 1,
        deplacement = 1,
    },

    create = function( self )
        self._namedParams = {}
        self._namedParams.loc = self.params[1]
        self._namedParams.eTypeObjet = self.params[2]
    end,

    select = function( self )
        --[[//booleens suspension reprise et terminaison
]]        self.eActionObjet = self.eActionObjet or eActionObjetEnCours
        self.bSuspendu = self.bSuspendu or false
        self.bInit = self.bInit or true
        self.act = self.act or nil
        --[[//-----------------------------------------------------------------
]]--[[// Init
]]--[[//-----------------------------------------------------------------
]]if( ModuleBegins() ) then
            do
                if( not DEC_Agent_AutomateEstEmbraye() ) then
                    DEC_RC( eRC_OrganisationChantier )
                else
                    DEC_Message( eRC_OrganisationChantier )
                end

            end
--[[//-----------------------------------------------------------------
]]--[[// Début travaux
]]--[[//-----------------------------------------------------------------
]]        end

        if( self.bInit and DEC_Agent_NiveauInstallation() >= eNiveauInstallation_Poste ) then
            do
                self.act = DEC_StartCreerObjet( myself.objMisEnCours_, S_TypeObject_ToString( eTypeObjet ), self._namedParams.loc )
                actionCallbacks[ self.act ] = function( arg ) self.eActionObjet = arg end
                actionKnowledgeCallbacks[ self.act ] = function( arg ) myself.objMisEnCours_ = arg end

                                do
                    if( not DEC_Agent_AutomateEstEmbraye() ) then
                        DEC_RC( eRC_DebutTravaux )
                    else
                        DEC_Message( eRC_DebutTravaux )
                    end

                end

                self.bInit = false
            end
--[[//-----------------------------------------------------------------
]]--[[// RC éventuels
]]--[[//-----------------------------------------------------------------
]]        end

         do
            local switch_1 = self.eActionObjet
            local cases_switch_1 = {}
                if switch_1 == eActionObjetTerminee then
                    DEC_Trace( "  end of works " )
                    do
                        if( not DEC_Agent_AutomateEstEmbraye() ) then
                            DEC_RC( eRC_FinTravaux )
                        else
                            DEC_Message( eRC_FinTravaux )
                        end

                    end

                                        self.params.__returnValue = eActionEffectuee
                    return

                    
                elseif switch_1 == eActionObjetManqueDotation
                or switch_1 == eActionObjetPasDeCapacite
                or switch_1 == eActionObjetImpossible then
                    DEC_Trace( "  impossible works " )
                                        self.params.__returnValue = eActionEffectuee
                    return

                    
                                end
            end
--[[//-----------------------------------------------------------------
]]--[[// Reprise si suspendu
]]--[[//-----------------------------------------------------------------
]]
        if( self.bSuspendu and DEC_Agent_NiveauInstallation() >= eNiveauInstallation_Poste ) then
            do
                DEC_ReprendAction( self.act )
                self.bSuspendu = false
            end
        end

    end,

    deselect = function( self )
                DEC_PauseAction( self.act )
        self.bSuspendu = true
    end,

    destroy = function( self )
                self.act = DEC_StopAction( self.act )
    end,

}

--[[// *****************************************************************************
]]--[[// ACT_Objet_Pion_GEN_FaireFranchir
]]--[[//
]]--[[// Commentaires: Il faudrait rajouter ici la notion d'animation actif du site
]]--[[//
]]--[[// *****************************************************************************
]]node "ACT_Objet_Pion_GEN_FaireFranchir"
{
    create = function( self )
    end,

    select = function( self )
        --[[// ------------------------------------------------------------------------
]]--[[// Init
]]--[[// ------------------------------------------------------------------------
]]        if( ModuleBegins() ) then
            do
                if( not DEC_Agent_AutomateEstEmbraye() ) then
                    DEC_RC( eRC_DebutExploitationSiteFranchissement )
                else
                    DEC_Message( eRC_DebutExploitationSiteFranchissement )
                end

            end
        end

    end,

    deselect = function( self )
            end,

    destroy = function( self )
                do
            if( not DEC_Agent_AutomateEstEmbraye() ) then
                DEC_RC( eRC_FinExploitationSiteFranchissement )
            else
                DEC_Message( eRC_FinExploitationSiteFranchissement )
            end

        end

    end,

}

eventmanager_plugin = eventmanager_plugin or {}
eventmanager_plugin.MIS_Pion_GEN_EquiperExploiterSiteFranchissement = { "mission" }
connections = connections or {}
connections[ #connections + 1 ] = { nodes.BEH_Objet_Pion_GEN_EquiperExploiterPointFranchissement, "ACT_Info_Trace", nodes.ACT_Info_Trace }
connections[ #connections + 1 ] = { nodes.BEH_Objet_Pion_GEN_EquiperExploiterPointFranchissement, "ACT_Warning", nodes.ACT_Warning }
connections[ #connections + 1 ] = { nodes.BEH_Objet_Pion_GEN_EquiperExploiterPointFranchissement, "BEH_Ordre_Inopine", nodes.BEH_Ordre_Inopine }
connections[ #connections + 1 ] = { nodes.BEH_Objet_Pion_GEN_EquiperExploiterPointFranchissement, "ACT_MAJ_EtatPhaseMission", nodes.ACT_MAJ_EtatPhaseMission }
connections[ #connections + 1 ] = { nodes.BEH_Objet_Pion_GEN_EquiperExploiterPointFranchissement, "BEH_Dep_ProgressionVers", nodes.BEH_Dep_ProgressionVers }
connections[ #connections + 1 ] = { nodes.BEH_Objet_Pion_GEN_EquiperExploiterPointFranchissement, "BEH_Objet_Pion_GEN_EquiperSite", nodes.BEH_Objet_Pion_GEN_EquiperSite }
connections[ #connections + 1 ] = { nodes.BEH_Objet_Pion_GEN_EquiperExploiterPointFranchissement, "ACT_Objet_Pion_GEN_FaireFranchir", nodes.ACT_Objet_Pion_GEN_FaireFranchir }
connections[ #connections + 1 ] = { nodes.BEH_Objet_Pion_GEN_EquiperExploiterPointFranchissement, "BEH_Dep_SePosterFaceADirectionDangereuse", nodes.BEH_Dep_SePosterFaceADirectionDangereuse }
connections[ #connections + 1 ] = { nodes.BEH_Objet_Pion_GEN_EquiperSite, "ACT_RC", nodes.ACT_RC }
connections[ #connections + 1 ] = { nodes.BEH_Objet_Pion_GEN_EquiperSite, "ACT_Obj_Pion_GEN_RealiserSite", nodes.ACT_Obj_Pion_GEN_RealiserSite }
connections[ #connections + 1 ] = { nodes.MIS_Pion_GEN_EquiperExploiterSiteFranchissement, "BEH_Objet_Pion_GEN_EquiperExploiterPointFranchissement", nodes.BEH_Objet_Pion_GEN_EquiperExploiterPointFranchissement }
