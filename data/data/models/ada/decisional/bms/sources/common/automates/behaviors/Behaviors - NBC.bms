includedFiles = includedFiles or {}
includedFiles["sources/common/automates/behaviors/Behaviors - NBC.bms"] = true

--[[// *****************************************************************************
]]--[[//
]]--[[// $Created: MIA 04-05-25 $
]]--[[// $Archive: /MVW_v10/Build/Data/Data/Modeles/Sources/Common/Automates/Behaviors/Behaviors - NBC.hal $
]]--[[// $Author: Ggr $
]]--[[// $Modtime: 26/08/05 17:57 $
]]--[[// $Revision: 20 $
]]--[[// $Workfile: Behaviors - NBC.hal $
]]--[[//
]]--[[// *****************************************************************************
]]
--[[// *****************************************************************************
]]--[[// behavior BEH_Nbc_Automate_GererAlerteNiv4()
]]--[[//
]]--[[// Commentaires : la connaissance de "l'objet" nuage NBC étant connu
]]--[[//                par tout le camp, ce comportement sert à : gerer la 
]]--[[//                reception d'ordre inopinée de l'anibas de mettre la tenue NBC,
]]--[[//                + CR
]]--[[//
]]--[[// *****************************************************************************
]]node "BEH_Nbc_Automate_GererAlerteNiv4"
{
    activations =
    {
        { "BEH_Ordre_Automate_ConduiteSurAlerteNBC", { "onHalt" } },
        { "BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC", { "onHalt" } },
    },

    onHalt = OnHalt,

    feedbacks = { { { "onHalt" }, "BEH_Nbc_Automate_GererAlerteNiv4" } },

    create = function( self )
    end,

    activate = function( self )
        --[[//-----------------------------------------------------------------------------
]]--[[// Si l'unité PC a connaissance d'une zone contaminée, ou si contaminée
]]--[[// passer en ambiance NBC
]]--[[//-----------------------------------------------------------------------------
]]if( S_EstContamine() ) then
            do
                Activate( self.activations.BEH_Ordre_Automate_ConduiteSurAlerteNBC, 1, {} )
                                return

            end
--[[// Sinon on laisse la responsabilité aux comandement supérieur...
]]--[[//-----------------------------------------------------------------------------
]]--[[// Gestion de l'ordre de conduite
]]--[[//-----------------------------------------------------------------------------
]]        end

        Activate( self.activations.BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC, 1, {} )
    end,

--[[// *****************************************************************************
]]--[[// BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC()
]]--[[//
]]--[[// Commentaires :
]]--[[//                MIA: ATTENTION --> La gestion des ordres a été implémenté de cette manière
]]--[[//                (systeme start/stop ) pour gerer le fait de rajouter
]]--[[//                un pion en dynamique dans l'automate: celui passera en alerte
]]--[[//                de niveau 0 ou 4 suivant l'état de l'automate.
]]--[[//
]]--[[// *****************************************************************************
]]}

node "BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC"
{
    activations =
    {
        { "BEH_Ordre_Automate_ConduiteSurAlerteNBC", { "onHalt" } },
        { "BEH_Ordre_Automate_ConduiteSurFinAlerteNBC", { "onHalt" } },
        { "ACT_Ordre_Suppression", { "onHalt" } },
    },

    onHalt = OnHalt,

    feedbacks = { { { "onHalt" }, "BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC" } },

    create = function( self )
    end,

    activate = ActivateWithStart,

    internalactivate = function( self )
        --[[//-----------------------------------------------------------------------------
]]--[[// Recevoir un ordre
]]--[[//-----------------------------------------------------------------------------
]]local ordres_recus = DEC_GetCategory( "ordres_recus" )
        for _,x in pairs( ordres_recus ) do
        local _continue = true
do
                local repOrdre = x
                 do
                    local switch_1 = repOrdre:GetType()
                    local cases_switch_1 = {}
                        if switch_1 == "Rep_OrderConduite_MettreTenueNBC" then
                            DEC_Trace( "$ --- ORDRE Mettre tenue NBC ---$" )
                            StartInstance( self, self.activations.BEH_Ordre_Automate_ConduiteSurAlerteNBC, 1, {} )
                            StopInstance( self, self.activations.BEH_Ordre_Automate_ConduiteSurFinAlerteNBC, {} )
                            
                                                cases_switch_1[1] = true
elseif switch_1 == "Rep_OrderConduite_EnleverTenueNBC" then
                            DEC_Trace( "$ --- ORDRE Enlever tenue NBC ---$" )
                            StopInstance( self, self.activations.BEH_Ordre_Automate_ConduiteSurAlerteNBC, {} )
                            StartInstance( self, self.activations.BEH_Ordre_Automate_ConduiteSurFinAlerteNBC, 1, {} )
                            
                                                cases_switch_1[2] = true
                        end
                    end

                Activate( self.activations.ACT_Ordre_Suppression, 1, { x, } )
            end

        end

    end,

--[[// *****************************************************************************
]]--[[// BEH_Ordre_Automate_ConduiteSurAlerteNBC()
]]--[[//
]]--[[// Commentaires : on donne juste l'ordre au pion de se vetir de leur tenue NBC
]]--[[// 
]]--[[// *****************************************************************************
]]}

node "BEH_Ordre_Automate_ConduiteSurAlerteNBC"
{
    activations =
    {
        { "ACT_RC_Automate", { "onHalt" } },
        { "ACT_Ordre_MettreTenueNBC", { "onHalt" } },
    },

    onHalt = OnHalt,

    feedbacks = { { { "onHalt" }, "BEH_Ordre_Automate_ConduiteSurAlerteNBC" } },

    create = function( self )
    end,

    activate = function( self )
        --[[//-----------------------------------------------------------------------------
]]--[[// RC
]]--[[//-----------------------------------------------------------------------------
]]Activate( self.activations.ACT_RC_Automate, 1, { eRC_TenueProtectionNBCMise, } )
        --[[//-----------------------------------------------------------------------------
]]--[[// Donner l'ordre aux pions si embrayé
]]--[[//-----------------------------------------------------------------------------
]]local listePionsSubordonnes = myself:DEC_Automate_PionsAvecPC()
        for _,x in pairs( listePionsSubordonnes ) do
        local _continue = true
do
                local pion = x
                Activate( self.activations.ACT_Ordre_MettreTenueNBC, 1, { pion, } )
            end

        end

    end,

--[[// *****************************************************************************
]]--[[// BEH_Ordre_Automate_ConduiteSurFinAlerteNBC()
]]--[[//
]]--[[// Commentaires : on donne juste l'ordre au pion de se vetir de leur tenue NBC
]]--[[// 
]]--[[// *****************************************************************************
]]}

node "BEH_Ordre_Automate_ConduiteSurFinAlerteNBC"
{
    activations =
    {
        { "ACT_RC_Automate", { "onHalt" } },
        { "ACT_Ordre_EnleverTenueNBC", { "onHalt" } },
    },

    onHalt = OnHalt,

    feedbacks = { { { "onHalt" }, "BEH_Ordre_Automate_ConduiteSurFinAlerteNBC" } },

    create = function( self )
    end,

    activate = function( self )
        --[[//-----------------------------------------------------------------------------
]]--[[// RC
]]--[[//-----------------------------------------------------------------------------
]]Activate( self.activations.ACT_RC_Automate, 1, { eRC_TenueProtectionNBCEnlevee, } )
        --[[//-----------------------------------------------------------------------------
]]--[[// Donner l'ordre aux pions si embrayé
]]--[[//-----------------------------------------------------------------------------
]]local listePionsSubordonnes = DEC_Automate_PionsAvecPC()
        for _,x in pairs( listePionsSubordonnes ) do
        local _continue = true
do
                local pion = x
                Activate( self.activations.ACT_Ordre_EnleverTenueNBC, 1, { pion, } )
            end

        end

    end,

--[[// *****************************************************************************
]]--[[// ACT_Ordre_MettreTenueNBC
]]--[[//
]]--[[// Commentaires : on donne juste l'ordre au pion de se vetir de sa tenue NBC
]]--[[// 
]]--[[// *****************************************************************************
]]}

node "ACT_Ordre_MettreTenueNBC"
{
    feedbacks = { { { "onHalt" }, "ACT_Ordre_MettreTenueNBC" } },

    create = function( self )
        self._namedParams = {}
        self._namedParams.pion = self.params[1]
    end,

    select = function( self )
                if( ModuleBegins() ) then
            self._namedParams.pion:SetStateVariable( "VE_NiveauNBC", 4 )
        end

    end,

    deselect = function( self )
            end,

}

--[[// *****************************************************************************
]]--[[// ACT_Ordre_EnleverTenueNBC
]]--[[//
]]--[[// Commentaires : on donne juste l'ordre au pion de se devetir de sa tenue NBC
]]--[[// 
]]--[[// *****************************************************************************
]]node "ACT_Ordre_EnleverTenueNBC"
{
    feedbacks = { { { "onHalt" }, "ACT_Ordre_EnleverTenueNBC" } },

    create = function( self )
        self._namedParams = {}
        self._namedParams.pion = self.params[1]
    end,

    select = function( self )
                if( ModuleBegins() ) then
            self._namedParams.pion:SetStateVariable( "VE_NiveauNBC", 0 )
        end

    end,

    deselect = function( self )
            end,

}

connections = connections or {}
connections[ #connections + 1 ] = { nodes.BEH_Nbc_Automate_GererAlerteNiv4, "BEH_Ordre_Automate_ConduiteSurAlerteNBC", nodes.BEH_Ordre_Automate_ConduiteSurAlerteNBC }
connections[ #connections + 1 ] = { nodes.BEH_Nbc_Automate_GererAlerteNiv4, "BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC", nodes.BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC }
connections[ #connections + 1 ] = { nodes.BEH_Ordre_Automate_ConduiteSurAlerteNBC, "ACT_RC_Automate", nodes.ACT_RC_Automate }
connections[ #connections + 1 ] = { nodes.BEH_Ordre_Automate_ConduiteSurAlerteNBC, "ACT_Ordre_MettreTenueNBC", nodes.ACT_Ordre_MettreTenueNBC }
connections[ #connections + 1 ] = { nodes.BEH_Ordre_Automate_ConduiteSurFinAlerteNBC, "ACT_RC_Automate", nodes.ACT_RC_Automate }
connections[ #connections + 1 ] = { nodes.BEH_Ordre_Automate_ConduiteSurFinAlerteNBC, "ACT_Ordre_EnleverTenueNBC", nodes.ACT_Ordre_EnleverTenueNBC }
connections[ #connections + 1 ] = { nodes.BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC, "BEH_Ordre_Automate_ConduiteSurAlerteNBC", nodes.BEH_Ordre_Automate_ConduiteSurAlerteNBC }
connections[ #connections + 1 ] = { nodes.BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC, "BEH_Ordre_Automate_ConduiteSurFinAlerteNBC", nodes.BEH_Ordre_Automate_ConduiteSurFinAlerteNBC }
connections[ #connections + 1 ] = { nodes.BEH_Ordre_Automate_RecevoirOrdreSurAlerteNBC, "ACT_Ordre_Suppression", nodes.ACT_Ordre_Suppression }
