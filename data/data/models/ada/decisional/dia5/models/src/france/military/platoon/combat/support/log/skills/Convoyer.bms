rootnode {
connections = { skill.nodes.RC, skill.links.moveAlong },

done = function( self, params, additionalParams ) -- moveToward
    self.arrived = true
end,

create = function( self )
    self.arrived = false
    
    self.transporteur = CreateKnowledge( sword.military.world.PlatoonAlly, integration.getTransporter() )
    self.fluxTire = not integration.isLogSupplyPushFlow()
end,

 activate = function( self )
    local getFragOrder = integration.query.getFirstFragOrderFromType( "Rep_OrderConduite_PoursuivreConvoi" )
    self.ePhase = integration.getActionCouranteConvoi()
    -- Action de chargement
    if self.ePhase == eConvoyerAction_Load then
        self.arrived = false
        Activate(skill.nodes.RC, 1, { RC = eRC_Convoi_ChargementEnCours, } )
    -- Action de déchargement
    elseif self.ePhase == eConvoyerAction_Unload  then
        self.arrived = false
        Activate( skill.nodes.RC, 1, { RC = eRC_Convoi_DechargementEnCours, } )
    -- Action de déplacement vers le ravitailleur
    elseif self.ePhase == eConvoyerAction_MoveToSupplier then
        if self.MoveToSupplier or getFragOrder or F_Pion_GetpionEnEscorte( meKnowledge.source ) or not self.fluxTire  then
            self.MoveToSupplier = true
            Activate( skill.nodes.RC, 1, { RC = eRC_Convoi_DeplacementVersPointChargement, } )
            self.ravitailleur = CreateKnowledge( sword.military.world.PlatoonAlly, integration.getRavitailleur() )
            if not self.itineraryToSupplier then
                local itinerary = integration.getItineraireVersProchaineDestination()
                self.itineraryToSupplier = {}
                for _, pos in pairs( itinerary ) do
                  self.itineraryToSupplier[#self.itineraryToSupplier + 1] = CreateKnowledge( sword.military.world.Point, pos )
                end
                self.itineraryToSupplier[#self.itineraryToSupplier + 1] = self.ravitailleur:getMyPosition()
            end
            Activate( skill.links.moveAlong, 1, { entities = self.itineraryToSupplier, pathType = eTypeItiLogistique } )
            if( self.arrived ) then
                self.arrived = false
                integration.deplacementVersRavitailleurEffectue()
            end
         else
            Activate( skill.nodes.RC, 1, { RC = eRC_AttenteOrdrePoursuivreConvoiOuEscorte } )
         end
    -- Action de déplacement vers le destinataire du convoi
     elseif self.ePhase == eConvoyerAction_MoveToSupplyRecipient then
        if self.MoveToSupplyRecipient or getFragOrder then
            self.MoveToSupplyRecipient = true
            Activate( skill.nodes.RC, 1, { RC = eRC_Convoi_DeplacementVersPointDechargement, } )
            self.destinataireCourant = CreateKnowledge( sword.military.world.PlatoonAlly, integration.getDestinataireCourant() )
            if not self.itineraryToSupplyRecipient then
                local itinerary = integration.getItineraireVersProchaineDestination()
                self.itineraryToSupplyRecipient = {}
                for _, pos in pairs( itinerary ) do
                  self.itineraryToSupplyRecipient[#self.itineraryToSupplyRecipient + 1] = CreateKnowledge( sword.military.world.Point, pos )
                end
                self.itineraryToSupplyRecipient[#self.itineraryToSupplyRecipient + 1] = self.destinataireCourant:getMyPosition()
            end
            Activate( skill.links.moveAlong, 1, { entities = self.itineraryToSupplyRecipient, pathType = eTypeItiLogistique } )
            if( self.arrived ) then
                self.arrived = false
                integration.deplacementVersDestinataireEffectue()
            end
         else
            Activate( skill.nodes.RC, 1, { RC = eRC_AttenteOrdrePoursuivreConvoi } )
         end
    -- Action de déplacement vers le transporteur qui a prêté les véhicules
     elseif self.ePhase == eConvoyerAction_MoveToTransportersProvider then
        if self.MoveToTransportersProvider or getFragOrder or F_Pion_GetpionEnEscorte( meKnowledge.source ) or self.fluxTire then
            self.MoveToTransportersProvider = true
            Activate( skill.nodes.RC, 1, { RC = eRC_Convoi_Retour, } )
            if not self.itineraryToTransportersProvider then
                local itinerary = integration.getItineraireVersProchaineDestination()
                self.itineraryToTransportersProvider = {}
                for _, pos in pairs( itinerary ) do
                  self.itineraryToTransportersProvider[#self.itineraryToTransportersProvider + 1] = CreateKnowledge( sword.military.world.Point, pos )
                end
                self.itineraryToTransportersProvider[#self.itineraryToTransportersProvider + 1] = self.transporteur:getMyPosition()
            end
            Activate( skill.links.moveAlong, 1, { entities = self.itineraryToTransportersProvider, pathType = eTypeItiLogistique } )
            if( self.arrived ) then
                self.arrived = false
                integration.deplacementVersTransporteurEffectue()
            end
         else
            Activate( skill.nodes.RC, 1, { RC = eRC_AttenteOrdrePoursuivreConvoiOuEscorte } )
         end
     end
 end,
 
 destroy = function( self )
    integration.finMissionConvoi()
 end,
}

-- noeud permettant de renvoyer un compte rendu
node "RC"
{
    create = function( self )
        meKnowledge:RC( self.params.RC )
    end,
}
