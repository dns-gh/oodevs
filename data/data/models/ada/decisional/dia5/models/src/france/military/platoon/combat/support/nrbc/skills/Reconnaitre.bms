-- ****************************************************************************
-- Reconnoiter elements.
-- self.params.entities: the reconnoitrable elements
-- self.params.positions: the reconnoitring elements
-- ****************************************************************************
rootnode
{
    connections = { skill.links.moveAndTakePosition, skill.nodes.ReconnoitreNBC  },

    done = function( self, params )
        if self.moveToCenter then
            self.recoNBC = true
        else
            self.nextTargetIndex = self.nextTargetIndex + 1
            if self.nextTargetIndex >= #self.unreconnoitredElements then
                self.moveToCenter = true
            end
        end
    end,

    -- --------------------------------------------------------------------------------
    -- Store each elements to reconnoiter for feedbacks
    -- --------------------------------------------------------------------------------
    create = function( self )
        self.unreconnoitredElements = {}
        local positionsSim = self.params.area:getPerimeterPositions()
        local positions = {}
        for i = 1, #positionsSim do
           positions[#positions + 1] = CreateKnowledge( sword.military.world.Point, positionsSim[i] )
        end
        local idRotation = 1
        local distance = integration.distance(positions[1], meKnowledge)
        for i = 2, #positions do
            if distance > integration.distance(positions[i], meKnowledge) then
                distance = integration.distance(positions[i], meKnowledge)
                idRotation = i
            end
        end
        
        -- Sort the list of positions
        for i= idRotation, #positions do
            self.unreconnoitredElements[#self.unreconnoitredElements + 1] = positions[i]
        end
        for i= 1, idRotation do
            self.unreconnoitredElements[#self.unreconnoitredElements + 1] = positions[i]
        end
        self.nextTargetIndex = 1
    end,

    -- --------------------------------------------------------------------------------
    -- For each objective of the skill, reconnoiter it.
    -- --------------------------------------------------------------------------------
    activate = function( self )
        local Activate = Activate
        if self.moveToCenter then
            Activate( skill.nodes.ReconnoitreNBC, 1, { target = self.params.area } )
            Activate( skill.links.moveAndTakePosition, 1,
                     { entity = self.params.area,  pathType = eTypeItiNBC } )
            if self.params.area:isRecoNBC() then
                 Feedback( self.feedbacks.done )
            end
        else
            Activate( skill.links.moveAndTakePosition, 1,
                     { entity = self.unreconnoitredElements[self.nextTargetIndex],  pathType = eTypeItiNBC } )
        end
    end
}

node "ReconnoitreNBC"
{
    select = function( self )
       self.params.target:RecoNBC()
    end
}
