-- ****************************************************************************
-- Reconnoiter elements.
-- self.params.objectives: the reconnoitrable elements
-- self.params.positions: the reconnoitring elements
-- ****************************************************************************
rootnode
{
    connections = { skill.nodes.ScoutElement },

    done = function( self )
       self.nextTargetIndex = self.nextTargetIndex + 1
    end,
    
    scouted = function( self, params, additionalParams )
        self.nextTargetIndex = self.nextTargetIndex + 1
        if self.nextTargetIndex > #self.params.objectives then
            Feedback( self.feedbacks.done )
        end
    end,

    create = function( self )
        self.nextTargetIndex = 1
    end,

    activate = function( self )
        Activate( skill.nodes.ScoutElement, 1, { entity  = self.params.objectives[ self.nextTargetIndex ],
                                                 positions = self.params.objectives[ self.nextTargetIndex ]:getPositionsToReconnoiter() } )
    end
}

node "ScoutElement"
{
    connections = {skill.links.moveToward, skill.links.observe,
                   skill.nodes.Scout },

    feedbacks = { "scouted" },

    -- -------------------------------------------------------------------------------- 
    -- Feedbacks
    -- --------------------------------------------------------------------------------
    done = function( self )-- from moveAndTakePosition
        self.movementDone = true
    end,

    -- -------------------------------------------------------------------------------- 
    -- Init
    -- --------------------------------------------------------------------------------
    create  = function( self )
        self.movementDone = false
    end,

    -- --------------------------------------------------------------------------------
    -- Move toward a reconnoitering element and recconnoiter the entity
    -- --------------------------------------------------------------------------------
    activate = function( self )
        local Activate = Activate
        -- Feedback is sent only if element is recongized and if movement is done
        -- toward the reconnoitring position.
        if self.params.entity:isReconnoitred() and self.movementDone then
            Feedback( self.feedbacks.scouted, { element = self.params.entity } )
        end

        -- Main oservation effort on the entity
        Activate( skill.links.observe, 1, { entity = self.params.entity } )

        -- when it possible reconnoiter the element.
        if self.params.entity:canReconnoitreIt() then
            Activate( skill.nodes.Scout, 1, { target = self.params.entity } )
        end
        for _, position in pairs( self.params.positions ) do
            Activate( skill.links.moveToward,
                position:reconnaissanceEfficiency( self.params.entity ), { entities = { position },
                                                                           infiltrationMode = true } )
        end
        self.movementDone = false
    end
}

-- ****************************************************************************
-- Scout action
-- ****************************************************************************
node "Scout"
{
    select = function( self )
       self.params.target:reconnoitreIt( true )
    end
}
