rootnode 
{
    connections = { skill.links.engage },
    
    done = function( self ) Feedback( self.feedbacks.done ) end,
    
    create = function( self )
    end,
    
    activate = function( self )
        local Activate = Activate
        local res = {}
        local entities = {}
        if next( myself.enemyToEngage[1] ) then
            for i, j in pairs( myself.enemyToEngage[2] ) do
                if not j:isValid() then
                    removeFromList( j, myself.enemyToEngage[2] )
                    removeFromList( myself.enemyToEngage[1][i], myself.enemyToEngage[1] )
                end
            end
        end

        -- self.enemies = sword.military.queries.enemies.getEnemiesEngagingFriends[ "execute" ](  )

        for _, entity in pairs( self.params.friends ) do
            res = {}
            entities = {}
            if masalife.brain.core.class.isOfType( entity, sword.military.world.Company ) then -- on peut appuyer des automates alliés
                local entitiesFromAutomat = integration.filterPionWithEchelon( integration.getEntitiesFromAutomatCommunication( entity, "none", true), eEtatEchelon_First )
                for j = 1, #entitiesFromAutomat do
                    entities[#entities + 1] = entitiesFromAutomat[j]
                end
            else -- on peut appuyer des unités alliés
                entities[#entities + 1] = entity
            end
            for k = 1, #entities do
                res = DEC_Connaissances_UnitesPrenantAPartieSurAmi( entities[k].source )
                for _, i in pairs( res ) do
                    if not exists( myself.enemyToEngage[1], i ) then
                        myself.enemyToEngage[2][ #myself.enemyToEngage[2] + 1 ] = CreateKnowledge( sword.military.world.Platoon, i )
                        myself.enemyToEngage[1][ #myself.enemyToEngage[1] + 1 ] = i
                    end
                end
            end
        end
        --DEC_Trace( "nombre d'enis vs my friends : " .. tostring( #myself.enemyToEngage[2] ) )
        Activate( skill.links.engage, 1, { entities = myself.enemyToEngage[2] } )
    end,
}
