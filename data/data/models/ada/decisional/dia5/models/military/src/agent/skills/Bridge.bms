-- **************************************************************************** 
-- Bridge: to contruct a bridge on a crossing site object.
--
-- ****************************************************************************
rootnode
{
    connections = { skill.links.moveToward, skill.nodes.Bridge, skill.nodes.RC },

    -- -------------------------------------------------------------------------------- 
    -- Feeback and slots
    -- --------------------------------------------------------------------------------
    done = function( self )
        self.arrived = true
    end,

    equiped = function( self )
        meKnowledge:sendStopNeededReinforcement( integration.GetSuperiorKnowledge( meKnowledge ), meKnowledge)
        Feedback( self.feedbacks.done )
        self.bridgeBuilt = true
    end,

    -- -------------------------------------------------------------------------------- 
    -- Init
    -- --------------------------------------------------------------------------------
    create = function( self )
        self.arrived = false
        self.bridgeBuilt = false
        if self.params.typePontage == 0 then
            self.typePont = eTypeObjectContinuousPontoonBridge
        else
            self.typePont = eTypeObjectDiscontinuousPontoonBridge
        end
    end,

    -- -------------------------------------------------------------------------------- 
    -- Init
    -- --------------------------------------------------------------------------------
    activate = function( self )
        -- lua optim
        local Activate = Activate
        local CreateKnowledge = CreateKnowledge
        local emptyTable = emptyTable

        if not self.params.crossingSite:isReconnoitred() then
            Activate( skill.nodes.RC, 1, { RC = eRC_CrossingSiteNotRecon } )
            return
        end
        if self.arrived and not self.bridgeBuilt then
            Activate( skill.nodes.Bridge, 1, { crossingSite = self.params.crossingSite, typePont = self.typePont } )
        end
        local positions = self.params.crossingSite:getPositions()
        local positionsKn = {}
        for i = 1, #positions do
            positionsKn[ #positionsKn + 1 ] = CreateKnowledge( world.Point, positions[ i ] ) -- $$$ MIA: to move in integration
        end

        -- Moving to position
        Activate( skill.links.moveToward, 1, { entities = positionsKn } )
        self.arrived = false
    end,

    destroy = function( self )
        self.params.crossingSite:unEquipIt()
    end,
}

-- **************************************************************************** 
-- Bridge: to contruct a bridge on a crossing site object.
--
-- ****************************************************************************
node "Bridge"
{
    connections = { skill.nodes.RC },

    feedbacks = { "equiped" },

    -- -------------------------------------------------------------------------------- 
    -- Equip crossing site with a bridge
    -- --------------------------------------------------------------------------------
    activate = function( self )
        if not self.params.crossingSite:canEquipIt( self.params.typePont ) then
            integration.setNeedReinforcement( meKnowledge, "build", self.params.crossingSite, false )
            Activate( skill.nodes.RC, 1, { RC = eRC_ConstructionObjetImpossible } )
            return
        end
        if self.params.crossingSite:equipIt( self.params.typePont ) then
            Feedback( self.feedbacks.equiped )
        end
    end,
}
node "RC"
{
    create = function( self )
        meKnowledge:RC( self.params.RC )
    end,
}