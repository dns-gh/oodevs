<?xml version="1.0" encoding="UTF-8"?>
<task xmlns="http://www.masagroup.net/directia/schemas/bm" name="agent.tasks.Defend" source-version="1.0.0" knowledge-class="agent.tasks.knowledges.Defend">
    <description>For the agent, to take positions on the objetives and engage all enemies in range (objectives must be a set of &quot;destroying position&quot; from which the agent is able to fire at approaching enemies). </description>
    <parameters>
        <parameter name="objectives">
            <description>The objective to defend.</description>
            <type>
                <list>
                    <class name="properties.Destroying"/>
                </list>
            </type>
        </parameter>
        <parameter name="obstacles" nullable="true">
            <description>The set of planned obstacles to errect. This parameter is optional. If not issued, an empty list is given to the skill and the task switchts from the first stage to the second one (the defense of the objectives).</description>
            <type>
                <list>
                    <class name="world.EngineerObject"/>
                </list>
            </type>
            <default>
                <nil/>
            </default>
        </parameter>
        <parameter name="withImprovement">
            <description>Define if the agent needs to emprove errected obstacles.</description>
            <type>
                <simple name="boolean"/>
            </type>
            <default>
                <boolean>false</boolean>
            </default>
        </parameter>
    </parameters>
    <goal>
        <description>Reach the positions and engage enemies around the objective.</description>
    </goal>
    <let name="enemiesAround">
        <value>
            <call method="queries.getEnemiesInRange">
                <parameter name="probabilityToHit">
                    <value>
                        <number>0.5</number>
                    </value>
                </parameter>
            </call>
        </value>
    </let>
    <stages>
        <stage label="moving toward planned obstacles">
            <description>This is a preliminary stage to the main effect of the mission. The agent moves to planned obstacles locations to improve terrain in order to make the defense more efficient. If no obstacles is issued by user, an empty list is issued to the skill that returns &quot;done&quot; in order to switch to the next stage.</description>
            <goal>
                <description>Improving the terrain by errecting obstacles.</description>
            </goal>
            <skills>
                <skill name="agent.skills.BuildWithoutReinforcement" main="true">
                    <parameter name="entities">
                        <value>
                            <parameter>obstacles</parameter>
                        </value>
                    </parameter>
                    <parameter name="withImprovement">
                        <value>
                            <parameter>withImprovement</parameter>
                        </value>
                    </parameter>
                </skill>
            </skills>
        </stage>
        <stage label="deployment on objectives" permanent="true" disable-when-done="false">
            <description>Defense of the objectives.</description>
            <goal>
                <description>Occupying the objectives in order to engage approaching enemies.</description>
            </goal>
            <skills>
                <skill name="agent.skills.MoveToward" priority="0.1">
                    <parameter name="entities">
                        <value>
                            <parameter>objectives</parameter>
                        </value>
                    </parameter>
                </skill>
                <skill name="agent.skills.Engage" priority="0.9">
                    <parameter name="entities">
                        <value>
                            <parameter>enemiesAround</parameter>
                        </value>
                    </parameter>
                    <parameter name="positions">
                        <value>
                            <parameter>objectives</parameter>
                        </value>
                    </parameter>
                </skill>
            </skills>
        </stage>
    </stages>
</task>