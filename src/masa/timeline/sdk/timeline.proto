// ****************************************************************************
//
// This file is part of a MASA library or program.
// Refer to the included end-user license agreement for restrictions.
//
// Copyright (c) 2013 MASA Group
//
// ****************************************************************************
package sdk;

/*
 * UUID are specified as per RFC4122 (ex: "550e8400-e29b-41d4-a716-446655440000")
 * Timestamps are specified as per RFC3339 (ex: "2006-01-02T15:04:05Z07:00")
 * Time durations are in milliseconds and can be negative when used as an offset
 * Error codes are HTTP status codes as per RFC2616 (ex: 404 Not Found)
 */

message Timer
{
    optional string base = 1;
}

message Sword
{
    required string address    = 1;
    required bool   has_replay = 2;
}

message External
{
    required string source = 1;
}

message Service
{
    required string   name     = 1;
    required bool     clock    = 2; ///< true to use service's clock
    optional Timer    timer    = 3;
    optional Sword    sword    = 4;
    optional External external = 5;
}

message Session
{
    enum Status
    {
        IDLE     = 0; ///< edition mode
        STARTING = 1; ///< transient state from idle to live
        LIVE     = 2; ///< live mode, clock is on and events are run
        STOPPING = 3; ///< transient state from live to idle
    }
    required string uuid         = 1; ///< unique uuid
    required Status status       = 2; ///< current status
    required string name         = 3;
    optional string time         = 4; ///< current time
    optional string start_time   = 5; ///< start exercise time
    optional string end_time     = 6; ///< end exercise time
    optional bool   locked       = 7; ///< true if time is locked
    optional int64  offset       = 8; ///< optional time offset applied on time
    required int32  num_services = 9;
    required int32  num_events   = 10;
}

message Action
{
    required string target  = 1;
    optional bool   apply   = 2; ///< should the action be applied ?
    optional bytes  payload = 4;
}

message Event
{
    optional string uuid       = 1;
    optional string name       = 2;
    optional string info       = 3;
    optional string begin      = 4;
    optional string end        = 5;
    optional Action action     = 6;
    optional bool   done       = 7;
    optional int32  error_code = 8;
    optional string error_text = 9;
    optional bool   read_only  = 10;
    optional string parent     = 11;
    optional string metadata   = 12;
}

enum MessageTag
{
    update_tick     = 1; ///< DEPRECATED
    update_events   = 2;
    delete_events   = 3;
    update_services = 4;
    update_session  = 5;
    trigger_events  = 6;
}

// Message applies to one session
message Message
{
    required MessageTag tag      = 1;
    optional string     tick     = 2; ///< DEPRECATED
    repeated Event      events   = 3;
    repeated string     uuids    = 4;
    repeated Service    services = 5;
    optional Session    session  = 6; ///< sent only on time, start_time and end_time updates
}

message Metadata
{
    optional uint32 sword_entity = 1;
}

message CloseEvent
{
    optional bool   done       = 1;
    optional int32  error_code = 2;
    optional string error_text = 3;
    optional bool   lock       = 4;
}
