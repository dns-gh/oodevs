<project name="sword-proto" default="all">

    <property environment="env"/>
    <property name="env.PONEY_HOME" value="//file1/masa/common/dev/common/poney"/>
    <import file="${env.PONEY_HOME}/poney.xml"/>

    <target name="update">
        <update name="python"/>
    </target>

    <macrodef name="compare-proto">
        <attribute name="olddir"/>
        <attribute name="newdir"/>
        <sequential>
            <python taskname="protolint" failonerror="true">
                <arg value="${src.dir}/protolint/protolint.py"/>
                <arg value="compare"/>
                <arg value="@{olddir}"/>
                <arg value="@{newdir}"/>
            </python>
        </sequential>
    </macrodef>

    <target name="unit-test">
        <python failonerror="true">
            <arg value="${src.dir}/protolint/protolexer.py"/>
        </python>
        <python failonerror="true">
            <arg value="${src.dir}/protolint/protoparser.py"/>
        </python>
    </target>

    <target name="check-proto">
        <compare-proto olddir="${data.dir}/proto-5.0.0" newdir="${data.dir}/proto-5.0.1"/>
        <compare-proto olddir="${data.dir}/proto-5.0.1" newdir="${data.dir}/proto-5.0.2"/>
        <!-- 5.1.0 was breaking compatibility with 5.0 line and was superseded
             by 5.1.1 which fixed the issue. Ignore it.
        -->
        <compare-proto olddir="${data.dir}/proto-5.0.2" newdir="${data.dir}/proto-5.1.1"/>
        <compare-proto olddir="${data.dir}/proto-5.1.1" newdir="${data.dir}/proto-5.1.2"/>
        <compare-proto olddir="${data.dir}/proto-5.1.2" newdir="${data.dir}/proto-5.1.3"/>
    </target>

    <target name="package">
        <safe-move file="${out.dir}/sword-protobuf.zip">
            <zip destfile="@{file}" duplicate="fail">
                <fileset dir="${src.dir}" includes="protolint/**.py"/>
                <zipfileset dir="${data.dir}" prefix="protolint/proto/"/>
            </zip>
        </safe-move>
    </target>

    <target name="test" depends="unit-test,check-proto"/>

    <target name="all" depends="update,test,package"/>
</project>
