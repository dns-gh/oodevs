<?xml version="1.0"?>
<project name="scipio" default="all">

    <property name="include.dir"      location="../include"/>
    <property name="lib.dir"          location="../lib"/>
    <property name="reports.dir"      location="../reports"/>
    <property name="libraries.dir"    location="../src/libraries"/>
    <property name="applications.dir" location="../src/applications"/>
    <property name="tests.dir"        location="../src/tests"/>
    <property name="run.dir"          location="../run"/>
    <property name="dist.dir"         location="../dist"/>
    <property name="bin.dir"          location="../bin"/>
    <property name="data.dir"         location="../data"/>
    <property name="repositories"     value="\\install\Masa\common\dev\delivery\external,\\install\Masa\common\dev\delivery\internal,\\install\masa\simulation\projects\common"/>

    <property name="compiler" value="msvc"/>

    <import file="tools.xml"/>

    <!--
    ============================================================================
      libraries
    ============================================================================
    -->
    <target name="libraries" description="build static library">
        <!--build-lib name="TIC">
            <includepath path="${libraries.dir}/TIC"/>
            <includepath path="${include.dir}/ASN"/>
        </build-lib>

        <build-lib name="TIC_Export">
            <includepath path="${libraries.dir}/TIC"/>
            <includepath path="${libraries.dir}/TIC_Export"/>
            <includepath path="${include.dir}/ASN"/>
        </build-lib-->

        <build-lib name="MT_Tools_Scipio" input="MT_Tools" pch="MT_Tools_pch"/>
        <build-lib name="TER"/>
        <build-lib name="ASN">
            <includepath path="${include.dir}/ASN"/>
            <compilerarg value="/W3"/>
        </build-lib>

        <build-lib name="MIL">
            <includepath path="${libraries.dir}/MIL"/>
            <includepath path="${include.dir}/ASN"/>
        </build-lib>

        <build-lib name="Missions" excludes="**/MIL_*">
            <includepath path="${libraries.dir}/MIL"/>
            <includepath path="${include.dir}/ASN"/>
        </build-lib>

        <build-lib name="GFX">
            <includepath path="${include.dir}/qt"/>
        </build-lib>

        <build-lib name="ENT">
            <includepath path="${include.dir}/qt"/>
        </build-lib>
    </target>

    <!--
    ============================================================================
     applications
    ============================================================================
    -->
    <target name="applications" depends="" description="build executables">
        <!--build-app name="TIC_Sample"
                   subsystem="console"
                   libs="NEK,DIN,DIN_ConnectionService,DIN_MessageService,
                         MT_Tools,MT_IO,MT_Logger,MT_Archive,MT_XmlTools,
                         pathfind,geocoord,
                         TIC_Export,ASN,
                         boost_thread-vc71-mt-1_32,
                         asn1per,xerces-c_2">
            <includepath path="${include.dir}/ASN"/>
        </build-app>

        <build-app name="TIC_XmlExporter"
                   subsystem="console"
                   libs="NEK,DIN,DIN_ConnectionService,DIN_MessageService,
                         MT_Tools,MT_IO,MT_Logger,MT_Archive,MT_XmlTools,
                         pathfind,geocoord,
                         TIC_Export,ASN,
                         boost_thread-vc71-mt-1_32,
                         asn1per,xerces-c_2">
            <includepath path="${include.dir}/ASN"/>
        </build-app-->

        <build-app name="SIM"
                   subsystem="console"
                   libs="NEK,DIN,DIN_ConnectionService,DIN_MessageService,
                         MT_Tools,MT_IO,MT_Patterns,MT_Memory,MT_Logger,MT_Thread,MT_Time,MT_Archive,MT_XmlTools,
                         DIA_Motivation,DIA_Representation,DIA_SDK_Manager,DIA_Tool_Archive,DIA_Tool_Debugger,DIA_Tool_DebugInfoGen,DIA_Tool_Scripts,DIA_ToolManager,DIA_Behavior,DIA_Kernel,
                         tools,HLA,libFedTime,pathfind,geocoord,
                         MT_Tools_Scipio,TER,ASN,MIL,Missions,
                         boost_thread-vc71-mt-1_32,libboost_serialization-vc71-mt-1_32,libboost_filesystem-vc71-mt-1_32,
                         asn1per,xerces-c_2">
			      <syslibset libs="advapi32,user32,wsock32,winmm,dbghelp"/>
            <includepath path="${libraries.dir}/MIL"/>
            <includepath path="${include.dir}/ASN"/>
            <defineset define="_WIN32_WINNT=0x0400"/> <!-- for 'IsDebuggerPresent()' -->
            <linkerarg value="/STACK:15000000"/>      <!-- Because of boost serialization -->
            <linkerarg value="/LARGEADDRESSAWARE"/>   <!-- Executable can access 3GiB instead of 2GiB -->
        </build-app>

        <build-app name="ADN"
                   subsystem="gui"
                   libs="MT_Tools,MT_IO,MT_Patterns,MT_Memory,MT_Logger,MT_Thread,MT_Time,MT_Archive,MT_XmlTools,MT_Qt,
                         MT_Tools_SCIPIO,ENT,
                         qtmain,qt-mt333,xerces-c_2">
            <syslibset libs="advapi32,user32"/>
        </build-app>

        <build-app name="MOS_Light"
                   subsystem="gui"
                   libs="MT_Tools,MT_IO,MT_Patterns,MT_Memory,MT_Logger,MT_Thread,MT_Time,MT_Archive,MT_XmlTools,MT_Qt,
                         NEK,DIN,DIN_ConnectionService,DIN_MessageService,
                         MT_Tools_SCIPIO,ASN,GFX,
                         geocoord,graphics,pathfind,terrain,
                         asn1per,qtmain,qt-mt333,xerces-c_2">
            <includepath path="${include.dir}/ASN"/>
            <syslibset libs="gdi32,user32,wsock32,winmm,opengl32"/>
            <defineset define="MOS_USE_INLINE"/>
        </build-app>

        <!-- A corriger excludes="**/MOS_**_Gen.*" -->
        <build-app name="MOS_Light2"
                   subsystem="gui"
                   excludes="**/font/*,**/MOS_**_Gen.*"
                   libs="MT_Tools,MT_IO,MT_Patterns,MT_Memory,MT_Logger,MT_Thread,MT_Time,MT_Archive,MT_XmlTools,MT_Qt,
                         NEK,DIN,DIN_ConnectionService,DIN_MessageService,
                         MT_Tools_SCIPIO,ASN,GFX,ENT,
                         geocoord,graphics,pathfind,terrain,
                         asn1per,qtmain,qt-mt333,xerces-c_2">
            <includepath path="${include.dir}/ASN"/>
            <syslibset libs="gdi32,user32,wsock32,winmm,opengl32,glu32,shell32"/>
        </build-app>

        <build-app name="Tester" 
                   subsystem="console"
                   libs="MT_Tools,MT_IO,MT_Patterns,MT_Memory,MT_Logger,MT_Thread,MT_Time,MT_Archive,MT_XmlTools,MT_Qt,
                         NEK,DIN,DIN_ConnectionService,DIN_MessageService,
                         MT_Tools_SCIPIO,ASN,
                         asn1per,xerces-c_2">
            <includepath path="${include.dir}/ASN"/>		            
            <syslibset libs="gdi32,user32,wsock32,winmm"/>
        </build-app>               
        
        <build-app name="HLA_Manager" 
                   subsystem="gui"
                   libs="MT_Tools,MT_IO,MT_Archive,MT_XmlTools,
                         HLA,libfedtime,
                         MIL,
                         qtmain,qt-mt333,xerces-c_2">
            <syslibset libs="wsock32"/>
        </build-app>

        <build-app name="AGR"
                   subsystem="console"
                   excludes="**/*_Skeleton.*"
                   libs="MT_Tools,MT_IO,MT_Archive,MT_XmlTools,
                         libboost_filesystem-vc71-mt-1_32,xerces-c_2">
            <syslibset libs="user32"/>
        </build-app>

        <build-app name="LAU"
                   subsystem="console"
                   excludes="TerminateApp.c"
                   libs="NEK,DIN,DIN_ConnectionService,DIN_MessageService,
                         MT_Tools,MT_IO,MT_Archive,MT_XmlTools,MT_Logger,MT_Thread,MT_Time,MT_Archive,MT_XmlTools,
                         MT_Tools_Scipio,ASN,
                         asn1per,xerces-c_2">
            <includepath path="${include.dir}/ASN"/>
            <syslibset libs="ole32,advapi32,user32,wsock32,winmm"/>
        </build-app>

        <build-app name="LAU_Mos_Part"
                   subsystem="gui"
                   libs="NEK,DIN,DIN_ConnectionService,DIN_MessageService,
                         MT_Tools,MT_IO,MT_Archive,MT_XmlTools,MT_Logger,MT_Thread,MT_Time,
                         ASN,
                         asn1per,qtmain,qt-mt333"
                   pch="LAM_pch">
            <syslibset libs="user32,wsock32,winmm"/>
            <includepath path="${include.dir}/ASN"/>
        </build-app>

        <build-app name="ScriptCompiler"
                   subsystem="console"
                   libs="MT_Tools,MT_IO,MT_Archive,MT_XmlTools,MT_Logger,
                         DIA_Motivation,DIA_Representation,DIA_SDK_Manager,DIA_Tool_Archive,DIA_Tool_Debugger,DIA_Tool_DebugInfoGen,DIA_Tool_Scripts,DIA_ToolManager,DIA_Behavior,DIA_Kernel,
                         MT_Tools_Scipio,
                         xerces-c_2">
            <syslibset libs="advapi32,user32"/>
        </build-app>
    </target>

    <!--
    ============================================================================
      clean
    ============================================================================
    -->
    <target name="clean" depends="clean-reports" description="clean intermediate build artifacts">
        <clean name="TIC"/>
        <clean name="TIC_Export"/>
        <clean name="MT_Tools_Scipio"/>
        <clean name="TER"/>
        <clean name="ASN"/>
        <clean name="MIL"/>
        <clean name="Missions"/>
        <clean name="GFX"/>
        <clean name="ENT"/>
        <clean name="TIC_Sample"/>
        <clean name="TIC_XmlExporter"/>
        <clean name="SIM"/>
        <clean name="ADN"/>
        <clean name="MOS_Light"/>
        <clean name="MOS_Light2"/>
        <clean name="Tester"/>
        <clean name="HLA_Manager"/>
        <clean name="AGR"/>
        <clean name="LAU"/>
        <clean name="LAU_Mos_Part"/>
        <clean name="ScriptCompiler"/>
    </target>

    <target name="clean-reports">
        <delete dir="${reports.dir}" includeEmptyDirs="true"/>
    </target>

    <!--
    ============================================================================
      package
    ============================================================================
    -->
    <!--<target name="package" description="package the distribution">
        <mkdir dir="${dist.dir}"/>
        <zip destfile="${dist.dir}/oscar-2A.zip">
            <zipfileset dir="${bin.dir}/release/libraries/oscar-2A" includes="*.dll"/>
            <zipfileset dir="${bin.dir}/release/applications/oscar-2A_app" includes="*.exe"/>
            <zipfileset dir="${libraries.dir}/proxy" includes="**"/>
        </zip>
    </target> -->

    <!--
    ============================================================================
      main
    ============================================================================
    -->
    <target name="tests" depends="" description="run all tests">
        <exec executable="${bin.dir}/release/applications/SIM/SIM.exe" dir="${run.dir}" failonerror="true">
            <arg value="-conffile"/>
            <arg value="${data.dir}/test/scipio.xml"/>
            <arg value="-test"/>
            <arg value="-forceodbcomposition"/>
        </exec>
    </target>

    <target name="configure" description="initialize local project structure with libraries">
        <update name="terrain" modules="terrain,geometry,geocoord,graphics,pathfind"/>
        <update name="asn"/>
        <update name="MT" modules="MT_Tools,MT_Memory,MT_IO,MT_Archive,MT_Patterns,MT_Time,MT_Thread,MT_Logger,MT_XmlTools,MT_Qt"/>
        <update name="qt"/>
        <update name="DIN"/>
        <update name="boost"/>
        <update name="rti"/>
        <update name="DIA"/>
        <update name="hla"/>
        <update name="tools"/>
        <update name="xerces-c"/>

        <update-app library="terrain" name="generation_app"/>
        <update-app library="DIA" name="DIA_Tool_DebugGUI"/>
    </target>

    <target name="build" depends="libraries,applications"/>

    <target name="all" depends="configure,build, tests" description="build and package distribution"/>

</project>
