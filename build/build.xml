<?xml version="1.0"?>
<project name="astec" default="all">

    <import file="//install/masa/common/dev/common/poney/poney.xml"/>

    <!--
    ============================================================================
      libraries
    ============================================================================
    -->
    <target name="libraries" description="build all libraries"
            depends="library.MT_Tools_Scipio,library.ENT,library.ASN,library.simulation_terrain,library.simulation_kernel,library.simulation_missions,
                     library.clients_kernel,library.clients_gui"/>

    <target name="library.MT_Tools_Scipio" description="build MT_Tools_Scipio static library">
        <build-lib name="MT_Tools_Scipio" input="MT_Tools" pch="MT_Tools_pch"/>
    </target>

    <target name="library.ASN" description="build ASN static library">
        <build-lib name="ASN">
            <includepath path="${include.dir}/asn"/>
            <compilerarg value="/W3"/>
        </build-lib>
    </target>

    <target name="library.ENT" description="build ENT static library">
        <build-lib name="ENT"/>
    </target>

    <target name="library.simulation_terrain" description="build simulation_terrain static library" depends="library.MT_Tools_Scipio">
        <build-lib name="simulation_terrain"/>
    </target>

    <target name="library.simulation_kernel" description="build simulation_kernel static library" depends="library.ASN,library.simulation_terrain">
        <build-lib name="simulation_kernel">
            <includepath path="${include.dir}/ASN"/>
            <includepath path="${libraries.dir}/simulation_kernel"/> <!-- pour MIL.h -->
        </build-lib>
    </target>

    <target name="library.simulation_missions" description="build simulation_missions static library" depends="library.simulation_kernel">
        <build-lib name="simulation_missions" excludes="**/MIL_*">
            <includepath path="${libraries.dir}/simulation_kernel"/>
            <includepath path="${include.dir}/ASN"/>
        </build-lib>
    </target>

    <target name="library.clients_kernel" description="build clients_kernel static library" depends="">
        <build-lib name="clients_kernel"/>
    </target>

    <target name="library.clients_gui" description="build clients_gui static library" depends="library.ASN,library.clients_kernel">
        <build-lib name="clients_gui" excludes="**/font/*,**/resources.cpp">
            <includepath path="${include.dir}/ASN"/> <!-- $$ DEVRAIT VIRER -->
        </build-lib>
    </target>

    <target name="library.gaming" description="build gaming static library" depends="library.ASN,library.clients_gui">
        <build-lib name="gaming" excludes="**/statusicons.cpp">
            <includepath path="${include.dir}/ASN"/>
        </build-lib>
    </target>

    <target name="library.preparation" description="build gaming static library" depends="library.ASN,library.clients_gui">
        <build-lib name="preparation">
            <includepath path="${include.dir}/ASN"/> <!-- $$ DEVRAIT VIRER -->
        </build-lib>
    </target>

    <!--
    ============================================================================
     applications
    ============================================================================
    -->
    <target name="applications" description="build Astec executables"
            depends="applications.simulation,applications.clients"/>

    <target name="applications.simulation" description="build Astec Simulation executables"
            depends="application.simulation_app,application.simulation_tester,application.AGR,application.ScriptCompiler" />

    <target name="applications.clients" description="build Astec Client executables"
            depends="application.gaming_app,application.preparation_app,application.adaptation_app" />

    <target name="application.simulation_app" description="build Astec Simulation executable" depends="library.simulation_missions">
        <build-app name="simulation_app" subsystem="console" depends="mt,din,dia3,terrain,boost"
                   libs="tools,HLA,libFedTime,masalloc,paranoia
                         MT_Tools_Scipio,ASN,
                         simulation_terrain,simulation_kernel,simulation_missions,
                         asn1per,xerces-c_2">
            <syslibset libs="dbghelp,psapi"/>
            <syslibset libs="iphlpapi"/> <!-- paranoia -->
            <includepath path="${libraries.dir}/simulation_kernel"/>
            <includepath path="${include.dir}/ASN"/>
            <defineset define="_WIN32_WINNT=0x0400"/> <!-- for 'IsDebuggerPresent()' -->
            <linkerarg value="/STACK:15000000"/>      <!-- Because of boost serialization -->
            <linkerarg value="/LARGEADDRESSAWARE"/>   <!-- Executable can access 3GiB instead of 2GiB -->
        </build-app>
    </target>

    <target name="application.simulation_tester" description="build Astec Simulation Tester executable" depends="library.ASN,library.MT_Tools_Scipio">
        <build-app name="simulation_tester" subsystem="console" depends="mt,din,terrain"
                   libs="MT_Tools_SCIPIO,ASN,asn1per,xerces-c_2"
                   excludes="**/Actions/Missions/Pawn/*.cpp,**/Actions/Missions/Automat/*.cpp,**/Actions/Missions/Population/*.cpp">
            <includepath path="${applications.dir}/simulation_tester"/>
            <includepath path="${include.dir}/ASN"/>
        </build-app>
    </target>

    <target name="application.adaptation_app" description="build Astec Adaptation executable" depends="library.ENT,library.MT_Tools_Scipio">
        <build-app name="adaptation_app" depends="mt,qt" libs="ENT,xerces-c_2" pch-excludes="qtundo.cpp">
            <syslibset libs="advapi32, user32"/>
        </build-app>
    </target>

    <target name="application.gaming_app" description="build Astec Gaming executable" depends="library.gaming">
        <build-app name="gaming_app" excludes="**/**_Gen.*,**/splashscreen.cpp" depends="mt,din,terrain,xeumeuleu,qt,boost"
                   libs="tools,ASN,ENT,gaming,clients_gui,clients_kernel,asn1per">
            <includepath path="${include.dir}/ASN"/>
            <syslibset libs="gdi32,psapi,dbghelp"/>
        </build-app>
    </target>

    <target name="application.preparation_app" description="build Astec Gaming executable" depends="library.preparation">
        <build-app name="preparation_app" excludes="**/**_Gen.*,**/splashscreen.cpp" depends="mt,din,terrain,xeumeuleu,qt,boost"
                   libs="tools,ASN,ENT,preparation,clients_gui,clients_kernel,asn1per">
            <includepath path="${include.dir}/ASN"/>
            <syslibset libs="gdi32,psapi,dbghelp"/>
        </build-app>
    </target>

    <target name="application.AGR" description="build AGR executable">
        <build-app name="AGR" subsystem="console" excludes="**/*_Skeleton.*" depends="mt,boost" libs="xerces-c_2">
            <syslibset libs="user32"/>
        </build-app>
    </target>

    <target name="application.ScriptCompiler" description="build Astec ScriptCompiler executable" depends="library.MT_Tools_Scipio">
        <build-app name="ScriptCompiler" subsystem="console" depends="mt,dia3" libs="MT_Tools_Scipio,xerces-c_2"/>
    </target>

    <!--
    ============================================================================
      clean
    ============================================================================
    -->
    <target name="clean" depends="clean-reports" description="clean intermediate build artifacts">
        <clean name="MT_Tools_Scipio"/>
        <clean name="ASN"/>
        <clean name="ENT"/>
        <clean name="simulation_terrain"/>
        <clean name="simulation_kernel"/>
        <clean name="simulation_missions"/>
        <clean name="simulation_tester"/>
        <clean name="simulation_app"/>
        <clean name="clients_kernel"/>
        <clean name="clients_gui"/>
        <clean name="gaming"/>
        <clean name="gaming_app"/>
        <clean name="preparation"/>
        <clean name="preparation_app"/>
        <clean name="adaptation_app"/>
        <clean name="AGR"/>
        <clean name="ScriptCompiler"/>
    </target>

    <target name="clean-reports">
        <delete dir="${reports.dir}"/>
    </target>

    <!--
    ============================================================================
      tests
    ============================================================================
    -->
    <target name="test" description="run all tests" depends="test-test-scripts,test-main-scripts"/>

    <target name="test-main-scripts" description="run all tests">
        <exec executable="${out.dir}/release/applications/simulation_app/simulation_app.exe" dir="${run.dir}" failonerror="true" resolveexecutable="true" vmlauncher="false">
            <arg value="-conffile"/>
            <arg value="${data.dir}/main/scipio.xml"/>
            <arg value="-test"/>
            <arg value="-forceodbcomposition"/>
        </exec>
    </target>

    <target name="test-test-scripts" description="run all tests">
        <exec executable="${out.dir}/release/applications/simulation_app/simulation_app.exe" dir="${run.dir}" failonerror="true" resolveexecutable="true" vmlauncher="false">
            <arg value="-conffile"/>
            <arg value="${data.dir}/test/scipio.xml"/>
            <arg value="-test"/>
            <arg value="-forceodbcomposition"/>
        </exec>
    </target>

    <!--
    ============================================================================
      package
    ============================================================================
    -->
    <target name="package" description="package the distribution" depends="applications">
        <mkdir dir="${dist.dir}"/>
        <zip destfile="${dist.dir}/astec.zip">
            <fileset dir="${out.dir}/release/applications/adaptation_app" includes="*.exe"/>
            <fileset dir="${out.dir}/release/applications/gaming_app" includes="*.exe"/>
            <fileset dir="${out.dir}/release/applications/preparation_app" includes="*.exe"/>
            <fileset dir="${out.dir}/release/applications/simulation_app" includes="*.exe"/>
        </zip>
    </target>

    <!--
    ============================================================================
      configure
    ============================================================================
    -->
    <target name="configure" description="initialize local project structure with libraries">
        <update name="terrain" modules="terrain,geometry,geocoord,graphics,pathfind"/>
        <update name="asn"/>
        <update name="MT" modules="MT_Tools,MT_Memory,MT_IO,MT_Archive,MT_Patterns,MT_Profiler,MT_Time,MT_Thread,MT_Logger,MT_XmlTools,MT_Qt"/>
        <update name="qt"/>
        <update name="DIN"/>
        <update name="boost"/>
        <update name="rti"/>
        <update name="DIA"/>
        <update name="hla"/>
        <update name="tools"/>
        <update name="paranoia"/>
        <update name="xerces-c"/>
        <update name="xeumeuleu"/>
        <update name="terrain" package="generation_app"/>
        <update name="DIA" package="DIA_Tool_DebugGUI"/>
    </target>

    <!--
    ============================================================================
      main
    ============================================================================
    -->
    <target name="build" depends="libraries,applications"/>

    <target name="all" depends="clean-reports,configure,build,test,package" description="build and package distribution"/>

</project>
