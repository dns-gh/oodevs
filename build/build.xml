<?xml version="1.0"?>
<project name="scipio" default="all">

    <import file="//install/masa/common/dev/common/tools.xml"/>

    <!--
    ============================================================================
      libraries
    ============================================================================
    -->

    <!-- SCIPIO -->
    <target name="libraries.SCIPIO" description="build static library"
            depends="library.MT_Tools_Scipio,library.TER,library.ASN,library.MIL,library.Missions,library.GFX,library.ENT"/>

    <target name="library.MT_Tools_Scipio" description="build MT_Tools_Scipio static library">
        <build-lib name="MT_Tools_Scipio" input="MT_Tools" pch="MT_Tools_pch"/>
    </target>

    <target name="library.TER" description="build TER static library" depends="library.MT_Tools_Scipio">
        <build-lib name="TER"/>
    </target>

    <target name="library.ASN" description="build ASN static library">
        <build-lib name="ASN">
            <includepath path="${include.dir}/ASN"/>
            <compilerarg value="/W3"/>
        </build-lib>
    </target>

    <target name="library.MIL" description="build MIL static library" depends="library.ASN,library.TER">
        <build-lib name="MIL">
            <includepath path="${include.dir}/ASN"/>
        </build-lib>
    </target>

    <target name="library.Missions" description="build Missions static library" depends="library.MIL">
        <build-lib name="Missions" excludes="**/MIL_*">
            <includepath path="${libraries.dir}/MIL"/>
            <includepath path="${include.dir}/ASN"/>
        </build-lib>
    </target>

    <target name="library.GFX" description="build GFX static library" depends="library.MT_Tools_Scipio">
        <build-lib name="GFX"/>
    </target>

    <target name="library.ENT" description="build ENT static library">
        <build-lib name="ENT"/>
    </target>

    <!-- TIC -->
    <target name="libraries.TIC" description="build static library"
            depends="library.TIC, library.TIC_Export"/>

    <target name="library.TIC" description="build TIC static library" depends="library.ASN,library.MT_Tools_Scipio">
        <build-lib name="TIC">
            <includepath path="${include.dir}/ASN"/>
        </build-lib>
    </target>

    <target name="library.TIC_Export" description="build TIC_Export dynamic library" depends="library.TIC">
        <build-lib name="TIC_Export" outtype="shared" debug="false">
            <defineset define="ENGINE_EXPORT"/>
            <libset dir="${lib.dir}/vc71" libs="NEK,DIN,DIN_ConnectionService,DIN_MessageService,
                                                MT_Tools,MT_IO,MT_Logger,MT_Archive,MT_XmlTools,MT_Time,MT_Thread,MT_Memory,
                                                pathfind,geocoord,
                                                TIC,ASN,
                                                boost_thread-vc71-mt-1_32,libboost_date_time-vc71-mt-1_32,
                                                asn1per,xerces-c_2"/>
            <syslibset libs="user32,wsock32,winmm"/>
            <includepath path="${libraries.dir}/TIC"/>
            <includepath path="${include.dir}/ASN"/>
        </build-lib>
    </target>


    <!--
    ============================================================================
     applications
    ============================================================================
    -->

    <!-- SCIPIO -->
    <target name="applications.SCIPIO" description="build SCIPIO executables"
            depends="application.SIM,application.ADN,application.MOS_Light2,application.Tester,application.HLA_Manager,application.AGR,application.LAU,application.LAU_Mos_Part,application.ScriptCompiler"/>

    <target name="application.TIC_XmlExporter" description="build TIC_XmlExporter executable" depends="library.TIC_Export,library.MT_Tools_Scipio">
        <build-app name="TIC_XmlExporter"
                   subsystem="console"
                   libs="MT_Tools,MT_IO,MT_Patterns,MT_Memory,MT_Logger,MT_Thread,MT_Time,MT_Archive,MT_XmlTools,
                         TIC_Export,
                         xerces-c_2">
            <syslibset libs="user32,wsock32,winmm"/>
        </build-app>
    </target>

    <target name="application.SIM" description="build SIM executable" depends="library.Missions">
        <build-app name="SIM"
                   subsystem="console"
                   libs="NEK,DIN,DIN_ConnectionService,DIN_MessageService,
                         MT_Tools,MT_IO,MT_Patterns,MT_Memory,MT_Logger,MT_Thread,MT_Time,MT_Archive,MT_XmlTools,
                         DIA_Motivation,DIA_Representation,DIA_SDK_Manager,DIA_Tool_Archive,DIA_Tool_Debugger,DIA_Tool_DebugInfoGen,DIA_Tool_Scripts,DIA_ToolManager,DIA_Behavior,DIA_Kernel,
                         tools,HLA,libFedTime,pathfind,geocoord,
                         MT_Tools_Scipio,TER,ASN,MIL,Missions,
                         boost_thread-vc71-mt-1_32,libboost_serialization-vc71-mt-1_32,libboost_filesystem-vc71-mt-1_32,
                         asn1per,xerces-c_2">
			      <syslibset libs="advapi32,user32,wsock32,winmm,dbghelp"/>
            <includepath path="${libraries.dir}/MIL"/>
            <includepath path="${include.dir}/ASN"/>
            <defineset define="_WIN32_WINNT=0x0400"/> <!-- for 'IsDebuggerPresent()' -->
            <linkerarg value="/STACK:15000000"/>      <!-- Because of boost serialization -->
            <linkerarg value="/LARGEADDRESSAWARE"/>   <!-- Executable can access 3GiB instead of 2GiB -->
        </build-app>
    </target>

    <target name="application.ADN" description="build ADN executable" depends="library.ENT,library.MT_Tools_Scipio">
        <build-app name="ADN"
                   subsystem="gui"
                   libs="MT_Tools,MT_IO,MT_Patterns,MT_Memory,MT_Logger,MT_Thread,MT_Time,MT_Archive,MT_XmlTools,MT_Qt,
                         MT_Tools_SCIPIO,ENT,
                         qtmain,qt-mt333,xerces-c_2"
                   pch-excludes="qtundo.cpp">
            <syslibset libs="advapi32,user32"/>
        </build-app>
    </target>

    <target name="application.MOS_Light2" description="build MOS_Light2 executable" depends="library.ASN,library.ENT,library.GFX,library.MT_Tools_Scipio">
        <!-- A corriger excludes="**/MOS_**_Gen.*" -->
        <build-app name="MOS_Light2"
                   subsystem="gui"
                   excludes="**/font/*,**/MOS_**_Gen.*"
                   libs="MT_Tools,MT_IO,MT_Patterns,MT_Memory,MT_Logger,MT_Thread,MT_Time,MT_Archive,MT_XmlTools,MT_Qt,
                         NEK,DIN,DIN_ConnectionService,DIN_MessageService,
                         MT_Tools_SCIPIO,ASN,GFX,ENT,
                         geocoord,graphics,pathfind,terrain,
                         asn1per,qtmain,qt-mt333,xerces-c_2">
            <includepath path="${include.dir}/ASN"/>
            <syslibset libs="gdi32,user32,wsock32,winmm,opengl32,glu32,shell32"/>
        </build-app>
    </target>

    <target name="application.Tester" description="build Tester executable" depends="library.ASN,library.MT_Tools_Scipio">
        <build-app name="Tester"
                   subsystem="console"
                   libs="MT_Tools,MT_IO,MT_Patterns,MT_Memory,MT_Logger,MT_Thread,MT_Time,MT_Archive,MT_XmlTools,MT_Qt,
                         NEK,DIN,DIN_ConnectionService,DIN_MessageService,
                         MT_Tools_SCIPIO,ASN,geocoord,
                         asn1per,xerces-c_2"
                   excludes="**/Actions/Missions/Pawn/*.cpp,**/Actions/Missions/Automat/*.cpp,**/Actions/Missions/Population/*.cpp">
            <includepath path="${include.dir}/ASN"/>
            <syslibset libs="gdi32,user32,wsock32,winmm"/>
        </build-app>
    </target>

    <target name="application.HLA_Manager" description="build HLA_Manager executable" depends="library.MIL">
        <build-app name="HLA_Manager"
                   subsystem="gui"
                   libs="MT_Tools,MT_IO,MT_Archive,MT_XmlTools,
                         HLA,libfedtime,
                         MIL,
                         qtmain,qt-mt333,xerces-c_2">
            <syslibset libs="wsock32"/>
        </build-app>
    </target>

    <target name="application.AGR" description="build AGR executable">
        <build-app name="AGR"
                   subsystem="console"
                   excludes="**/*_Skeleton.*"
                   libs="MT_Tools,MT_IO,MT_Archive,MT_XmlTools,
                         libboost_filesystem-vc71-mt-1_32,xerces-c_2">
            <syslibset libs="user32"/>
        </build-app>
    </target>

    <target name="application.LAU" description="build LAU executable" depends="library.ASN,library.MT_Tools_Scipio">
        <build-app name="LAU"
                   subsystem="console"
                   excludes="TerminateApp.c"
                   libs="NEK,DIN,DIN_ConnectionService,DIN_MessageService,
                         MT_Tools,MT_IO,MT_Archive,MT_XmlTools,MT_Logger,MT_Thread,MT_Time,MT_Archive,MT_XmlTools,
                         MT_Tools_Scipio,ASN,
                         asn1per,xerces-c_2">
            <includepath path="${include.dir}/ASN"/>
            <syslibset libs="ole32,advapi32,user32,wsock32,winmm"/>
        </build-app>
    </target>

    <target name="application.LAU_Mos_Part" description="build LAU_Mos_Part executable" depends="library.ASN">
        <build-app name="LAU_Mos_Part"
                   subsystem="gui"
                   libs="NEK,DIN,DIN_ConnectionService,DIN_MessageService,
                         MT_Tools,MT_IO,MT_Archive,MT_XmlTools,MT_Logger,MT_Thread,MT_Time,
                         ASN,
                         asn1per,qtmain,qt-mt333"
                   pch="LMP_pch">
            <syslibset libs="user32,wsock32,winmm"/>
            <includepath path="${include.dir}/ASN"/>
        </build-app>
    </target>

    <target name="application.ScriptCompiler" description="build ScriptCompiler executable" depends="library.MT_Tools_Scipio">
        <build-app name="ScriptCompiler"
                   subsystem="console"
                   libs="MT_Tools,MT_IO,MT_Archive,MT_XmlTools,MT_Logger,
                         DIA_Motivation,DIA_Representation,DIA_SDK_Manager,DIA_Tool_Archive,DIA_Tool_Debugger,DIA_Tool_DebugInfoGen,DIA_Tool_Scripts,DIA_ToolManager,DIA_Behavior,DIA_Kernel,
                         MT_Tools_Scipio,
                         xerces-c_2">
            <syslibset libs="advapi32,user32"/>
        </build-app>
    </target>


    <!-- TIC -->
    <target name="applications.TIC" description="build TIC executables"
            depends="application.TIC_Sample,application.TIC_XmlExporter"/>

    <target name="application.TIC_Sample" description="build TIC_Sample executable" depends="library.TIC_Export">
        <build-app name="TIC_Sample"
                   subsystem="console"
                   libs="TIC_Export">
            <syslibset libs="user32,wsock32,winmm"/>
        </build-app>
    </target>

    <!--
    ============================================================================
      clean
    ============================================================================
    -->
    <target name="clean" depends="clean-reports" description="clean intermediate build artifacts">
        <clean name="TIC"/>
        <clean name="TIC_Export"/>
        <clean name="MT_Tools_Scipio"/>
        <clean name="TER"/>
        <clean name="ASN"/>
        <clean name="MIL"/>
        <clean name="Missions"/>
        <clean name="GFX"/>
        <clean name="ENT"/>
        <clean name="TIC_Sample"/>
        <clean name="TIC_XmlExporter"/>
        <clean name="SIM"/>
        <clean name="ADN"/>
        <clean name="MOS_Light2"/>
        <clean name="Tester"/>
        <clean name="HLA_Manager"/>
        <clean name="AGR"/>
        <clean name="LAU"/>
        <clean name="LAU_Mos_Part"/>
        <clean name="ScriptCompiler"/>
    </target>

    <target name="clean-reports">
        <delete dir="${reports.dir}" includeEmptyDirs="true"/>
    </target>

    <!--
    ============================================================================
      tests
    ============================================================================
    -->
    <target name="test" depends="" description="run all tests">
        <exec executable="${bin.dir}/release/applications/SIM/SIM.exe" dir="${run.dir}" failonerror="true" resolveexecutable="true" vmlauncher="false">
            <arg value="-conffile"/>
            <arg value="${data.dir}/test/scipio.xml"/>
            <arg value="-test"/>
            <arg value="-forceodbcomposition"/>
        </exec>
    </target>

    <!--
    ============================================================================
      package
    ============================================================================
    -->
    <!--<target name="package" description="package the distribution">
        <mkdir dir="${dist.dir}"/>
        <zip destfile="${dist.dir}/oscar-2A.zip">
            <zipfileset dir="${bin.dir}/release/libraries/oscar-2A" includes="*.dll"/>
            <zipfileset dir="${bin.dir}/release/applications/oscar-2A_app" includes="*.exe"/>
            <zipfileset dir="${libraries.dir}/proxy" includes="**"/>
        </zip>
    </target> -->

    <!--
    ============================================================================
      configure
    ============================================================================
    -->
    <target name="configure" description="initialize local project structure with libraries">
        <update name="terrain" modules="terrain,geometry,geocoord,graphics,pathfind"/>
        <update name="asn"/>
        <update name="MT" modules="MT_Tools,MT_Memory,MT_IO,MT_Archive,MT_Patterns,MT_Time,MT_Thread,MT_Logger,MT_XmlTools,MT_Qt"/>
        <update name="qt"/>
        <update name="DIN"/>
        <update name="boost"/>
        <update name="rti"/>
        <update name="DIA"/>
        <update name="hla"/>
        <update name="tools"/>
        <update name="xerces-c"/>
        <update name="terrain" package="generation_app"/>
        <update name="DIA" package="DIA_Tool_DebugGUI"/>
    </target>

    <!--
    ============================================================================
      main
    ============================================================================
    -->
    <target name="build.SCIPIO" depends="libraries.SCIPIO,applications.SCIPIO"/>

    <target name="build.TIC"    depends="libraries.TIC,applications.TIC"/>

    <target name="build" depends="build.SCIPIO,build.TIC"/>

    <target name="all" depends="configure,build,test" description="build and package distribution"/>

</project>