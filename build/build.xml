<?xml version="1.0"?>
<project name="csword" default="all">

    <!-- Generate 3 months evaluation license -->
    <property name="flex.name" value="evaluation"/>
    <property name="flex.hostid" value="ANY"/>
    <tstamp>
        <format property="flex.expiration" pattern="d-MMM-yyyy" offset="3" unit="month" locale="en,US"/>
    </tstamp>

    <property environment="env"/>
    <property name="env.PONEY_HOME" value="//install/masa/common/dev/common/poney"/>
    <import file="${env.PONEY_HOME}/poney.xml"/>

    <property name="version.company" value="MASA Group"/>
    <property name="version.product" value="Sword"/>
    <property name="version.major" value="4.3.3"/>
    <property name="version.minor" value="${version.major}.${svn.revision}"/>
    <property name="version.version" value="${version.minor}"/><!-- required for version extension -->
    <property name="masalife.version" value="2011-1.1.x/sword"/>

    <!--
    ============================================================================
      libraries
    ============================================================================
    -->
    <target name="libraries" depends="library.tools,library.MT_Tools,library.ENT,library.protocol,library.simulation_terrain,library.simulation_kernel,
                                      library.clients_kernel,library.clients_gui,library.actions,library.actions,library.actions_gui,library.reports,
                                      library.gaming,library.preparation,library.plugins,library.3a,library.mission_tester" description="build all libraries"/>

    <target name="library.tools" depends="library.MT_Tools" description="build tools static library">
        <build-lib name="tools" pattern="lib${ant.project.name}_tools-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
            <defineset>
                <define name="APP_VERSION" value="${version.minor}"/>
                <define name="APP_MAJOR_VERSION" value="${version.major}"/>
            </defineset>
        </build-lib>
    </target>

    <target name="library.MT_Tools" description="build MT_Tools static library">
        <build-lib name="MT_Tools" pattern="lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.protocol" description="build protocol static library">
        <build-lib name="protocol" pattern="lib${ant.project.name}_protocol-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.ENT" description="build ENT static library">
        <build-lib name="ENT" depends="qt4" pattern="lib${ant.project.name}_ENT-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.dispatcher" depends="library.MT_Tools,library.tools,library.protocol,library.meteo" description="build dispatcher static library">
        <build-lib name="dispatcher" pattern="lib${ant.project.name}_dispatcher-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="MT_AUTO_LINK"/>
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.simulation_terrain" depends="library.MT_Tools" description="build simulation_terrain static library">
        <build-lib name="simulation_terrain" pattern="lib${ant.project.name}_simulation_terrain-${platform}-mt@{suffix}" suffix="-gd"/>
    </target>

    <target name="library.simulation_kernel" depends="library.tools,library.protocol,library.simulation_terrain,library.meteo,library.resource_network,library.flood" description="build simulation_kernel static library">
        <build-lib name="simulation_kernel" pattern="lib${ant.project.name}_simulation_kernel-${platform}-mt@{suffix}" suffix="-gd" excludes="**/DEC_Knowledge_ObjectAttributeProxy_ABC.h">
            <includepath path="${libraries.dir}/simulation_kernel"/> <!-- pour MIL.h -->
            <defineset>
                <define name="PLATFORM" value="${platform}"/>
            </defineset>
        </build-lib>
    </target>

    <target name="library.clients_kernel" depends="library.protocol,library.tools,library.ENT" description="build clients_kernel static library">
        <build-lib name="clients_kernel" depends="qt4" pattern="lib${ant.project.name}_clients_kernel-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.clients_gui" depends="library.clients_kernel" description="build clients_gui static library">
        <build-lib name="clients_gui" excludes="**/font/*" depends="qt4" pattern="lib${ant.project.name}_clients_gui-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.actions" depends="library.protocol,library.clients_kernel" description="build actions static library">
        <build-lib name="actions" depends="qt4" pattern="lib${ant.project.name}_actions-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.actions_gui" depends="library.clients_gui,library.actions" description="build actions_gui library">
        <build-lib name="actions_gui" depends="boost,qt4,xerces" pattern="lib${ant.project.name}_actions_gui-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.indicators" depends="library.clients_kernel" description="build indicators static library">
        <build-lib name="indicators" depends="boost,qt4,xerces" pattern="lib${ant.project.name}_indicators-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.reports" depends="library.protocol,library.clients_kernel" description="build reports static library">
        <build-lib name="reports" depends="qt4" pattern="lib${ant.project.name}_reports-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.gaming" depends="library.protocol,library.clients_gui,library.actions,library.actions_gui,library.indicators,library.reports,library.meteo,library.flood" description="build gaming static library">
        <build-lib name="gaming" depends="qt4" pattern="lib${ant.project.name}_gaming-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.preparation" depends="library.clients_gui,library.actions_gui,library.indicators,library.flood" description="build preparation static library">
        <build-lib name="preparation" depends="qt4" pattern="lib${ant.project.name}_preparation-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.frontend" depends="library.clients_gui" description="build frontend static library">
        <build-lib name="frontend" depends="qt4" pattern="lib${ant.project.name}_frontend-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="_WIN32_WINNT=0x0501"/>
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.3a" depends="library.dispatcher" description="build 3a static library">
        <build-lib name="3a" pattern="lib${ant.project.name}_3a-${platform}-mt@{suffix}" suffix="-gd"/>
    </target>

    <target name="library.bml_plugin" depends="library.dispatcher" description="build BML dispatcher plugin static library">
        <build-lib name="bml_plugin" pattern="lib${ant.project.name}_bml_plugin-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

	<target name="library.bml_plugin_dll" depends="library.bml_plugin" description="build bml_plugin dynamic library">
        <build-lib name="bml_plugin_dll" outtype="shared" depends="boost,qt4,terrain,xalan,xerces,protobuf" pattern="bml_plugin-${platform}-mt@{suffix}" suffix="-gd"
            libs="Qt3Support4,
                  lib${ant.project.name}_clients_kernel-${platform}-mt@{suffix},
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_ENT-${platform}-mt@{suffix},
                  lib${ant.project.name}_protocol-${platform}-mt@{suffix},
                  lib${ant.project.name}_dispatcher-${platform}-mt@{suffix},
                  lib${ant.project.name}_bml_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix}">
            <syslibset libs="shell32,user32"/>
            <defineset define="BML_PLUGIN_DLL_EXPORTS"/>
            <defineset define="QT3_SUPPORT"/>
            <linkerarg value="/FIXED:NO"/>
        </build-lib>
        <move todir="${run.dir}/plugins/bml" file="${run.dir}/bml_plugin-${platform}-mt.dll"/>
    </target>
	
    <target name="library.crossbow_plugin" depends="library.MT_Tools,library.tools,library.protocol" description="build crossbow dispatcher plugin static library">
        <build-lib name="crossbow_plugin" pattern="lib${ant.project.name}_crossbow_plugin-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.crossbow_plugin_dll" depends="library.crossbow_plugin" description="build crossbow_plugin dynamic library">
        <build-lib name="crossbow_plugin_dll" outtype="shared" depends="boost,qt4,terrain,xalan,xerces,protobuf" pattern="crossbow_plugin-${platform}-mt@{suffix}" suffix="-gd"
            libs="gdal_i,Qt3Support4,
                  lib${ant.project.name}_clients_kernel-${platform}-mt@{suffix},
                  lib${ant.project.name}_ENT-${platform}-mt@{suffix},
                  lib${ant.project.name}_protocol-${platform}-mt@{suffix},
                  lib${ant.project.name}_dispatcher-${platform}-mt@{suffix},
                  lib${ant.project.name}_actions-${platform}-mt@{suffix},
                  lib${ant.project.name}_crossbow_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix}">
            <syslibset libs="shell32,user32"/>
            <defineset define="CROSSBOW_PLUGIN_DLL_EXPORTS"/>
            <defineset define="QT3_SUPPORT"/>
            <linkerarg value="/FIXED:NO"/>
        </build-lib>
        <move todir="${run.dir}/plugins/crossbow" file="${run.dir}/crossbow_plugin-${platform}-mt.dll"/>
    </target>

    <target name="library.rpr" description="build rpr static library">
        <build-lib name="rpr" pattern="lib${ant.project.name}_rpr-${platform}-mt@{suffix}" suffix="-gd"/>
    </target>

    <target name="library.hla_plugin" depends="library.dispatcher,library.rpr" description="build hla_plugin static library">
        <build-lib name="hla_plugin" pattern="lib${ant.project.name}_hla_plugin-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.hla_plugin_dll" depends="library.hla_plugin" description="build hla_plugin dynamic library">
        <build-lib name="hla_plugin_dll" outtype="shared" depends="boost,qt4,terrain,xalan,xerces,protobuf" pattern="hla_plugin-${platform}-mt@{suffix}" suffix="-gd"
            libs="HLA,
                  Qt3Support4,
                  lib${ant.project.name}_clients_kernel-${platform}-mt@{suffix},
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_ENT-${platform}-mt@{suffix},
                  lib${ant.project.name}_protocol-${platform}-mt@{suffix},
                  lib${ant.project.name}_rpr-${platform}-mt@{suffix},
                  lib${ant.project.name}_hla_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix}">
            <syslibset libs="shell32,user32"/>
            <defineset define="HLA_PLUGIN_DLL_EXPORTS"/>
            <defineset define="QT3_SUPPORT"/>
            <linkerarg value="/FIXED:NO"/>
        </build-lib>
        <move todir="${run.dir}/plugins/hla" file="${run.dir}/hla_plugin-${platform}-mt.dll"/>
    </target>

    <target name="library.vrforces_plugin" depends="library.protocol,library.rpr" description="build vrforces_plugin static library">
        <build-lib name="vrforces_plugin" pattern="lib${ant.project.name}_vrforces_plugin-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <includepath path="${include.dir}/vrforces"/>
            <includepath path="${include.dir}/vrlink"/>
            <includepath path="${include.dir}/mak"/>
            <defineset define="DtDISVERS=5"/>
            <defineset define="DtHLA=1"/>
            <defineset define="DtHLA_1516=1"/>
            <defineset define="RTI_USES_STD_FSTREAM=1"/>
            <defineset define="DtRPR=1"/>
            <defineset define="DT_USE_DLL=1"/>
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.vrforces_plugin_dll" depends="library.dispatcher,library.vrforces_plugin" description="build vrforces_plugin dynamic library" if="is-vc80">
        <build-lib name="vrforces_plugin_dll" outtype="shared" depends="boost,qt4,terrain,xalan,xerces,protobuf" pattern="vrforces_plugin-${platform}-mt@{suffix}" suffix="-gd"
            libs="libFedtime1516,
                  Qt3Support4,
                  matrixRT,mtlRT,vlHLA1516RT,vlRT,vlutilRT,vrfcontrolHLA1516,
                  lib${ant.project.name}_ENT-${platform}-mt@{suffix},
                  lib${ant.project.name}_clients_kernel-${platform}-mt@{suffix},
                  lib${ant.project.name}_dispatcher-${platform}-mt@{suffix},
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_protocol-${platform}-mt@{suffix},
                  lib${ant.project.name}_rpr-${platform}-mt@{suffix},
                  lib${ant.project.name}_vrforces_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix}">
            <syslibset libs="shell32,user32"/>
            <defineset define="VRFORCES_PLUGIN_DLL_EXPORTS"/>
            <defineset define="QT3_SUPPORT"/>
            <linkerarg value="/FIXED:NO"/>
        </build-lib>
        <move todir="${run.dir}/plugins/vrforces" file="${run.dir}/vrforces_plugin-${platform}-mt.dll"/>
    </target>

    <target name="library.dis_plugin" depends="library.dispatcher,library.rpr" description="build dis_plugin static library">
        <build-lib name="dis_plugin" pattern="lib${ant.project.name}_dis_plugin-${platform}-mt@{suffix}" suffix="-gd" depends="qt4"/>
    </target>

    <target name="library.dis_plugin_dll" depends="library.dis_plugin,library.dispatcher,library.tic" description="build dis_plugin dynamic library">
        <build-lib name="dis_plugin_dll" outtype="shared" depends="boost,qt4,terrain,xalan,xerces,protobuf" pattern="dis_plugin-${platform}-mt@{suffix}" suffix="-gd"
            libs="lib${ant.project.name}_ENT-${platform}-mt@{suffix},
                  lib${ant.project.name}_clients_kernel-${platform}-mt@{suffix},
                  lib${ant.project.name}_dis_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_protocol-${platform}-mt@{suffix},
                  lib${ant.project.name}_rpr-${platform}-mt@{suffix},
                  lib${ant.project.name}_tic-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix}">
            <syslibset libs="shell32,user32"/>
            <defineset define="DIS_PLUGIN_DLL_EXPORTS"/>
            <linkerarg value="/FIXED:NO"/>
        </build-lib>
        <move todir="${run.dir}/plugins/dis" file="${run.dir}/dis_plugin-${platform}-mt.dll"/>
    </target>

    <target name="library.tic" depends="library.dispatcher" description="build tic static library">
        <build-lib name="tic" pattern="lib${ant.project.name}_tic-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.messenger_plugin" depends="library.dispatcher" description="build messenger_plugin static library">
        <build-lib name="messenger_plugin" pattern="lib${ant.project.name}_messenger_plugin-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.aar_plugin" depends="library.dispatcher" description="build aar_plugin static library">
        <build-lib name="aar_plugin" pattern="lib${ant.project.name}_aar_plugin-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.rights_plugin" depends="library.dispatcher" description="build rights_plugin static library">
        <build-lib name="rights_plugin" pattern="lib${ant.project.name}_rights_plugin-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.order_plugin" depends="library.dispatcher" description="build order_plugin static library">
        <build-lib name="order_plugin" pattern="lib${ant.project.name}_order_plugin-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.saver_plugin" depends="library.dispatcher" description="build saver_plugin static library">
        <build-lib name="saver_plugin" pattern="lib${ant.project.name}_saver_plugin-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.replay_plugin" depends="library.dispatcher" description="build replay_plugin static library">
        <build-lib name="replay_plugin" pattern="lib${ant.project.name}_replay_plugin-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.positions_plugin" depends="library.dispatcher" description="build positions saver dispatcher plugin static library">
        <build-lib name="positions_plugin" pattern="lib${ant.project.name}_positions_plugin-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.resource_network" description="build resource network static library">
        <build-lib name="resource_network" pattern="lib${ant.project.name}_resource_network-${platform}-mt@{suffix}" suffix="-gd"/>
    </target>

    <target name="library.meteo" depends="library.protocol,library.clients_kernel" description="build meteo static library">
        <build-lib name="meteo" pattern="lib${ant.project.name}_meteo-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.flood" description="build flood static library">
        <build-lib name="flood" pattern="lib${ant.project.name}_flood-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.shield" depends="library.protocol" description="build shield static library">
        <build-lib name="shield" excludes="**/*.h" pattern="lib${ant.project.name}_shield-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.import" description="build import static library">
        <build-lib name="import" pattern="lib${ant.project.name}_import-${platform}-mt@{suffix}" suffix="-gd"/>
    </target>

    <target name="library.script_plugin" depends="library.dispatcher" description="build script_plugin static library">
        <build-lib name="script_plugin" pattern="lib${ant.project.name}_script_plugin-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
        <copy todir="${run.dir}/resources/scripts">
            <fileset dir="${libraries.dir}/script_plugin" includes="**/*.lua"/>
        </copy>
    </target>

    <target name="library.timeline_plugin" depends="library.dispatcher" description="build timeline_plugin static library">
        <build-lib name="timeline_plugin" pattern="lib${ant.project.name}_timeline_plugin-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.timeline_plugin_dll" depends="library.timeline_plugin" description="build timeline_plugin dynamic library">
        <build-lib name="timeline_plugin_dll" outtype="shared" depends="boost,qt4,terrain,xalan,xerces,protobuf,openssl" pattern="timeline_plugin-${platform}-mt@{suffix}" suffix="-gd"
            libs="Qt3Support4,
                  lib${ant.project.name}_clients_kernel-${platform}-mt@{suffix},
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_ENT-${platform}-mt@{suffix},
                  lib${ant.project.name}_dispatcher-${platform}-mt@{suffix},
                  lib${ant.project.name}_protocol-${platform}-mt@{suffix},
                  lib${ant.project.name}_actions-${platform}-mt@{suffix},
                  lib${ant.project.name}_timeline_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix}">
            <syslibset libs="shell32,user32"/>
            <defineset define="TIMELINE_PLUGIN_DLL_EXPORTS"/>
            <defineset define="QT3_SUPPORT"/>
            <linkerarg value="/FIXED:NO"/>
        </build-lib>
        <move todir="${run.dir}/plugins/timeline" file="${run.dir}/timeline_plugin-${platform}-mt.dll"/>
    </target>

    <target name="library.score_plugin" depends="library.dispatcher,library.3a,library.indicators" description="build score_plugin static library">
        <build-lib name="score_plugin" depends="boost,qt4" pattern="lib${ant.project.name}_score_plugin-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.logger_plugin" depends="library.dispatcher,library.reports" description="build logger_plugin static library">
        <build-lib name="logger_plugin" depends="qt4" pattern="lib${ant.project.name}_logger_plugin-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.client_proxy" depends="library.protocol,library.tools" description="build clients_kernel static library">
        <build-lib name="client_proxy" pattern="lib${ant.project.name}_client_proxy-${platform}-mt@{suffix}" suffix="-gd">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="library.plugins" depends="library.messenger_plugin,library.dis_plugin_dll,library.hla_plugin_dll,
                                            library.aar_plugin,library.rights_plugin,library.order_plugin,library.saver_plugin,library.replay_plugin,
                                            library.3a,
											library.bml_plugin,library.bml_plugin_dll,
											library.script_plugin,library.score_plugin,
                                            library.crossbow_plugin_dll,library.timeline_plugin_dll,
                                            library.logger_plugin,library.positions_plugin" description="build all dispatcher plugins"/>

    <target name="library.mission_tester" depends="library.clients_kernel,library.actions,library.client_proxy" description="build mission tester lib">
        <build-lib name="mission_tester" pattern="lib${ant.project.name}_mission_tester-${platform}-mt@{suffix}" suffix="-gd" depends="qt4">
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <!--
    ============================================================================
     applications
    ============================================================================
    -->
    <target name="applications" description="build Sword executables"
            depends="applications.simulation,applications.clients,applications.frontends"/>

    <target name="applications.simulation" description="build Sword Simulation executables"
            depends="application.dispatcher_app,application.simulation_app,application.replayer_app"/>

    <target name="applications.clients" description="build Sword Client executables"
            depends="application.gaming_app,application.preparation_app,application.adaptation_app,
                     application.loadtester_app,application.wise_driver_dll,library.vrforces_plugin_dll,
                     application.mission_tester_app,application.edxlhave_app,
                     application.launcher_test_app,application.xml_signature_app"/>

    <target name="applications.frontends" description="build Sword Frontend executables"
            depends="application.selftraining_app,application.launcher_app,application.package_app"/>

    <target name="application.launcher_dll" depends="library.client_proxy,library.clients_gui,library.frontend,library.protocol,library.shield" description="build Sword launcher dll">
        <build-lib name="launcher_dll" outtype="shared" mode="release" depends="boost,qt4,xerces,xalan,protobuf" pattern="launcher-${platform}-mt"
            libs="zipstream,zlib1,tools,
                  Qt3Support4,
                  lib${ant.project.name}_clients_gui-${platform}-mt@{suffix},
                  lib${ant.project.name}_clients_kernel-${platform}-mt@{suffix},
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_client_proxy-${platform}-mt@{suffix},
                  lib${ant.project.name}_ENT-${platform}-mt@{suffix},
                  lib${ant.project.name}_frontend-${platform}-mt@{suffix},
                  lib${ant.project.name}_protocol-${platform}-mt@{suffix},
                  lib${ant.project.name}_shield-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix}">
            <syslibset libs="shell32,user32"/>
            <defineset define="QT3_SUPPORT"/>
            <defineset define="LAUNCHER_DLL_EXPORTS"/>
            <linkerarg value="/FIXED:NO"/>
        </build-lib>
    </target>

    <target name="application.dispatcher_dll" depends="library.dispatcher,library.actions,library.clients_kernel,library.ENT,library.plugins,library.shield" description="build Sword Dispatcher dll with crossbow">
        <build-lib name="dispatcher_dll" outtype="shared" mode="release" depends="boost,terrain,qt4,xerces,xalan,protobuf" pattern="dispatcher-${platform}-mt"
            libs="masalloc,tools,
                  Qt3Support4,
                  directia-${platform}-mt-4_6,
                  lib${ant.project.name}_actions-${platform}-mt@{suffix},
                  lib${ant.project.name}_ENT-${platform}-mt@{suffix},
                  lib${ant.project.name}_protocol-${platform}-mt@{suffix},
                  lib${ant.project.name}_aar_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_rights_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_reports-${platform}-mt@{suffix},
                  lib${ant.project.name}_replay_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_positions_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_saver_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_logger_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_messenger_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_script_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_order_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_3a-${platform}-mt@{suffix},
                  lib${ant.project.name}_score_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_dispatcher-${platform}-mt@{suffix},
                  lib${ant.project.name}_clients_kernel-${platform}-mt@{suffix},
                  lib${ant.project.name}_indicators-${platform}-mt,
                  lib${ant.project.name}_meteo-${platform}-mt@{suffix},
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_rpr-${platform}-mt@{suffix},
                  lib${ant.project.name}_shield-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix}">
            <syslibset libs="dbghelp,psapi,iphlpapi,user32,advapi32"/>
            <defineset define="DISPATCHER_DLL_EXPORTS"/>
            <defineset define="QT3_SUPPORT"/>
            <linkerarg value="/FIXED:NO"/>
        </build-lib>
    </target>

    <target name="application.dispatcher_app" depends="application.dispatcher_dll" description="build Sword Dispatcher executable">
        <build-app name="dispatcher_app" mode="release" depends="boost,terrain,flexlm"
            libs="masalloc,tools,
                  Qt3Support4,
                  dispatcher-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix}
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix}">
            <syslibset libs="dbghelp,psapi,iphlpapi,user32,advapi32"/>
            <defineset define="QT3_SUPPORT"/>
        </build-app>
    </target>

    <target name="application.simulation_app" depends="library.dispatcher,library.simulation_kernel,application.dispatcher_dll" description="build Sword Simulation executable">
        <build-app name="simulation_app" depends="terrain,boost,xerces,xalan,flexlm,qt4,protobuf" pattern="simulation_app"
            libs="masalloc,directia-${platform}-mt-4_6,library-${platform}-mt,
                  Qt3Support4,
                  gdal_i,gdal_ogr,log4cxx,geodata,analysis,
                  dispatcher-${platform}-mt@{suffix},
                  lib${ant.project.name}_clients_kernel-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_ENT-${platform}-mt,
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_protocol-${platform}-mt@{suffix},
                  lib${ant.project.name}_resource_network-${platform}-mt@{suffix},
                  lib${ant.project.name}_flood-${platform}-mt@{suffix},
                  lib${ant.project.name}_meteo-${platform}-mt@{suffix},
                  lib${ant.project.name}_simulation_terrain-${platform}-mt@{suffix},
                  lib${ant.project.name}_simulation_kernel-${platform}-mt@{suffix}">
            <syslibset libs="dbghelp,psapi,shell32,iphlpapi,advapi32"/>
            <includepath path="${libraries.dir}/simulation_kernel"/>
            <defineset define="QT3_SUPPORT"/>
            <defineset define="_WIN32_WINNT=0x0501"/> <!-- for 'IsDebuggerPresent()' -->
            <linkerarg value="/STACK:15000000"/>      <!-- Because of boost serialization -->
            <linkerarg value="/LARGEADDRESSAWARE"/>   <!-- Executable can access 3GiB instead of 2GiB -->
        </build-app>
    </target>

    <target name="application.replayer_app" depends="application.dispatcher_dll,library.dispatcher,library.3a,library.score_plugin" description="build Sword replayer executable with crossbow">
        <build-app name="replayer_app" depends="terrain,boost,flexlm,qt4,xerces,xalan,protobuf" pattern="replayer_app"
            libs="tools,directia-${platform}-mt-4_6,
                  Qt3Support4,
                  dispatcher-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt,
                  lib${ant.project.name}_ENT-${platform}-mt,
                  lib${ant.project.name}_MT_Tools-${platform}-mt,
                  lib${ant.project.name}_protocol-${platform}-mt,
                  lib${ant.project.name}_3a-${platform}-mt,
                  lib${ant.project.name}_dispatcher-${platform}-mt,
                  lib${ant.project.name}_clients_kernel-${platform}-mt,
                  lib${ant.project.name}_meteo-${platform}-mt@{suffix},
                  lib${ant.project.name}_aar_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_rights_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_replay_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_saver_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_messenger_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_score_plugin-${platform}-mt,
                  lib${ant.project.name}_shield-${platform}-mt@{suffix},
                  lib${ant.project.name}_indicators-${platform}-mt">
            <syslibset libs="dbghelp,psapi,iphlpapi,user32,shell32,advapi32"/>
            <defineset define="QT3_SUPPORT"/>
        </build-app>
    </target>

    <target name="application.adaptation_app" depends="library.ENT,library.clients_gui" description="build Sword Adaptation executable">
        <build-app name="adaptation_app" depends="qt4,xerces,xalan,boost,flexlm" excludes="**/XmlResources.cpp"
                   libs="svgl,zipstream,
                         Qt3Support4,
                         lib${ant.project.name}_ENT-${platform}-mt,
                         lib${ant.project.name}_clients_gui-${platform}-mt,
                         lib${ant.project.name}_clients_kernel-${platform}-mt,
                         lib${ant.project.name}_MT_Tools-${platform}-mt,
                         lib${ant.project.name}_tools-${platform}-mt" pch-excludes="qt4undo.cpp">
            <syslibset libs="gdi32,advapi32,user32,shell32"/>
            <defineset define="QT3_SUPPORT"/>
        </build-app>
    </target>

    <target name="application.gaming_app" depends="library.gaming" description="build Sword Gaming executable">
        <build-app name="gaming_app" depends="terrain,xerces,xalan,qt4,boost,flexlm,protobuf"
                   libs="gdal_i,gdal_ogr,log4cxx,svgl,zipstream,zlib1,bugtrap,
                         Qt3Support4,
                         lib${ant.project.name}_actions-${platform}-mt,
                         lib${ant.project.name}_actions_gui-${platform}-mt,
                         lib${ant.project.name}_clients_gui-${platform}-mt,
                         lib${ant.project.name}_clients_kernel-${platform}-mt,
                         lib${ant.project.name}_MT_Tools-${platform}-mt,
                         lib${ant.project.name}_ENT-${platform}-mt,
                         lib${ant.project.name}_protocol-${platform}-mt,
                         lib${ant.project.name}_meteo-${platform}-mt@{suffix},
                         lib${ant.project.name}_reports-${platform}-mt,
                         lib${ant.project.name}_gaming-${platform}-mt,
                         lib${ant.project.name}_indicators-${platform}-mt,
                         lib${ant.project.name}_flood-${platform}-mt,
                         lib${ant.project.name}_tools-${platform}-mt">
            <syslibset libs="gdi32,psapi,dbghelp,htmlhelp,advapi32"/>
            <defineset define="QT3_SUPPORT"/>
        </build-app>
    </target>

    <target name="application.loadtester_app" depends="library.protocol,library.tools" description="build Sword load testing executable">
        <build-app name="loadtester_app" subsystem="console" depends="boost,protobuf"
                   libs="lib${ant.project.name}_protocol-${platform}-mt,
                         Qt3Support4,
                         lib${ant.project.name}_MT_Tools-${platform}-mt,
                         lib${ant.project.name}_tools-${platform}-mt">
            <syslibset libs="gdi32,psapi,dbghelp,htmlhelp,advapi32"/>
            <defineset define="QT3_SUPPORT"/>
        </build-app>
    </target>

    <target name="application.preparation_app" depends="library.preparation,library.frontend" description="build Sword Gaming executable">
        <build-app name="preparation_app" excludes="**/**_Gen.*" depends="terrain,xerces,xalan,qt4,boost,flexlm,protobuf"
                   libs="gdal_i,gdal_ogr,log4cxx,svgl,zipstream,zlib1,bugtrap,
                         Qt3Support4,
                         lib${ant.project.name}_actions-${platform}-mt,
                         lib${ant.project.name}_actions_gui-${platform}-mt,
                         lib${ant.project.name}_clients_gui-${platform}-mt,
                         lib${ant.project.name}_clients_kernel-${platform}-mt,
                         lib${ant.project.name}_MT_Tools-${platform}-mt,
                         lib${ant.project.name}_ENT-${platform}-mt,
                         lib${ant.project.name}_protocol-${platform}-mt,
                         lib${ant.project.name}_indicators-${platform}-mt,
                         lib${ant.project.name}_preparation-${platform}-mt,
                         lib${ant.project.name}_meteo-${platform}-mt,
                         lib${ant.project.name}_flood-${platform}-mt,
                         lib${ant.project.name}_tools-${platform}-mt,
                         lib${ant.project.name}_frontend-${platform}-mt">
            <syslibset libs="gdi32,psapi,dbghelp,htmlhelp,advapi32"/>
            <defineset define="QT3_SUPPORT"/>
        </build-app>
    </target>

    <target name="application.selftraining_app" depends="library.frontend,application.launcher_dll" description="build Sword Self-training executable">
        <build-app name="selftraining_app" depends="qt4,boost,xerces,xalan,flexlm,protobuf"
            libs="bugtrap,zipstream,zlib1,tools
                    Qt3Support4,
                    launcher-${platform}-mt@{suffix},
                    lib${ant.project.name}_ENT-${platform}-mt,
                    lib${ant.project.name}_frontend-${platform}-mt,
                    lib${ant.project.name}_clients_gui-${platform}-mt,
                    lib${ant.project.name}_clients_kernel-${platform}-mt,
                    lib${ant.project.name}_MT_Tools-${platform}-mt,
                    lib${ant.project.name}_protocol-${platform}-mt,
                    lib${ant.project.name}_tools-${platform}-mt">
            <syslibset libs="gdi32,shell32,htmlhelp,advapi32"/>
            <defineset define="QT3_SUPPORT"/>
        </build-app>
    </target>

    <target name="application.launcher_app" depends="library.MT_Tools,application.launcher_dll" description="build Sword launcher service">
        <build-app name="launcher_app" depends="boost,xerces,xalan" subsystem="console"
            libs="launcher-${platform}-mt@{suffix},tools
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix}">
            <syslibset libs="psapi,advapi32"/>
            <defineset define="_WIN32_WINNT=0x0501"/>
        </build-app>
    </target>

    <target name="application.package_app" description="build Sword Package deployment executable">
        <build-app name="package_app" depends="boost" subsystem="console">
            <syslibset libs="user32"/>
            <defineset define="QT3_SUPPORT"/>
        </build-app>
    </target>

    <target name="application.wise_driver_dll" depends="library.client_proxy" description="build Sword WISE driver dll" if="is-vc80">
        <build-lib name="wise_driver_dll" outtype="shared" mode="release" depends="boost,protobuf" suffix="-gd" pattern="MASAGroup.Sword@{suffix}"
            libs="Common,DriverBase,
                  Qt3Support4,
                  lib${ant.project.name}_client_proxy-${platform}-mt@{suffix},
                  lib${ant.project.name}_protocol-${platform}-mt@{suffix},
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix}">
            <includepath path="${include.dir}/wise"/>
            <defineset define="_USRDLL"/>
            <defineset define="DLLDRIVER_EXPORTS"/>
            <defineset define="QT3_SUPPORT"/>
        </build-lib>
    </target>

    <target name="application.mission_tester_app" depends="library.mission_tester" description="build Sword mission tester executable">
        <build-app name="mission_tester_app" depends="boost,protobuf,qt4,terrain,xalan,xerces"
            libs="lib${ant.project.name}_mission_tester-${platform}-mt@{suffix},
                  Qt3Support4,
                  lib${ant.project.name}_actions-${platform}-mt@{suffix},
                  lib${ant.project.name}_client_proxy-${platform}-mt@{suffix},
                  lib${ant.project.name}_clients_kernel-${platform}-mt@{suffix},
                  lib${ant.project.name}_MT_Tools-${platform}-mt,
                  lib${ant.project.name}_ENT-${platform}-mt@{suffix},
                  lib${ant.project.name}_protocol-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix}">
            <syslibset libs="geocoord"/>
            <defineset define="QT3_SUPPORT"/>
        </build-app>
    </target>

    <target name="application.edxlhave_app" depends="library.protocol" description="build edxl_app (Emergency Data Exchange)">
        <build-app name="edxlhave_app" depends="xerces,boost,protobuf,openssl" libs="lib${ant.project.name}_protocol-${platform}-mt@{suffix}" subsystem="console" >
            <includepath path="${out.dir}/release/libraries/protocol"/>
        </build-app>
    </target>

    <target name="application.launcher_test_app" depends="library.protocol,library.frontend,library.shield" description="build application">
        <build-app name="launcher_test_app" subsystem="console" depends="qt4,boost,xerces,protobuf"
            libs="lib${ant.project.name}_protocol-${platform}-mt@{suffix},
                  Qt3Support4,
                  lib${ant.project.name}_frontend-${platform}-mt,
                  lib${ant.project.name}_clients_kernel-${platform}-mt@{suffix},
                  lib${ant.project.name}_ENT-${platform}-mt@{suffix},
                  lib${ant.project.name}_MT_Tools-${platform}-mt,
                  lib${ant.project.name}_shield-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix}">
            <defineset define="QT3_SUPPORT"/>
        </build-app>
    </target>

    <target name="application.xml_signature_app" description="build application">
        <build-app name="xml_signature_app" subsystem="console" depends="boost" libs="tools">
            <defineset define="QT3_SUPPORT"/>
        </build-app>
    </target>

    <!--
    ============================================================================
    samples
    ============================================================================
    -->
    <target name="sample.client_sample_app" depends="library.protocol" description="build Sample client application">
        <build-app name="client_sample_app" depends="protobuf" root="${samples.dir}"
                   libs="lib${ant.project.name}_protocol-${platform}-mt@{suffix}" subsystem="console">
            <syslibset libs="wsock32"/>
            <includepath path="${out.dir}/release/libraries/protocol"/>
        </build-app>
    </target>

    <!--
    ============================================================================
    data
    ============================================================================
    -->
    <macrodef name="extract-knowledges">
        <attribute name="dir"/>
        <attribute name="tofile"/>
        <sequential>
            <concat destfile="@{tofile}" fixlastline="yes">
                <fileset dir="@{dir}" includes="**/*.xml"/>
                <filterchain>
                    <containsregex pattern='.*name="(.*)" source.*knowledge-class="(.*)">' replace='integration.taskKnowledge["\1"] = "\2"'/>
                </filterchain>
            </concat>
        </sequential>
    </macrodef>

    <target name="generate-database" description="compile behavior model database">
        <bmc src="${models.dir}/src" core="${models.dir}/directia.core/directia.core.bml" luac="false"/>
        <extract-knowledges dir="${models.dir}" tofile="${models.dir}/../integration/TaskKnowledge.lua"/>
    </target>

    <target name="generate-symbols" description="generate symbols">
        <zip destfile="${run.dir}/resources/symbols.pak">
            <fileset dir="${libraries.dir}/clients_gui/svg"/>
        </zip>
    </target>

    <target name="generate-signatures" depends="application.xml_signature_app" description="generate signatures">
        <exec executable="${out.dir}/release/applications/xml_signature_app/xml_signature_app.exe" dir="${run.dir}" failonerror="true" timeout="30000">
            <arg value="${data.dir}/data/models/ada/physical"/>
            <arg value="${data.dir}/data/terrains"/>
            <arg value="${data.dir}/exercises"/>
        </exec>
    </target>

    <target name="deploy-application-data" description="deploy applications data to run directory">
        <copy todir="${run.dir}">
            <fileset dir="${data.dir}/app-data"/>
        </copy>
    </target>

    <!--
    ============================================================================
    license
    ============================================================================
    -->
    <target name="generate-license" description="generate license files in run directory">
        <flexlm name="sword" feature="sword" vendor="bkmasa"/>
        <flexlm name="sword-gaming" feature="sword-gaming" vendor="bkmasa"/>
        <flexlm name="sword-dispatcher" feature="sword-dispatcher" vendor="bkmasa"/>
        <flexlm name="sword-authoring" feature="sword-authoring" vendor="bkmasa"/>
        <flexlm name="sword-preparation" feature="sword-preparation" vendor="bkmasa"/>
        <flexlm name="sword-workshop" feature="sword-workshop" vendor="bkmasa"/>
        <flexlm name="sword-terrain-generation" feature="sword-terrain-generation" vendor="bkmasa"/>
        <flexlm name="sword-runtime" feature="sword-runtime" vendor="bkmasa"/>
        <flexlm name="sword-replayer" feature="sword-replayer" vendor="bkmasa"/>
    </target>

    <!--
    ============================================================================
    tests
    ============================================================================
    -->
    <target name="test" depends="generate-license,scripts_test,adaptation_test,tools_test,3a_test,plugins_test,hla_plugin_test,
                                 shield_test,clients_test,exercises_test,data_migrations_test,dispatcher_test,application.simulation_kernel_test,
                                 application.integration_decisionnal_test,protocol_test,checkpoint_test,import_test,positions_plugin_test,
                                 actions_test,launcher_test,reports_test,flood_test" description="run all tests"/>

    <target name="3a_test" depends="library.3a">
        <build-test name="3a" depends="xerces,terrain,boost,protobuf" libs="lib${ant.project.name}_3a-${platform}-mt@{suffix},lib${ant.project.name}_protocol-${platform}-mt"/>
    </target>

    <target name="tools_test" depends="library.tools">
        <build-test name="tools" depends="boost,xerces,xalan" 
            libs="lib${ant.project.name}_tools-${platform}-mt@{suffix},
                  tools,
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix}"/>
    </target>

    <target name="plugins_test" depends="library.hla_plugin,library.tic,library.script_plugin,library.bml_plugin,library.crossbow_plugin,library.timeline_plugin">
        <build-test name="plugins" depends="xerces,terrain,boost,openssl,protobuf,qt4"
            libs="directia-${platform}-mt-4_6,gdal_i,
                  Qt3Support4,
                  lib${ant.project.name}_tools-${platform}-mt,
                  lib${ant.project.name}_ENT-${platform}-mt,
                  lib${ant.project.name}_clients_kernel-${platform}-mt@{suffix},
                  lib${ant.project.name}_rpr-${platform}-mt@{suffix},
                  lib${ant.project.name}_tic-${platform}-mt@{suffix},
                  lib${ant.project.name}_bml_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_script_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_timeline_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_crossbow_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_protocol-${platform}-mt">
            <defineset define="QT3_SUPPORT"/>
        </build-test>
    </target>

    <target name="hla_plugin_test" depends="library.hla_plugin" if="is-vc80">
        <build-test name="hla_plugin" depends="boost,qt4,terrain,xerces,protobuf"
            libs="HLA,
                  Qt3Support4,
                  lib${ant.project.name}_clients_kernel-${platform}-mt@{suffix},
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_ENT-${platform}-mt@{suffix},
                  lib${ant.project.name}_protocol-${platform}-mt@{suffix},
                  lib${ant.project.name}_rpr-${platform}-mt@{suffix},
                  lib${ant.project.name}_hla_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix}">
            <syslibset libs="shell32,user32,wsock32"/>
            <defineset define="QT3_SUPPORT"/>
        </build-test>
    </target>

    <target name="shield_test" depends="library.shield">
        <build-test name="shield" depends="boost,protobuf" excludes="**/*.h"
            libs="lib${ant.project.name}_tools-${platform}-mt,
                 lib${ant.project.name}_MT_Tools-${platform}-mt,
                 lib${ant.project.name}_shield-${platform}-mt,
                 lib${ant.project.name}_protocol-${platform}-mt"/>
    </target>

    <target name="clients_test" depends="library.indicators,library.preparation">
        <build-test name="clients" depends="terrain,boost,qt4,xerces,xalan,protobuf"
            libs="svgl,zipstream,zlib1,Qt3Support4,
                  lib${ant.project.name}_tools-${platform}-mt,
                  lib${ant.project.name}_ENT-${platform}-mt,
                  lib${ant.project.name}_indicators-${platform}-mt,
                  lib${ant.project.name}_clients_gui-${platform}-mt,
                  lib${ant.project.name}_clients_kernel-${platform}-mt,
                  lib${ant.project.name}_MT_Tools-${platform}-mt,
                  lib${ant.project.name}_preparation-${platform}-mt,
                  lib${ant.project.name}_flood-${platform}-mt,
                  lib${ant.project.name}_meteo-${platform}-mt,
                  lib${ant.project.name}_protocol-${platform}-mt">
            <syslibset libs="gdi32"/>
            <defineset define="QT3_SUPPORT"/>
        </build-test>
    </target>

    <target name="actions_test" depends="library.actions">
        <build-test name="actions" depends="terrain,boost,qt4,xerces,xalan,protobuf"
            libs="Qt3Support4,
                  lib${ant.project.name}_tools-${platform}-mt,
                  lib${ant.project.name}_ENT-${platform}-mt,
                  lib${ant.project.name}_actions-${platform}-mt,
                  lib${ant.project.name}_clients_kernel-${platform}-mt,
                  lib${ant.project.name}_MT_Tools-${platform}-mt,
                  lib${ant.project.name}_protocol-${platform}-mt">
            <defineset define="QT3_SUPPORT"/>
        </build-test>
    </target>

    <target name="dispatcher_test" depends="library.dispatcher,library.messenger_plugin">
        <build-test name="dispatcher" depends="boost,qt4,xerces,xalan,terrain,protobuf"
            libs="Qt3Support4,
                  lib${ant.project.name}_clients_kernel-${platform}-mt,
                  lib${ant.project.name}_MT_Tools-${platform}-mt,
                  lib${ant.project.name}_messenger_plugin-${platform}-mt@{suffix},
                  lib${ant.project.name}_ENT-${platform}-mt@{suffix},
                  lib${ant.project.name}_dispatcher-${platform}-mt,
                  lib${ant.project.name}_tools-${platform}-mt,
                  lib${ant.project.name}_protocol-${platform}-mt">
            <defineset define="QT3_SUPPORT"/>
        </build-test>
    </target>

    <target name="import_test" depends="library.import">
        <build-test name="import" depends="boost,xerces" libs="geocoord,lib${ant.project.name}_import-${platform}-mt"/>
    </target>

    <target name="launcher_test" depends="application.launcher_dll,library.frontend">
        <build-test name="launcher" depends="boost,qt4,xerces,protobuf"
            libs="Qt3Support4,
                  launcher-${platform}-mt@{suffix},tools,
                  lib${ant.project.name}_frontend-${platform}-mt,
                  lib${ant.project.name}_clients_kernel-${platform}-mt,
                  lib${ant.project.name}_MT_Tools-${platform}-mt,
                  lib${ant.project.name}_ENT-${platform}-mt,
                  lib${ant.project.name}_tools-${platform}-mt,
                  lib${ant.project.name}_protocol-${platform}-mt">
            <defineset define="QT3_SUPPORT"/>
            <syslibset libs="shell32"/>
        </build-test>
    </target>

    <target name="mission_tester_test" depends="library.mission_tester">
        <build-test name="mission_tester" depends="boost,protobuf,qt4,terrain,xalan,xerces"
            libs="Qt3Support4,
                  lib${ant.project.name}_mission_tester-${platform}-mt,
                  lib${ant.project.name}_client_proxy-${platform}-mt,
                  lib${ant.project.name}_actions-${platform}-mt,
                  lib${ant.project.name}_clients_kernel-${platform}-mt,
                  lib${ant.project.name}_MT_Tools-${platform}-mt,
                  lib${ant.project.name}_tools-${platform}-mt,
                  lib${ant.project.name}_protocol-${platform}-mt,
                  lib${ant.project.name}_ENT-${platform}-mt">
            <syslibset libs="geocoord"/>
            <defineset define="QT3_SUPPORT"/>
        </build-test>
    </target>

    <target name="flood_test" depends="library.flood">
        <build-test name="flood" depends="boost" libs="lib${ant.project.name}_flood-${platform}-mt"/>
    </target>

    <target name="positions_plugin_test" depends="library.protocol,library.positions_plugin">
        <build-test name="positions_plugin" depends="boost,protobuf"
            libs="lib${ant.project.name}_positions_plugin-${platform}-mt,lib${ant.project.name}_protocol-${platform}-mt"/>
    </target>

    <macrodef name="run-simulation">
        <attribute name="exercise"/>
        <attribute name="session" default="default"/>
        <element name="args" implicit="true" optional="true"/>
        <sequential>
            <math result="test.portnumber2">
                <op op="+" datatype="int">
                    <num value="${test.portnumber}"/>
                    <num value="1"/>
                </op>
            </math>
            <exec executable="${out.dir}/release/applications/simulation_app/simulation_app.exe" dir="${run.dir}" failonerror="true" timeout="600000">
                <arg value="--root-dir=../../data"/>
                <arg value="--exercise=@{exercise}"/>
                <arg value="--session=@{session}"/>
                <arg value="--simulation-port=${test.portnumber}"/>
                <arg value="--dispatcher-port=${test.portnumber2}"/>
                <arg value="--test"/>
                <args/>
            </exec>
        </sequential>
    </macrodef>

    <target name="checkpoint_test" depends="application.simulation_app" description="save and load a checkpoint">
        <run-simulation exercise="france/CheckpointTests">
            <arg value="--savecheckpoint=tempcheckpoint"/>
        </run-simulation>
        <run-simulation exercise="france/CheckpointTests">
            <arg value="--checkpoint=tempcheckpoint"/>
            <arg value="--deletecheckpoint"/>
        </run-simulation>
    </target>

    <macrodef name="test-scripts">
        <attribute name="dataset"/>
        <attribute name="physical"/>
        <attribute name="simulation" default="simulation_app"/>
        <sequential>
            <delete dir="${data.dir}/exercises/scripts_test"/>
            <copy todir="${data.dir}/exercises/scripts_test" overwrite="true">
                <fileset dir="${data.dir}/tests/scripts_test" includes="**/*.xml"/>
                <filterset>
                    <filter token="DATASET" value="@{dataset}"/>
                    <filter token="PHYSICAL" value="@{physical}"/>
                </filterset>
            </copy>
            <run-simulation exercise="scripts_test" session="test-session"/>
            <delete dir="${data.dir}/exercises/scripts_test"/>
        </sequential>
    </macrodef>

    <target name="scripts_test" description="run all script tests">
        <test-scripts dataset="ada" physical="france"/>
        <test-scripts dataset="ada" physical="scipio"/>
        <!--
        <test-scripts dataset="ada" physical="security-fr"/>
        -->
        <test-scripts dataset="ada" physical="worldwide"/>
    </target>

    <macrodef name="echo-files">
        <attribute name="files"/>
        <attribute name="prefix" default=""/>
        <sequential>
            <for list="@{files}" param="file" delimiter=";">
                <sequential>
                    <echo>@{prefix}@{file}</echo>
                </sequential>
            </for>
        </sequential>
    </macrodef>

    <macrodef name="compare-dirs">
        <attribute name="dir1"/>
        <attribute name="dir2"/>
        <attribute name="excludes" default=""/>
        <attribute name="includes" default=""/>
        <attribute name="property"/>
        <sequential>
            <fileset id="@{dir1}.id" dir="@{dir1}" excludes="@{excludes}" includes="@{includes}">
                <different targetdir="@{dir2}" ignorefiletimes="true"/>
            </fileset>
            <pathconvert property="@{property}.@{dir1}" refid="@{dir1}.id" setonempty="false"/>
            <fileset id="@{dir2}.id" dir="@{dir2}" excludes="@{excludes}" includes="@{includes}">
                <different targetdir="@{dir1}" ignorefiletimes="true"/>
            </fileset>
            <pathconvert property="@{property}.@{dir2}" refid="@{dir2}.id" setonempty="false"/>
            <if>
                <and>
                    <isset property="@{property}.@{dir1}"/>
                    <isset property="@{property}.@{dir2}"/>
                </and>
                <then>
                    <property name="@{property}" value="${@{property}.@{dir1}};${@{property}.@{dir2}}"/>
                </then>
            </if>
            <if>
                <isset property="@{property}.@{dir1}"/>
                <then>
                    <property name="@{property}" value="${@{property}.@{dir1}}"/>
                </then>
            </if>
            <if>
                <isset property="@{property}.@{dir2}"/>
                <then>
                    <property name="@{property}" value="${@{property}.@{dir2}}"/>
                </then>
            </if>
        </sequential>
    </macrodef>

    <macrodef name="run-adaptation">
        <attribute name="input"/>
        <attribute name="output"/>
        <sequential>
            <exec executable="${out.dir}/release/applications/adaptation_app/adaptation_app.exe" dir="${run.dir}" failonerror="true" timeout="600000">
                <arg value="-i"/>
                <arg value="@{input}/physical.xml"/>
                <arg value="-o"/>
                <arg value="@{output}/physical.xml"/>
            </exec>
        </sequential>
    </macrodef>

    <macrodef name="test-adaptation">
        <attribute name="input"/>
        <sequential>
            <echo>Testing models: @{input}</echo>
            <delete dir="${out.dir}/test-adaptation"/>
            <run-adaptation input="@{input}" output="${out.dir}/test-adaptation"/>
            <compare-dirs dir1="@{input}" dir2="${out.dir}/test-adaptation"
                excludes="**/Pathfind.xml,**/dis.xml,**/HumanProtections.xml,**/Fire.xml,**/MedicalTreatment.xml,**/NBCAgents.xml,**/templates.xml,**/ObjectNames.xml,**/mapping.xml,**/DrawingTemplates.xml,**/FOM.xml,**/Extensions.xml,**/scores.xml,**/symbols.xml,**/Filters,**/Filters/**"
                includes="**/*.xml" property="adaptation_test.is-different"/>
            <if>
                <isset property="adaptation_test.is-different"/>
                <then>
                    <echo>ERROR: the following files differ :</echo>
                    <echo-files files="${adaptation_test.is-different}" prefix="ERROR: "/>
                    <echo>ERROR: did you forget to run 'ant generate-signatures' ?</echo>
                    <fail message="saved data differ from loaded data."/>
                </then>
            </if>
            <delete dir="${out.dir}/test-adaptation"/>
        </sequential>
    </macrodef>

    <target name="adaptation_test" description="load and save adaptation main data then check that output is the same as input">
        <test-adaptation input="${data.dir}/data/models/ada/physical/france"/>
        <test-adaptation input="${data.dir}/data/models/ada/physical/scipio"/>
        <test-adaptation input="${data.dir}/data/models/ada/physical/security-fr"/>
        <test-adaptation input="${data.dir}/data/models/ada/physical/worldwide"/>
    </target>

    <target name="application.simulation_kernel_test" depends="library.simulation_kernel" description="build Sword Simulation kernel test executable">
        <build-test name="simulation_kernel"
                   libs="masalloc,tools,directia-${platform}-mt-4_6,library-${platform}-mt,
                         gdal_i,gdal_ogr,log4cxx,geodata,analysis,
                         dispatcher-${platform}-mt@{suffix},
                         lib${ant.project.name}_tools-${platform}-mt@{suffix},
                         lib${ant.project.name}_clients_kernel-${platform}-mt,
                         lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                         lib${ant.project.name}_ENT-${platform}-mt,
                         lib${ant.project.name}_protocol-${platform}-mt@{suffix},
                         lib${ant.project.name}_simulation_terrain-${platform}-mt@{suffix},
                         lib${ant.project.name}_resource_network-${platform}-mt@{suffix},
                         lib${ant.project.name}_meteo-${platform}-mt@{suffix},
                         lib${ant.project.name}_flood-${platform}-mt@{suffix},
                         lib${ant.project.name}_simulation_kernel-${platform}-mt@{suffix}"
            depends="xerces,xalan,terrain,boost,qt4,protobuf">
            <syslibset libs="dbghelp,psapi,shell32,iphlpapi,advapi32"/>
            <includepath path="${libraries.dir}/simulation_kernel"/>
            <linkerarg value="/STACK:15000000"/>      <!-- Because of boost serialization -->
        </build-test>
    </target>

    <target name="application.integration_decisionnal_test" description="build Sword Integration DIA5 test executable">
        <build-test name="integration_decisionnal" depends="boost" libs="directia-${platform}-mt-4_6" dir="../../data/data/models/ada/decisional/directia5">
            <includepath path="${libraries.dir}/simulation_kernel"/>
            <defineset>
                <define name="PLATFORM" value="${platform}"/>
            </defineset>
        </build-test>
    </target>

    <macrodef name="test-exercise">
        <attribute name="exercise"/>
        <attribute name="session" default="default"/>
        <attribute name="simulation" default="simulation_app"/>
        <sequential>
            <schemavalidate nonamespacefile="${run.dir}/resources/schemas/${version.major}/exercise/exercise.xsd" file="../data/exercises/@{exercise}/exercise.xml" failonerror="true" warn="true"/>
            <schemavalidate nonamespacefile="${run.dir}/resources/schemas/${version.major}/exercise/orbat.xsd" file="../data/exercises/@{exercise}/orbat.xml" failonerror="true" warn="true"/>
            <schemavalidate nonamespacefile="${run.dir}/resources/schemas/${version.major}/exercise/profiles.xsd" file="../data/exercises/@{exercise}/profiles.xml" failonerror="true" warn="true"/>
            <schemavalidate nonamespacefile="${run.dir}/resources/schemas/${version.major}/exercise/weather.xsd" file="../data/exercises/@{exercise}/weather.xml" failonerror="true" warn="true"/>
            <schemavalidate nonamespacefile="${run.dir}/resources/schemas/${version.major}/exercise/session.xsd" file="../data/exercises/@{exercise}/sessions/@{session}/session.xml" failonerror="true" warn="true"/>
            <run-simulation exercise="@{exercise}" session="@{session}"/>
        </sequential>
    </macrodef>

    <target name="exercises_test" description="validates some significant exercises">
        <test-exercise exercise="worldwide/Egypt"/>
        <test-exercise exercise="france/Cabourg"/>
        <test-exercise exercise="scipio/Poseidon VA"/>
    </target>

    <macrodef name="test-data-migration">
        <attribute name="exercise"/>
        <attribute name="old-version"/>
        <attribute name="session" default="default"/>
        <attribute name="temporary-name" default="test-data-migration"/>
        <sequential>
            <echo>Testing automatic migration from version @{old-version} using exercise '@{exercise}'</echo>
            <!-- Copy physical database -->
            <delete dir="${data.dir}/data/models/ada/physical/@{temporary-name}" failonerror="false"/>
            <copy todir="${data.dir}/data/models/ada/physical/@{temporary-name}">
                <fileset dir="../data/tests/test_data_migration/@{old-version}/physical"/>
            </copy>
            <!-- ADN -->
            <delete dir="${out.dir}/@{temporary-name}"/>
            <run-adaptation input="${data.dir}/data/models/ada/physical/@{temporary-name}" output="${out.dir}/@{temporary-name}"/>
            <!-- Copy exercise -->
            <delete dir="${data.dir}/exercises/@{temporary-name}" failonerror="false"/>
            <copy todir="${data.dir}/exercises/@{temporary-name}">
                <fileset dir="../data/tests/test_data_migration/@{old-version}/exercises/@{exercise}"/>
                <filterset>
                    <filter token="DATASET" value="ada"/>
                    <filter token="PHYSICAL" value="@{temporary-name}"/>
                </filterset>
            </copy>
            <!-- SIM -->
            <run-simulation exercise="@{temporary-name}" session="@{session}"/>
            <!-- cleanup -->
            <delete dir="${out.dir}/@{temporary-name}"/>
            <delete dir="${data.dir}/data/models/ada/physical/@{temporary-name}"/>
            <delete dir="${data.dir}/exercises/@{temporary-name}"/>
        </sequential>
    </macrodef>

    <target name="data_migrations_test">
        <test-data-migration old-version="3.0" exercise="CabourgOld"/>
        <test-data-migration old-version="4.2.0" exercise="Cabourg"/>
        <test-data-migration old-version="4.2.1" exercise="Cabourg"/>
        <test-data-migration old-version="4.2.2" exercise="Cabourg"/>
        <!--
        <test-data-migration old-version="4.2.0" exercise="BMDrosoville"/>
        <test-data-migration old-version="4.2.1" exercise="BMDrosoville"/>
        <test-data-migration old-version="4.2.2" exercise="BMDrosoville"/>
        <test-data-migration old-version="4.3.0" exercise="Cabourg"/>
        <test-data-migration old-version="4.3.0" exercise="BMDrosoville"/>
        -->
    </target>

    <target name="protocol_test" description="build protocol test application" depends="library.protocol,library.tools">
        <build-test name="protocol" depends="boost,protobuf"
            libs="masalloc,
                  lib${ant.project.name}_MT_Tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_tools-${platform}-mt@{suffix},
                  lib${ant.project.name}_protocol-${platform}-mt@{suffix}"/>
    </target>

    <macrodef name="count">
        <attribute name="property"/>
        <attribute name="string"/>
        <attribute name="file"/>
        <sequential>
            <resourcecount property="@{property}">
                <tokens>
                    <concat>
                      <filterchain>
                          <tokenfilter>
                              <containsstring contains="@{string}"/>
                          </tokenfilter>
                      </filterchain>
                      <fileset file="@{file}"/>
                    </concat>
                </tokens>
            </resourcecount>
        </sequential>
    </macrodef>

    <target name="reports_test" description="check that ada/physical/france/Reports.xml and ada/physical/worldwide/Reports.xml contain the same amount of reports">
        <count property="reports_test.worldwide" string="report id=" file="${data.dir}/data/models/Ada/physical/worldwide/Reports.xml"/>
        <count property="reports_test.france" string="report id=" file="${data.dir}/data/models/Ada/physical/france/Reports.xml"/>
        <fail message="File 'reports.xml' from physical databases doesn't contain the same amount of entries - France:${reports_test.france} vs Worldwide:${reports_test.worldwide}">
            <condition>
                <not>
                    <equals arg1="${reports_test.worldwide}" arg2="${reports_test.france}"/>
                </not>
            </condition>
        </fail>
    </target>

    <!--
    ============================================================================
    documentation
    ============================================================================
    -->
    <target name="documentation" description="generate SWORD SDK documentation">
        <doxygen-report name="sword" input="${src.dir}/libraries/protocol/proto" outdir="${out.dir}/sdk">
            <property name="PROJECT_NAME" value="SWORD - API Reference"/>
            <property name="PROJECT_NUMBER" value="${version.major}"/>
            <property name="FILE_PATTERNS" value='"*.proto *.dox"'/>
            <property name="EXCLUDE_PATTERNS" value='"*launcher* *dispatcher_simulation*"'/>
            <property name="FILTER_PATTERNS" value="*.proto=protofilter.py"/>
            <property name="COLLABORATION_GRAPH" value="NO"/>
            <property name="EXTRACT_ALL" value="NO"/>
            <property name="DISABLE_INDEX" value="NO"/>
            <!--
            <property name="GENERATE_DEPRECATEDLIST" value="NO"/>
            <property name="GENERATE_TODOLIST" value="NO"/>
            <property name="GENERATE_BUGLIST" value="NO"/>
            -->
            <property name="SHOW_USED_FILES" value="NO"/>
            <property name="SHOW_FILES" value="NO"/>
            <property name="SHOW_NAMESPACES" value="NO"/>
            <property name="BRIEF_MEMBER_DESC" value="NO"/>
            <property name="ENUM_VALUES_PER_LINE" value="1"/>
            <property name="WARNINGS" value="YES"/>
            <property name="ALIASES" value='""rule=@par Rule:\n" "index=@par Index:\n" "default=@par Default value:\n""'/>
            <property name="WARN_LOGFILE" value="${reports.dir}/doxygen.log"/>
            <property name="GENERATE_HTMLHELP" value="YES"/>
            <property name="CHM_FILE" value="${dist.dir}/SWORD-API_Reference_${version.major}.chm"/>
            <property name="EXAMPLE_PATH" value="${data.dir}\app-data\resources\schemas\${version.major}"/>
            <property name="EXAMPLE_RECURSIVE" value="YES"/>
            <property name="EXAMPLE_PATTERN" value="*.h *.cpp *.xsd"/>
        </doxygen-report>
        <fail message="documentation contains errors, see ${reports.dir}/doxygen.log">
            <condition>
                <length file="${reports.dir}/doxygen.log" when="greater" length="0"/>
            </condition>
        </fail>
        <htmlhelp input="${out.dir}/sdk" outdir="${dist.dir}"/>
    </target>

    <!--
    ============================================================================
    package
    ============================================================================
    -->
    <target name="package" depends="package.app,package.debug,package.otpacks,package.wise-driver,package.ts,package.plugins" description="package the installers and packs"/>

    <!-- Package plugins -->
    <target name="package.plugins" depends="package.plugin.vrforces,package.plugin.hla,package.plugin.bml,package.plugin.dis,package.plugin.timeline,package.plugin.crossbow" description="package plugin individual installers"/>

    <target name="package.plugin.vrforces" description="create vrforces plugin installer" if="is-vc80">
        <nsis name="sword-plugin" script="sword-plugin.nsi" license="true">
            <arg value="/DAPP_VERSION_MAJOR=${version.major}"/>
            <arg value="/DAPP_VERSION_MINOR=${version.minor}"/>
            <arg value="/DPLUGIN=plugin-vrforces"/>
            <arg value="/DPLUGIN_VERSION=1.0"/>
        </nsis>
    </target>

    <target name="package.plugin.hla" description="create hla plugin installer">
        <nsis name="sword-plugin" script="sword-plugin.nsi" license="true">
            <arg value="/DAPP_VERSION_MAJOR=${version.major}"/>
            <arg value="/DAPP_VERSION_MINOR=${version.minor}"/>
            <arg value="/DPLUGIN=plugin-hla"/>
            <arg value="/DPLUGIN_VERSION=1.0"/>
        </nsis>
    </target>

	<target name="package.plugin.bml" description="create bml plugin installer">
        <nsis name="sword-plugin" script="sword-plugin.nsi" license="true">
            <arg value="/DAPP_VERSION_MAJOR=${version.major}"/>
            <arg value="/DAPP_VERSION_MINOR=${version.minor}"/>
            <arg value="/DPLUGIN=plugin-bml"/>
            <arg value="/DPLUGIN_VERSION=1.0"/>
        </nsis>
    </target>
	
    <target name="package.plugin.dis" description="create dis plugin installer">
        <nsis name="sword-plugin" script="sword-plugin.nsi" license="true">
            <arg value="/DAPP_VERSION_MAJOR=${version.major}"/>
            <arg value="/DAPP_VERSION_MINOR=${version.minor}"/>
            <arg value="/DPLUGIN=plugin-dis"/>
            <arg value="/DPLUGIN_VERSION=1.0"/>
        </nsis>
    </target>

    <target name="package.plugin.timeline" description="create timeline plugin installer">
        <nsis name="sword-plugin" script="sword-plugin.nsi" license="true">
            <arg value="/DAPP_VERSION_MAJOR=${version.major}"/>
            <arg value="/DAPP_VERSION_MINOR=${version.minor}"/>
            <arg value="/DPLUGIN=plugin-timeline"/>
            <arg value="/DPLUGIN_VERSION=1.0"/>
        </nsis>
    </target>

    <target name="package.plugin.crossbow" description="create crossbow plugin installer">
        <nsis name="sword-plugin" script="sword-plugin.nsi" license="true">
            <arg value="/DAPP_VERSION_MAJOR=${version.major}"/>
            <arg value="/DAPP_VERSION_MINOR=${version.minor}"/>
            <arg value="/DPLUGIN=plugin-crossbow"/>
            <arg value="/DPLUGIN_VERSION=1.0"/>
        </nsis>
    </target>

    <!-- Package misc -->
    <target name="package.patch" description="create a patch installer">
        <nsis name="sword-patch" script="patchs/sword-patch.nsi" license="true">
            <arg value="/DAPP_VERSION_MAJOR=${version.major}"/>
            <arg value="/DAPP_VERSION_MINOR=${version.minor}"/>
            <arg value="/X!include sword-defense.nsh"/>
        </nsis>
    </target>

    <target name="package.debug" description="create a zip with all PDB files">
        <copy todir="${out.dir}/pdb" flatten="true">
            <fileset dir="${out.dir}/release" includes="**/*.pdb"/>
        </copy>
        <zip destfile="${dist.dir}/SWORD_debug_${platform}_${version.major}.zip">
            <fileset dir="${out.dir}/pdb" includes="*.pdb"/>
        </zip>
    </target>

    <target name="package.ts" description="create a zip with all ts files">
        <copy todir="${out.dir}/ts" flatten="true">
            <fileset dir="${src.dir}" includes="**/*.ts"/>
        </copy>
        <zip destfile="${dist.dir}/SWORD_ts_${version.major}.zip">
            <fileset dir="${out.dir}/ts" includes="*.ts"/>
        </zip>
    </target>

    <target name="package.wise-driver" depends="application.wise_driver_dll" description="package the wise driver installer" if="is-vc80">
        <nsis name="sword-wise_driver" script="sword-wise_driver.nsi">
            <arg value="/DAPP_VERSION_MAJOR=${version.major}"/>
            <arg value="/DAPP_VERSION_MINOR=${version.minor}"/>
        </nsis>
    </target>

    <!-- Package Application -->
    <target name="package.app" description="package des applications runtime">
        <nsis name="sword" script="sword.nsi" nsh="config.nsh">
            <arg value="/DAPP_VERSION_MAJOR=${version.major}"/>
            <arg value="/DAPP_VERSION_MINOR=${version.minor}"/>
            <arg value="/X!include sword-defense.nsh"/>
        </nsis>
    </target>

    <!-- Package packs -->
    <macrodef name="pack">
        <attribute name="name"/>
        <attribute name="description"/>
        <element name="elements" implicit="yes"/>
        <sequential>
            <echoxml file="${out.dir}/content.xml">
                <content>
                    <name>@{name}</name>
                    <description>@{description}</description>
                </content>
            </echoxml>
            <zip destfile="${dist.dir}/SWORD_@{name}_${version.major}.otpak" filesonly="true">
                <fileset dir="${data.dir}">
                    <elements/>
                </fileset>
                <fileset dir="${out.dir}" includes="content.xml"/>
            </zip>
            <delete file="${out.dir}/content.xml"/>
        </sequential>
    </macrodef>

    <target name="package.otpacks" depends="package.otpack.defense.worldwide,package.otpack.defense.france,
                                            package.otpack.defense.scipio,package.otpack.defense.scipio.VA,package.otpack.security.worldwide,package.otpack.security.masa,
                                            package.otpack.lossc,package.otpack.trainingML,package.otpack.decisional3,package.otpack.decisional4,package.otpack.decisional5"
                                   description="package the exercise otpacks"/>

    <target name="package.otpack.defense.worldwide" description="package du defense-worldwide otpack">
        <pack name="defense-worldwide" description="defense-worldwide exercises package">
            <include name="data/models/ada/physical/worldwide/**"/>
            <include name="exercises/worldwide/Egypt/**"/>
            <include name="exercises/worldwide/Paris/**"/>
            <include name="exercises/worldwide/9_cases/**"/>
            <include name="exercises/worldwide/Musoria Border Defense/**"/>
            <include name="data/terrains/Nord egypt/**"/>
            <include name="data/terrains/Paris_Est/**"/>
            <include name="data/terrains/Angers_x9_en/**"/>
            <include name="exercises/worldwide/Tuto_sw/**"/>
            <include name="data/terrains/Sw_terrain2/**"/>
            <include name="exercises/worldwide/tutorials/01 - Generalities/**"/>
            <include name="exercises/worldwide/tutorials/02 - Gaming/**"/>
            <include name="exercises/worldwide/tutorials/03 - Missions/**"/>
            <include name="exercises/worldwide/tutorials/04 - Armor units/**"/>
            <include name="exercises/worldwide/tutorials/05 - Infantry/**"/>
            <include name="exercises/worldwide/tutorials/06 - Engineering/**"/>
            <include name="exercises/worldwide/tutorials/07 - Artillery/**"/>
            <include name="exercises/worldwide/tutorials/08 - Logistic/**"/>
            <include name="exercises/worldwide/tutorials/09 - Air units/**"/>
            <include name="exercises/worldwide/tutorials/10 - NBC/**"/>
            <include name="exercises/worldwide/tutorials/11 - Preparation/**"/>
            <include name="exercises/worldwide/tutorials/12 - AAR/**"/>
            <include name="exercises/worldwide/tutorials/13 - Advanced features/**"/>          
        </pack>
    </target>

    <target name="package.otpack.defense.france" description="package du defense-france otpack">
        <pack name="defense-france" description="defense-france exercises package">
            <include name="data/models/ada/physical/france/**"/>
            <include name="data/propagations/test/**"/>
            <include name="exercises/france/Cabourg/**"/>
            <include name="exercises/france/BMDrosoville/**"/>
            <include name="exercises/france/TerrainDifficile/**"/>
            <include name="exercises/scipio/Poseidon VA/**"/>
            <include name="exercises/france/tutorials/01 - Generalites/**"/>
            <include name="exercises/france/tutorials/02 - Jeu/**"/>
            <include name="exercises/france/tutorials/03 - Mission/**"/>
            <include name="exercises/france/tutorials/04 - ABC/**"/>
            <include name="exercises/france/tutorials/05 - Infanterie/**"/>
            <include name="exercises/france/tutorials/06 - Genie/**"/>
            <include name="exercises/france/tutorials/07 - Artillerie/**"/>
            <include name="exercises/france/tutorials/071 - NRBC/**"/>
            <include name="exercises/france/tutorials/072 - ALAT/**"/>
            <include name="exercises/france/tutorials/073 - LOG/**"/>
            <include name="exercises/france/tutorials/08 - Fonctions Avancees/**"/>
            <include name="exercises/france/tutorials/09 - Rejeu et AAA/**"/>
            <include name="exercises/france/tutorials/10 - Preparation/**"/>
            <include name="exercises/france/tests/capteurs/**"/>
            <include name="exercises/france/tests/capteurs-delai/**"/>
            <include name="exercises/france/tests/nested_knowledge_groups/**"/>
            <include name="exercises/france/tests/suicide/**"/>
            <include name="exercises/scipio/tests/Test1_9_2/**"/>
            <include name="exercises/france/tests/ValidationTests/**"/>
            <include name="exercises/france/tests/ValidationTests aux tomates/**"/>
            <include name="exercises/france/tests/ValidationTests LOG/**"/>
            <include name="exercises/scipio/tests/ValidationTests LOG 1_9_2/**"/>
            <include name="exercises/france/tests/Water/**"/>
            <include name="exercises/france/tests/missions/**"/>
            <include name="exercises/france/tests/embrayer/**"/>
            <include name="exercises/france/tests/jamming-shoot/**"/>
            <include name="exercises/france/tests/attrition/**"/>
            <include name="exercises/france/tests/coi/**"/>
            <include name="exercises/france/tests/Meteo/**"/>
            <include name="exercises/france/tests/embrayerAuto/**"/>
            <include name="data/terrains/Nord egypt/**"/>
            <include name="data/terrains/Paris_Est/**"/>
            <include name="data/terrains/Malaisie/**"/>
            <include name="data/terrains/Cabourg/**"/>
            <include name="data/terrains/Drosoville_France/**"/>
            <include name="data/terrains/Angers_x9/**"/>
            <include name="data/terrains/PortoV3Lite/**"/>
        </pack>
    </target>

    <target name="package.otpack.defense.scipio" description="package du defense-scipio Referentiel Simulation otpack">
        <pack name="defense-scipio-RefSim" description="defense-scipio exercises package">
            <include name="data/models/ada/decisional/bms/**"/>
            <include name="data/models/ada/decisional/directia5/**"/>
            <include name="data/models/ada/decisional/decisional.xml"/>
            <include name="data/models/ada/physical/scipio/**"/>
        </pack>
    </target>

    <target name="package.otpack.defense.scipio.VA" description="package du defense-scipio Validation Amont otpack">
        <pack name="defense-scipio-VA" description="defense-scipio Validation Amont exercises package">
            <include name="exercises/scipio/exercisesVA/Poseidon VA Missions Communes/**"/>
            <include name="exercises/scipio/exercisesVA/Poseidon VA pions/**"/>
            <include name="exercises/scipio/exercisesVA/Poseidon VA AppuiCombat/**"/>
            <include name="exercises/scipio/exercisesVA/Poseidon VA Automates/**"/>
            <include name="exercises/scipio/exercisesVA/Poseidon VA Acteurs Civils/**"/>
            <include name="exercises/scipio/exercisesVA/Poseidon VA Soutien/**"/>
            <include name="exercises/scipio/exercisesVA/Poseidon VA Mix/**"/>
            <include name="exercises/scipio/exercisesVA/VEM_Foule/**"/>
            <include name="exercises/scipio/exercisesVA/VEM_Meteo/**"/>
            <include name="exercises/scipio/exercisesVA/VEM_DPRE/**"/>
            <include name="exercises/scipio/exercisesVA/VEM_Detection/**"/>
            <include name="exercises/scipio/exercisesVA/VEM_Humain/**"/>
            <include name="exercises/scipio/exercisesVA/VEM_Objet/**"/>
            <include name="exercises/scipio/exercisesVA/VEM_Transport/**"/>            
            <include name="data/terrains/PortoV3Lite/**"/>
        </pack>
    </target>

    <target name="package.otpack.security.worldwide" description="package du security-worldwide otpack">
        <pack name="security-worldwide" description="security-worldwide exercises package">
            <include name="data/models/ada/physical/worldwide/**"/>
            <include name="data/models/ada/physical/security-fr/**"/>
            <include name="data/propagations/test/**"/>
            <include name="exercises/security/CODAH_JANUS/**"/>
            <include name="data/terrains/lehavre_4.2.0/**"/>
        </pack>
    </target>

    <target name="package.otpack.security.masa" description="package du security-masa otpack">
        <pack name="security-masa" description="security-masa exercises package">
            <include name="data/models/ada/physical/security-fr/**"/>
            <include name="data/propagations/test/**"/>
            <include name="exercises/security/CODAH_JANUS/**"/>
            <include name="data/terrains/lehavre_4.2.0/**"/>
        </pack>
    </target>

    <target name="package.otpack.lossc" description="package du LOSSC otpack">
        <pack name="LOSSC" description="LOSSC exercises package">
            <include name="exercises/worldwide/LOSSC Scenario 1/**"/>
            <include name="exercises/worldwide/LOSSC Scenario 2/**"/>
            <include name="exercises/worldwide/LOSSC Scenario 3/**"/>
            <include name="data/terrains/afghan_kabuldist/**"/>
        </pack>
    </target>

    <target name="package.otpack.trainingML" description="package de training MasaLife">
        <pack name="trainingML" description="package de training MasaLife">
            <include name="data/models/training/physical/worldwide/**"/>
            <include name="data/models/training/decisional/**"/>
            <include name="exercises/worldwide/Training/**"/>
            <include name="exercises/worldwide/Training Porto/**"/>
            <include name="exercises/worldwide/MLTraining/**"/>
            <include name="data/terrains/PortoV3Lite - worldwide/**"/>
            <include name="data/terrains/Nord egypt/**"/>
            <include name="data/terrains/Paris_Est/**"/>
        </pack>
    </target>
    
    <target name="package.otpack.decisional3" description="decisional package DIA3">
        <pack name="decisional3" description="decisional package DIA3">
            <include name="data/models/ada/decisional/Sources/**"/>
            <include name="data/models/ada/decisional/decisional.xml"/>
        </pack>
    </target>

    <target name="package.otpack.decisional4" description="decisional package DIA4">
        <pack name="decisional4" description="decisional package DIA4">
            <include name="data/models/ada/decisional/bms/**"/>
            <include name="data/models/ada/decisional/directia5/**"/>
            <exclude name="data/models/ada/decisional/directia5/models/src/france/**"/>
            <include name="data/models/ada/decisional/decisional.xml"/>
        </pack>
    </target>
    
    <target name="package.otpack.decisional5" description="decisional package DIA5">
        <pack name="decisional5" description="decisional package DIA5">
            <include name="data/models/ada/decisional/directia5/**"/>
            <include name="data/models/ada/decisional/decisional.xml"/>
        </pack>
    </target>

    <!--
    ============================================================================
    main
    ============================================================================
    -->
    <macrodef name="update-database">
        <attribute name="database"/>
        <attribute name="dir"/>
        <sequential>
            <delete dir="@{dir}"/>
            <update name="masalife/brain" version="${masalife.version}" package="@{database}" todir="@{dir}"/>
        </sequential>
    </macrodef>

    <target name="configure" description="initialize local project structure with libraries">
        <update name="geometry"/>
        <update name="geocoord"/>
        <update name="terrain" modules="terrain,graphics,spatialcontainer,pathfind,analysis,vmap,geodata,gdal_ogr,urban"/>
        <update name="terrain" package="terraintools_${platform}.zip"/>
        <update name="qt"/>
        <update name="boost"/>
        <update name="boost" package="geometry" todir="${include.dir}"/>
        <update name="masalife/brain" version="${masalife.version}"/>
        <update name="masalife/brain" version="${masalife.version}" package="bmc" todir="${bin.dir}"/>
        <update name="masalife/brain" version="${masalife.version}" package="net.masagroup.life.brain.ide-win32.win32.x86.zip" todir="${out.dir}"/>
        <update name="hla" package="include" todir="${include.dir}"/>
        <update name="hla" package="lib" todir="${lib.dir}"/>
        <update name="hla" package="dll" todir="${run.dir}/plugins/hla"/>
        <update name="hla" package="federation_app" todir="${bin.dir}"/>
        <update name="tools"/>
        <update name="log4cxx"/>
        <update name="flexlm"/>
        <update name="xerces-c"/>
        <update name="xeumeuleu"/>
        <update name="xalan-c"/>
        <update name="svgl"/>
        <update name="zlib"/>
        <update name="bugtrap"/>
        <update name="gdal"/>
        <update name="turtle"/>
        <update name="protobuf" version="2.3.0"/>
        <update name="vcredist" package="vcredist"/>
        <update name="openssl"/>
        <update name="mak" package="include" todir="${include.dir}"/>
        <update name="mak" package="lib" todir="${lib.dir}"/>
        <update name="mak" package="dll" todir="${run.dir}/plugins/vrforces"/>
        <update name="wise"/>
        <antcall target="deploy-application-data"/>
        <update-database database="directia.core.bml" dir="${models.dir}/directia.core"/>
        <antcall target="generate-database"/>
        <antcall target="generate-symbols"/>
    </target>

    <target name="clean" description="clean intermediate build artifacts">
        <delete dir="${out.dir}"/>
    </target>

    <target name="build" depends="libraries,applications"/>

    <target name="all" depends="configure,build,test,documentation,package" description="build and package distribution"/>

</project>
