<?xml version="1.0"?>
<project name="host_agent" default="all">

    <property environment="env"/>
    <property name="env.PONEY_HOME" value="//install/masa/common/dev/common/poney"/>
    <import file="${env.PONEY_HOME}/poney.xml"/>

    <macrodef name="forward_path">
        <attribute name="input"/>
        <attribute name="output"/>
        <sequential>
            <pathconvert property="@{output}" dirsep="/">
                <path location="@{input}"/>
            </pathconvert>
        </sequential>
    </macrodef>

    <forward_path input="${include.dir}" output="cmake.include"/>
    <forward_path input="${lib.dir}"     output="cmake.lib"/>

    <property name="cmake.platform.vc100"      value="Win32"/>
    <property name="cmake.platform.vc100_x64"  value="X64"/>
    <property name="cmake.generator.vc100"     value="Visual Studio 10"/>
    <property name="cmake.generator.vc100_x64" value="Visual Studio 10 Win64"/>

    <macrodef name="cmake_call">
        <attribute name="generator"/>
        <sequential>
            <exec taskname="cmake" executable="cmake" dir="${out.dir}" failonerror="true">
                <arg value="${root.dir}/build"/>
                <arg value="-G"/>
                <arg value="${@{generator}}"/>
                <arg value="-DMASA_INCLUDE=${cmake.include}"/>
                <arg value="-DMASA_LIB=${cmake.lib}"/>
            </exec>
        </sequential>
    </macrodef>

    <target name="configure" description="retrieve dependencies">
        <update name="bcrypt"/>
        <update name="boost"/>
        <update name="cpp-netlib"/>
        <update name="libarchive"/>
        <update name="openssl"/>
        <update name="sqlite"/>
        <update name="turtle"/>
        <update name="zlib" version="1.2.6"/>
        <mkdir dir="${out.dir}"/>
        <cmake_call generator="cmake.generator.${platform}"/>
    </target>

    <macrodef name="msbuild_call">
        <attribute name="configuration"/>
        <attribute name="platform"/>
        <attribute name="project"/>
        <sequential>
            <exec taskname="build" executable="msbuild" dir="${out.dir}" failonerror="true">
                <arg value="/nologo"/>
                <arg value="/m:2"/>
                <arg value="/verbosity:minimal"/>
                <arg value="@{project}.sln"/>
                <arg value="/p:Configuration=@{configuration}"/>
                <arg value="/p:Platform=${@{platform}}"/>
            </exec>
        </sequential>
    </macrodef>

    <target name="build">
        <msbuild_call configuration="Debug"
            project="host_agent" platform="cmake.platform.${platform}" />
        <msbuild_call configuration="RelWithDebInfo"
            project="host_agent" platform="cmake.platform.${platform}" />
    </target>

    <target name="tests">
        <poney-test name="runtime_test" dir="${out.dir}/RelWithDebInfo"
            data="${src.dir}/tests/runtime_test" />
        <poney-test name="host_test" dir="${out.dir}/RelWithDebInfo"
            data="${src.dir}/tests/host_test" />
        <poney-test name="web_test" dir="${out.dir}/RelWithDebInfo"
            data="${src.dir}/tests/web_test" />
    </target>

    <target name="reports" description="generate reports">
        <cppcheck-report>
            <arg line="--suppress=unusedFunction"/>
            <arg line="--suppress=useAutoPointerCopy"/>
            <arg line="--suppress=variableHidingTypedef"/>
        </cppcheck-report>
    </target>

    <target name="all" depends="configure,build,tests,reports"/>
</project>
