<?xml version="1.0"?>
<project name="host_agent" default="all">

    <property environment="env"/>
    <property name="env.PONEY_HOME" value="//install/masa/common/dev/common/poney"/>
    <import file="${env.PONEY_HOME}/poney.xml"/>

    <property name="applications.dir" value="../src/applications"/>

    <condition property="os.platform" value="windows" else="linux">
        <os family="windows"/>
    </condition>

    <condition property="win.defines" value="_CRT_SECURE_NO_WARNINGS,_SCL_SECURE_NO_WARNINGS,_WIN32_WINNT=0x0600,WINVER=0x0600">
        <os family="windows"/>
    </condition>    

    <!-- Libraries -->
    <target name="libraries" depends="runtime,host,web" description="build all libraries"/>

    <target name="runtime" description="build runtime library">
        <build-lib name="runtime">
            <defineset define="${win.defines}"/>
        </build-lib>
    </target>

    <target name="host" description="build host library">
        <build-lib name="host">
            <defineset define="${win.defines}"/>
        </build-lib>
    </target>

    <target name="web" description="build web library">
        <build-lib name="web">
            <defineset define="${win.defines}"/>
        </build-lib>
    </target>

    <!-- Applications -->
    <target name="applications" depends="cloud_server" description="build all applications"/>

    <target name="cloud_server" depends="runtime,host,web" description="build cloud server">
        <build-app name="cloud_server" subsystem="console" depends="boost,cpp-netlib,libarchive" root="${applications.dir}" libs="runtime@{suffix},host@{suffix},web@{suffix},zlib">
            <syslibset libs="advapi32,ws2_32"/>
            <defineset define="${win.defines}"/>
        </build-app>
    </target>

    <!-- Tests -->
    <target name="tests" depends="host_test,runtime_test,web_test" description="build tests"/>

    <target name="runtime_test" depends="runtime" description="build runtime tests">
        <build-test name="runtime" depends="boost" libs="runtime@{suffix}">
            <defineset define="${win.defines}"/>
        </build-test>
    </target>

    <target name="host_test" depends="host,runtime" description="build host tests">
        <build-test name="host" depends="boost" libs="host@{suffix},runtime@{suffix}">
            <defineset define="${win.defines}"/>
        </build-test>
    </target>

    <target name="web_test" depends="host,web" description="build web tests">
        <build-test name="web" depends="boost" libs="runtime@{suffix},web@{suffix}">
            <defineset define="${win.defines}"/>
        </build-test>
    </target>

    <!-- Reports -->
    <target name="reports" description="generate reports">
        <cppcheck-report>
            <arg line="--suppress=useAutoPointerCopy"/>
            <arg line="--suppress=unusedFunction"/>
            <arg line="--suppress=variableHidingTypedef"/>
        </cppcheck-report>
        <headers name="host"/>
        <headers name="runtime"/>
        <headers name="web"/>
    </target>

    <!-- Configure -->
    <target name="configure" description="retrieve dependencies">
        <update name="boost" version="1.48"/>
        <update name="cpp-netlib"/>
        <update name="libarchive"/>
        <update name="turtle"/>
        <update name="zlib" version="1.2.6"/>
    </target>

    <!-- Clean -->
    <target name="clean" description="clean intermediate build artifacts">
        <delete dir="${reports.dir}"/>
        <delete dir="${out.dir}"/>
    </target>

    <!-- All -->
    <target name="all" depends="configure,libraries,applications,tests,reports"/>
</project>
